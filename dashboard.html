<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ - á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™á‚áŸ’ášá¿á„á‘áŸáŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* UPDATED FONT: Importing Khmer OS Muol and Battambang for elegance and fallback */
        @import url('https://fonts.googleapis.com/css2?family=Khmer+OS+Muol:wght@400;600;700&family=Khmer+OS+Battambang:wght@400;600;700&display=swap');
        
        body {
            /* Set default font to Battambang (standard legibility) */
            font-family: 'Khmer OS Battambang', sans-serif;
            min-height: 100vh;
        }
        
        /* Apply the more elegant Muol font to headings/titles for a "beautiful" look */
        h1, h2, h3, .mobile-title, .font-extrabold {
            font-family: 'Khmer OS Muol', 'Khmer OS Battambang', sans-serif !important;
        }


        /* Simple hide scrollbar */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* General Modal Styling */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            justify-content: center;
            align-items: center;
            z-index: 999;
            backdrop-filter: blur(3px);
            transition: opacity 0.3s ease;
        }
        .modal.active { display:flex; }

        /* Custom status badges (Slightly improved colors) */
        .badge-expense { background-color: #fee2e2; color: #b91c1c; }
        .badge-income { background-color: #dcfce7; color: #15803d; }
        .badge-deleted { background-color: #f3f4f6; color: #6b7280; }

        /* Modern shadow for cards */
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }

        /* Dropdown */
        .dropdown { position: relative; }
        .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; min-width: 200px; background-color: white; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); z-index: 100; margin-top: 10px; }
        .dropdown-menu.active { display: block; }

        /* List Item Hover Effect */
        .expense-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            border: 1px solid #e5e7eb; /* Added subtle border */
        }
        .expense-item:hover {
            cursor: pointer;
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.1);
        }

        /* FAB for ADD (only on screens < 1024px) */
        #fab-add-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }
        /* FAB for EXPORT (only on screens < 1024px) */
        #fab-export-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 50;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }
        
        /* NEW: FAB for FILTER (only on screens < 1024px) */
        #fab-filter-btn {
            position: fixed;
            bottom: 90px; /* Positioned above the Add button */
            right: 20px;
            z-index: 50;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            transition: background-color 0.15s;
        }

        @media(max-width:1023px){ /* Tablet and Mobile */
            #fab-add-btn, #fab-export-btn, #fab-filter-btn{
                display: inline-flex !important;
            }
        }
        
        /* CRITICAL CHANGE: Hide FABs on Desktop */
        @media (min-width: 1024px) {
            #fab-add-btn, #fab-export-btn, #fab-filter-btn {
                display: none !important;
            }
        }

        /* Mobile Modal Fix (Ensures the modal form is 100% on small screens) */
        #mobileFormModal .modal-content-mobile {
            width: 95%; 
            max-width: 480px; 
            margin: 20px;
        }
        
        /* Export Modal Custom Style for Mobile */
        #mobileExportModal .modal-content-export {
            width: 95%; 
            max-width: 400px;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            align-self: flex-end; /* Pin to the bottom */
            margin-bottom: 20px;
        }
        #mobileExportModal.active .modal-content-export {
            transform: translateY(0);
        }

        /* NEW: Filter Modal Custom Style for Mobile (Fixed & Centered) */
        #filterModal .modal-content-filter {
            width: 95%;
            max-width: 450px;
            border-radius: 12px;
            padding: 24px;
            
            /* Apply fixed center transformation */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
            
            /* Override the standard modal display which centers flex items */
            margin: 0; 
        }
        /* Active state for animation */
        #filterModal.active .modal-content-filter {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        /* Form Visibility Logic */
        #dashboard-expense-form-container {
            display: none !important;
        }
        /* Report form is visible on desktop, hidden on mobile */
        #report-expense-form-container {
            display: none; /* Hide on mobile by default */
        }
        
        /* HIDE FILTER CONTROLS ON MOBILE (The controls are now moved into a modal) */
        @media (max-width: 1023px) {
            #report-controls {
                display: none !important; 
            }
        }

        /* Desktop Layout: Report Form is visible on Desktop by default */
        @media (min-width: 1024px) {
            #report-tab #report-expense-form-container {
                display: block; /* Show the form container on Desktop/Report tab */
            }
            #report-tab #data-view-section {
                grid-column: span 3 / span 3; /* List takes 3 columns */
            }
            /* Hide the mobile modal/toggle buttons on desktop */
            #mobileFormModal, #mobileExportModal, #filterModal {
                display: none !important;
            }
            #toggle-filter-btn {
                display: none !important;
            }
        }

        /* === MOBILE LIST ITEM STYLING (UX/UI IMPROVEMENT) === */
        @media (max-width: 640px) {
            .expense-item {
                padding: 12px; /* Smaller padding */
                align-items: flex-start;
            }
            .expense-item .flex-main-content {
                min-width: 60%;
                flex-grow: 1;
            }
            .expense-item .header-row {
                /* New: Distribute space for status badge (left) and date (right) */
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 4px;
            }
            .expense-item .mobile-title {
                /* NEW: Smaller title font size (approx 15px) */
                font-size: 0.9375rem; 
                font-weight: 700; /* font-bold */
                color: #1f2937; /* text-gray-800 */
                margin-top: 0;
            }

            /* --- CRITICAL UPDATE: SHOW DETAIL BREAKDOWN ON MOBILE --- */
            .expense-item .mobile-description-and-breakdown {
                display: block !important; /* Always show breakdown on mobile */
                margin-top: 6px;
                line-height: 1.4;
            }
            .expense-item .mobile-description-and-breakdown p {
                /* Description text style (Should be smaller for "á›áŸ’á˜á˜áŸáŸ’á¢á¶á") */
                font-size: 9px; /* Even smaller description */
                color: #4b5563; /* text-gray-600 */
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .expense-item .mobile-breakdown {
                display: flex;
                flex-wrap: wrap; 
                gap: 5px 12px; 
                margin-top: 4px;
                font-size: 9px; /* Even smaller breakdown text */
            }
            /* ---------------------------------------------------- */
            
            /* Target the total amount for smaller/neater look */
            .expense-item .mobile-amount {
                font-size: 1.125rem; /* text-xl, for smaller total amount */
                font-weight: 900; /* font-extrabold */
                margin-top: 0;
            }
            
            /* Action buttons are visible but moved slightly */
            .expense-item .item-actions {
                /* Use flex container to vertically center buttons against the main content area */
                display: flex;
                flex-direction: column;
                justify-content: center; /* Vertically centers the buttons */
                margin-left: 8px;
                gap: 2px; /* Closer buttons */
            }
           .expense-item .item-actions button {
                padding: 4px; /* Smaller touch target */
             }
        }
        /* === END MOBILE LIST ITEM STYLING === */


        /* Print Styles */
        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                background-color: #ffffff !important;
            }
            .card-shadow { box-shadow: none !important; border: 1px solid #ccc; }
            .hide-on-print { display: none !important; }
            .expense-item { page-break-inside: avoid; }

            /* Hide unnecessary elements for printing */
            header, #fab-add-btn, #fab-export-btn, .item-actions, #report-expense-form-container, #report-controls, #report-tabs, #add-report-btn, #toggle-filter-btn, #filterModal { display: none !important; }

            /* Force the report content to show up for printing */
            #report-tab { display: block !important; }
        }

        /* Custom Confirmation Modal Styling */
        .confirm-modal-content {
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* Profile Avatar Styling */
        #profile-avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div id="toast-container" class="fixed top-4 right-4 z-[1000] space-y-3 pointer-events-none">
    </div>

    <div id="customConfirmModal" class="modal">
        <div class="confirm-modal-content bg-white rounded-2xl p-8 w-full max-w-sm relative shadow-2xl">
            <div id="confirm-icon-box" class="w-12 h-12 rounded-full mx-auto mb-4 flex items-center justify-center text-white bg-red-100">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
            </div>
            <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-2 text-center">áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠá‘áŸ?</h3>
            <p id="confirm-message" class="text-gray-600 mb-6 text-center text-sm">á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá“áŸáŸ‡á˜á·á“á¢á¶á…ááŸ’ášá›á”áŸ‹á€áŸ’ášáŸ„á™á”á¶á“á‘áŸáŸ”</p>

            <div class="flex justify-center space-x-4">
                <button type="button" onclick="resolveCustomConfirm(false)" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”áŸ„áŸ‡á”á„áŸ‹</button>
                <button type="button" id="confirm-action-btn" onclick="resolveCustomConfirm(true)" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition">á™á›áŸ‹á–áŸ’ášá˜</button>
            </div>
        </div>
    </div>

    <header class="bg-white shadow-md p-4 sticky top-0 z-50 border-b border-gray-200">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl sm:text-3xl font-bold text-blue-700 flex items-center">
                <i data-lucide="wallet" class="w-6 h-6 sm:w-7 sm:h-7 mr-2 sm:mr-3 text-indigo-500"></i>
                á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™
            </h1>

            <div class="dropdown">
                <button onclick="toggleDropdown(event)" class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-semibold hover:bg-indigo-600 transition duration-150 relative ring-2 ring-indigo-300 ring-offset-2 overflow-hidden">
                    <img id="profile-avatar" src="" alt="User Avatar">
                </button>
                <div id="profile-dropdown-menu" class="dropdown-menu">
                    <div class="p-3 border-b text-center bg-gray-50">
                        <p class="font-bold text-gray-800 truncate" id="dropdown-email">Loading...</p>
                        <span class="text-sm text-indigo-500" id="dropdown-role">Loading...</span>
                    </div>

                    <a href="user.html" id="user-management-link" class="hidden items-center p-3 hover:bg-indigo-50 transition text-purple-700">
                        <i data-lucide="users" class="w-4 h-4 mr-2"></i> á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¢áŸ’á“á€á”áŸ’ášá¾
                    </a>

                    <a href="#" onclick="openProfileModal(); return false;" class="flex items-center p-3 hover:bg-gray-50 transition text-gray-700">
                        <i data-lucide="user-cog" class="w-4 h-4 mr-2"></i> á–áŸááŸ’áœá˜á¶á“á‚áá“á¸
                    </a>
                    <a href="#" onclick="customLogout(); return false;" class="flex items-center p-3 hover:bg-red-50 transition text-red-600 border-t mt-1">
                        <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> á…á¶á€á…áŸá‰
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8">

        <div id="report-tabs" class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-4">
                <button id="tab-dashboard-btn" onclick="setActiveTab('dashboard')" class="py-2 px-4 text-lg font-semibold text-indigo-600 border-b-2 border-indigo-600 transition duration-150 flex items-center">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-2"></i> á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„
                </button>
                <button id="tab-report-btn" onclick="setActiveTab('report')" class="py-2 px-4 text-lg font-medium text-gray-500 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700 transition duration-150 flex items-center">
                    <i data-lucide="file-text" class="w-5 h-5 mr-2"></i> ášá”á¶á™á€á¶ášááŸ / á”á‰áŸ’á‡á¸
                </button>
            </nav>
        </div>

        <div id="dashboard-tab" class="tab-content" style="display: block;">
            <section class="mb-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-red-500 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="receipt" class="w-4 h-4 mr-2 text-red-500"></i> á…áŸ†áá¶á™áŸášá»á”ášá½á˜</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-600 truncate" id="total-expense-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-red-400 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="calendar-check" class="w-4 h-4 mr-2 text-red-400"></i> á…áŸ†áá¶á™ááŸ’á„áŸƒá“áŸáŸ‡</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-500 truncate" id="today-expense-summary">0 áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-red-300 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="calendar" class="w-4 h-4 mr-2 text-red-300"></i> á…áŸ†áá¶á™á”áŸ’ášá…á¶áŸ†ááŸ‚</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-400 truncate" id="monthly-expense-summary">0 áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-gray-400 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="hash" class="w-4 h-4 mr-2 text-gray-500"></i> á…áŸ†á“á½á“á€áŸ†áááŸ‹ááŸ’ášá¶</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-gray-700" id="total-count-summary">-- á€áŸ†áááŸ‹ááŸ’ášá¶</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mt-4">
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-orange-500 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="utensils" class="w-4 h-4 mr-2 text-orange-500"></i> áŸá¶á…áŸ‹áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-orange-600 truncate" id="meat-total-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-green-500 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="leaf" class="w-4 h-4 mr-2 text-green-500"></i> á”á“áŸ’á›áŸ‚áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-green-600 truncate" id="vegetable-total-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-yellow-500 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="apple" class="w-4 h-4 mr-2 text-yellow-500"></i> á•áŸ’á›áŸ‚áˆá¾áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-yellow-600 truncate" id="fruit-total-summary">-- áŸ›</p>
                    </div>
                </div>
            </section>
        </div>

        <div id="report-tab" class="tab-content" style="display: none;">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

                <section id="report-expense-form-container" class="lg:col-span-1 bg-white p-6 rounded-2xl card-shadow h-fit lg:sticky lg:top-24 border border-gray-100">
                    <h2 class="text-2xl font-bold mb-6 text-indigo-600 border-b pb-3" id="report-form-title">â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸</h2>
                    <form id="report-form" class="space-y-4">
                    </form>
                </section>

                <section id="data-view-section" class="lg:col-span-3 transition-all duration-300">
                    
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-red-500 hover:shadow-lg transition mb-6">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="receipt" class="w-4 h-4 mr-2 text-red-500"></i> á…áŸ†áá¶á™áŸášá»á”á“áŸƒášá”á¶á™á€á¶ášááŸ</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-600 truncate" id="filtered-expense-summary">-- áŸ›</p>
                    </div>

                    <div class="bg-white p-4 sm:p-6 rounded-2xl card-shadow border border-gray-100">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-2">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-700 mb-2 sm:mb-0">á”á‰áŸ’á‡á¸á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá…áŸ†áá¶á™</h2>
                            <button onclick="switchView('trash')" id="trash-btn" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg transition flex items-center font-semibold text-sm shadow-sm">
                                <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> á€áŸ†áááŸ‹ááŸ’ášá¶áŠáŸ‚á›á”á¶á“á›á»á”
                            </button>
                        </div>
                        
                        <div id="report-controls" class="mb-6 p-4 border rounded-xl bg-gray-50">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label for="filter-day" class="block text-xs font-medium text-gray-500 mb-1">ááŸ’ášá„áá¶á˜ááŸ’á„áŸƒ:</label>
                                    <select id="filter-day" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()">
                                        <option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
                                        <option value="daily">á”áŸ’ášá…á¶áŸ†ááŸ’á„áŸƒ</option>
                                        <option value="day_mon">á…áŸá“áŸ’á‘</option>
                                        <option value="day_tue">á¢á„áŸ’á‚á¶áš</option>
                                        <option value="day_wed">á–á»á’</option>
                                        <option value="day_thu">á–áŸ’ášá áŸáŸ’á”áá·áŸ</option>
                                        <option value="day_fri">áŸá»á€áŸ’áš</option>
                                        <option value="day_sat">áŸáŸ…ášáŸ</option>
                                        <option value="day_sun">á¢á¶á‘á·ááŸ’á™</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filter-month" class="block text-xs font-medium text-gray-500 mb-1">ááŸ’ášá„áá¶á˜ááŸ‚:</label>
                                    <select id="filter-month" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()">
                                        <option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
                                        <option value="monthly">á”áŸ’ášá…á¶áŸ†ááŸ‚</option>
                                        <option value="month_0">á˜á€ášá¶</option>
                                        <option value="month_1">á€á»á˜áŸ’á—áŸˆ</option>
                                        <option value="month_2">á˜á¸á“á¶</option>
                                        <option value="month_3">á˜áŸáŸá¶</option>
                                        <option value="month_4">á§áŸá—á¶</option>
                                        <option value="month_5">á˜á·áá»á“á¶</option>
                                        <option value="month_6">á€á€áŸ’á€áŠá¶</option>
                                        <option value="month_7">áŸá¸á á¶</option>
                                        <option value="month_8">á€á‰áŸ’á‰á¶</option>
                                        <option value="month_9">áá»á›á¶</option>
                                        <option value="month_10">áœá·á…áŸ’á†á·á€á¶</option>
                                        <option value="month_11">á’áŸ’á“á¼</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filter-year" class="block text-xs font-medium text-gray-500 mb-1">ááŸ’ášá„áá¶á˜á†áŸ’á“á¶áŸ†:</label>
                                    <select id="filter-year" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()">
                                        <option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
                                        <option value="yearly">á”áŸ’ášá…á¶áŸ†á†áŸ’á“á¶áŸ†</option>
                                    </select>
                                </div>
                            </div>

                            <div class="flex flex-wrap justify-end gap-3 border-t pt-3 mt-3 hidden md:flex">
                                <button onclick="exportData('pdf')" class="bg-red-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-red-700 transition text-sm font-semibold shadow-md">
                                    <i data-lucide="file-text" class="w-4 h-4 mr-1"></i> á‘á¶á‰á™á€ PDF
                                </button>
                                <button onclick="exportData('excel')" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-green-700 transition text-sm font-semibold shadow-md">
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-1"></i> á‘á¶á‰á™á€ Excel
                                </button>
                            </div>
                        </div>

                        <div id="expense-list" class="space-y-3 max-h-[65vh] overflow-y-auto pr-2 hide-scrollbar">
                            <p class="text-center text-gray-500 py-10">á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <button id="fab-add-btn" onclick="openFormModal()" class="bg-indigo-600 text-white transition hover:bg-indigo-700 ring-4 ring-indigo-300 ring-offset-2">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>
    
    <button id="fab-export-btn" onclick="openExportModal()" class="bg-blue-600 text-white transition hover:bg-blue-700 ring-4 ring-blue-300 ring-offset-2">
        <i data-lucide="file-down" class="w-8 h-8"></i>
    </button>

    <button id="fab-filter-btn" onclick="openFilterModal()" class="bg-blue-600 text-white transition hover:bg-blue-700 ring-4 ring-blue-300 ring-offset-2">
        <i data-lucide="filter" class="w-8 h-8"></i>
    </button>


    <div id="profileModal" class="modal">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md relative shadow-2xl">
            <h3 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2">á–áŸááŸ’áœá˜á¶á“á‚áá“á¸</h3>

            <div class="space-y-4">
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <label class="block text-sm font-medium text-gray-500">á¢áŸŠá¸á˜áŸ‰áŸ‚á›</label>
                    <p class="font-semibold text-gray-800" id="modal-profile-email">N/A</p>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <label class="block text-sm font-medium text-gray-500">áá½á“á¶á‘á¸</label>
                    <p class="font-semibold text-indigo-700" id="modal-profile-role">N/A</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
                <button type="button" onclick="closeProfileModal()" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”á·á‘</button>
                <button type="button" onclick="customLogout()" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition">á…á¶á€á…áŸá‰</button>
            </div>

            <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="bg-white rounded-2xl p-8 w-full max-w-lg relative shadow-2xl transform transition-all">
            <h3 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2 flex items-center">
                <i data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-gray-50"></i> á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·áá€áŸ†áááŸ‹ááŸ’ášá¶
            </h3>

            <div class="space-y-4 text-gray-700">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-1"></i> á€á¶á›á”ášá·á…áŸ’á†áŸá‘</label>
                        <p class="font-semibold text-base" id="detail-date">N/A</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="tag" class="w-4 h-4 mr-1"></i> á”áŸ’ášá—áŸá‘á”áŸ’ášáá·á”ááŸ’áá·á€á¶áš</label>
                        <p class="font-semibold text-base text-red-600" id="detail-type">á…áŸ†áá¶á™ ğŸ“‰</p>
                    </div>
                </div>

                <div class="p-4 bg-red-50 rounded-xl border border-red-200 shadow-inner">
                    <label class="block text-sm font-medium text-red-700">á…áŸ†á“á½á“á”áŸ’ášá¶á€áŸ‹áŸášá»á” (Amount)</label>
                    <p class="text-3xl font-extrabold mt-1 text-red-600" id="detail-amount">-- áŸ›</p>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="p-3 bg-white rounded-lg border shadow-sm">
                        <label class="block text-xs font-medium text-gray-500">áŸá¶á…áŸ‹</label>
                        <p class="font-semibold text-base text-orange-600" id="detail-meat">0 áŸ›</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg border shadow-sm">
                        <label class="block text-xs font-medium text-gray-500">á”á“áŸ’á›áŸ‚</label>
                        <p class="font-semibold text-base text-green-600" id="detail-vegetable">0 áŸ›</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg border shadow-sm">
                        <label class="block text-xs font-medium text-gray-500">á•áŸ’á›áŸ‚áˆá¾</label>
                        <p class="font-semibold text-base text-yellow-600" id="detail-fruit">0 áŸ›</p>
                    </div>
                </div>

                <div class="p-3 bg-gray-50 rounded-lg border">
                    <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="align-left" class="w-4 h-4 mr-1"></i> á–á·á–ááŸŒá“á¶á›á˜áŸ’á¢á·á</label>
                    <p id="detail-desc" class="whitespace-pre-wrap text-sm">N/A</p>
                </div>

                <div class="text-xs text-gray-500 pt-3 flex justify-between">
                    <p>á€áŸ‚á”áŸ’ášáŸ‚á…á»á„á€áŸ’ášáŸ„á™: <span id="detail-modified">N/A</span></p>
                    <p>áŸáŸ’áá¶á“á—á¶á–: <span id="detail-status" class="font-semibold">N/A</span></p>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
                <button type="button" onclick="editDesktopForm(activeDetailRecord.ID);" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition flex items-center shadow-md">
                    <i data-lucide="pencil" class="w-5 h-5 mr-2"></i> á€áŸ‚á”áŸ’ášáŸ‚
                </button>
                <button type="button" onclick="closeDetailModal()" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”á·á‘</button>
            </div>

            <button onclick="closeDetailModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <div id="form-template" style="display: none;">
        <input type="hidden" id="record-id" value="">

        <label for="date" class="block text-sm font-medium text-gray-700">á€á¶á›á”ášá·á…áŸ’á†áŸá‘</label>
        <input id="date" type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-600 focus:border-indigo-600 transition" required>

        <div class="grid grid-cols-3 gap-3 border p-3 rounded-lg bg-gray-50">
            <div class="col-span-3">
                <label class="block text-base font-semibold text-gray-800 mb-2">á…áŸ†á“á½á“á”áŸ’ášá¶á€áŸ‹áŸášá»á” (Amount)</label>
                <input id="amount-summary" type="text" class="w-full p-3 text-2xl font-extrabold text-red-600 bg-white border border-red-300 rounded-lg" value="0 áŸ›" readonly>
                <input type="hidden" id="amount" value="0"> </div>

            <div>
                <label for="meat" class="block text-sm font-medium text-gray-700">áŸá¶á…áŸ‹ ($)</label>
                <input id="meat" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-600 focus:border-orange-600 transition expense-input" placeholder="0" min="0">
            </div>
            <div>
                <label for="vegetable" class="block text-sm font-medium text-gray-700">á”á“áŸ’á›áŸ‚ ($)</label>
                <input id="vegetable" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-600 focus:border-green-600 transition expense-input" placeholder="0" min="0">
            </div>
            <div>
                <label for="fruit" class="block text-sm font-medium text-gray-700">á•áŸ’á›áŸ‚áˆá¾ ($)</label>
                <input id="fruit" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-600 focus:border-yellow-600 transition expense-input" placeholder="0" min="0">
            </div>
            
            <div class="col-span-3 border-t pt-3 mt-3">
                <h4 class="text-sm font-semibold text-gray-800 mb-2 flex items-center">á…áŸ†áá¶á™á•áŸ’áŸáŸá„áŸ—</h4>
                
                <div id="custom-expense-inputs" class="space-y-3">
                      </div>
                
                <button type="button" onclick="addCustomExpenseField(activeFormElement)" id="add-custom-btn" class="w-full mt-3 bg-gray-100 text-gray-600 p-2 rounded-lg font-semibold hover:bg-gray-200 transition duration-150 flex items-center justify-center text-sm">
                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i> á”á“áŸ’ááŸ‚á˜á…áŸ†áá¶á™á•áŸ’áŸáŸá„
                </button>
            </div>
            </div>

        <input id="category" type="hidden" value="Grocery">
        <input id="type" type="hidden" value="Expense">

        <label for="desc" class="block text-sm font-medium text-gray-700">á–á·á–ááŸŒá“á¶á›á˜áŸ’á¢á·á (á…áŸ†áá¶á™áŸášá»á”)</label>
        <textarea id="desc" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-600 focus:border-indigo-600 transition" placeholder="á…áŸ†áá¶á™á›á¾á¢áŸ’áœá¸ááŸ’á›áŸ‡..."></textarea>

        <button type="submit" id="submit-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150 flex items-center justify-center shadow-lg mt-6">
            <i data-lucide="plus" class="w-5 h-5 mr-1"></i> á”á“áŸ’ááŸ‚á˜á€áŸ†áááŸ‹ááŸ’ášá¶
        </button>

        <button type="button" id="cancel-btn" onclick="resetForm(activeFormElement)" class="w-full bg-gray-300 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-400 transition duration-150 hidden mt-2">
            <i data-lucide="x" class="w-5 h-5 mr-1"></i> á”áŸ„áŸ‡á”á„áŸ‹á€á¶ášá€áŸ‚á”áŸ’ášáŸ‚
        </button>
    </div>

    <div id="mobileFormModal" class="modal">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md relative shadow-2xl modal-content-mobile max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b pb-2">
                <h3 class="text-xl font-bold text-indigo-700" id="mobile-form-title">â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸</h3>
                <button type="button" onclick="closeFormModal()" class="text-gray-400 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="mobile-expense-form" class="space-y-4"></form>
        </div>
    </div>

    <div id="mobileExportModal" class="modal items-end sm:items-center">
        <div class="bg-white rounded-t-2xl sm:rounded-2xl p-6 w-full max-w-sm relative shadow-2xl modal-content-export">
            <h3 class="text-xl font-bold text-blue-700 mb-4">á‡áŸ’ášá¾áŸášá¾áŸá‘á˜áŸ’ášá„áŸ‹á¯á€áŸá¶áš</h3>
            <div class="space-y-3">
                <button onclick="exportData('pdf'); closeExportModal()" class="w-full flex items-center justify-center p-4 bg-red-50 text-red-700 rounded-xl hover:bg-red-100 transition border border-red-200 font-semibold">
                    <i data-lucide="file-text" class="w-6 h-6 mr-3"></i> á‘á¶á‰á™á€á‡á¶ PDF
                </button>
                <button onclick="exportData('excel'); closeExportModal()" class="w-full flex items-center justify-center p-4 bg-green-50 text-green-700 rounded-xl hover:bg-green-100 transition border border-green-200 font-semibold">
                    <i data-lucide="file-spreadsheet" class="w-6 h-6 mr-3"></i> á‘á¶á‰á™á€á‡á¶ Excel
                </button>
            </div>
            <button onclick="closeExportModal()" class="w-full mt-4 p-3 text-gray-500 font-medium hover:bg-gray-100 rounded-xl transition">
                á”á·á‘
            </button>
        </div>
    </div>

    <div id="filterModal" class="modal">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md relative shadow-2xl modal-content-filter">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <i data-lucide="filter" class="w-5 h-5 mr-2 text-blue-600"></i> ááŸ’ášá„á‘á·á“áŸ’á“á“áŸá™
                </h3>
                <button onclick="closeFilterModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="modal-filter-day" class="block text-sm font-medium text-gray-700 mb-1">ááŸ’ášá„áá¶á˜ááŸ’á„áŸƒ</label>
                    <select id="modal-filter-day" class="w-full p-3 border border-gray-300 rounded-xl bg-gray-50 focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
                        <option value="daily">á”áŸ’ášá…á¶áŸ†ááŸ’á„áŸƒ (ááŸ’á„áŸƒá“áŸáŸ‡)</option>
                        <option value="day_mon">á…áŸá“áŸ’á‘</option>
                        <option value="day_tue">á¢á„áŸ’á‚á¶áš</option>
                        <option value="day_wed">á–á»á’</option>
                        <option value="day_thu">á–áŸ’ášá áŸáŸ’á”áá·áŸ</option>
                        <option value="day_fri">áŸá»á€áŸ’áš</option>
                        <option value="day_sat">áŸáŸ…ášáŸ</option>
                        <option value="day_sun">á¢á¶á‘á·ááŸ’á™</option>
                    </select>
                </div>
                <div>
                    <label for="modal-filter-month" class="block text-sm font-medium text-gray-700 mb-1">ááŸ’ášá„áá¶á˜ááŸ‚</label>
                    <select id="modal-filter-month" class="w-full p-3 border border-gray-300 rounded-xl bg-gray-50 focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
                        <option value="monthly">á”áŸ’ášá…á¶áŸ†ááŸ‚ (ááŸ‚á“áŸáŸ‡)</option>
                        <option value="month_0">á˜á€ášá¶</option>
                        <option value="month_1">á€á»á˜áŸ’á—áŸˆ</option>
                        <option value="month_2">á˜á¸á“á¶</option>
                        <option value="month_3">á˜áŸáŸá¶</option>
                        <option value="month_4">á§áŸá—á¶</option>
                        <option value="month_5">á˜á·áá»á“á¶</option>
                        <option value="month_6">á€á€áŸ’á€áŠá¶</option>
                        <option value="month_7">áŸá¸á á¶</option>
                        <option value="month_8">á€á‰áŸ’á‰á¶</option>
                        <option value="month_9">áá»á›á¶</option>
                        <option value="month_10">áœá·á…áŸ’á†á·á€á¶</option>
                        <option value="month_11">á’áŸ’á“á¼</option>
                    </select>
                </div>
                <div>
                    <label for="modal-filter-year" class="block text-sm font-medium text-gray-700 mb-1">ááŸ’ášá„áá¶á˜á†áŸ’á“á¶áŸ†</label>
                    <select id="modal-filter-year" class="w-full p-3 border border-gray-300 rounded-xl bg-gray-50 focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
                        <option value="yearly">á”áŸ’ášá…á¶áŸ†á†áŸ’á“á¶áŸ† (á†áŸ’á“á¶áŸ†á“áŸáŸ‡)</option>
                    </select>
                </div>
            </div>

            <div class="mt-8 pt-4 border-t flex justify-end space-x-3">
                <button onclick="closeFilterModal()" class="px-5 py-2.5 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition">
                    á”áŸ„áŸ‡á”á„áŸ‹
                </button>
                <button onclick="applyModalFilters()" class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                    á¢á“á»áœááŸ’á
                </button>
            </div>
        </div>
    </div>


    <script src="config.js"></script>
    <script>
        // --- GLOBAL STATE ---
        const user = JSON.parse(localStorage.getItem("user"));
        let allExpenses = [];
        let currentView = 'active';
        let activeTab = 'dashboard';
        let editingID = null;
        let activeDetailRecord = null;
        let customConfirmResolver;
        let activeFormElement = null;
        
        // Configuration for dynamic custom fields
        const MAX_CUSTOM_FIELDS = 4; // Max number of custom expense inputs
        const CUSTOM_FIELD_PREFIX = 'Custom'; // Maps to SheetDB columns Custom1_Label, Custom1_Amount, etc.

        const dayNames = ["á¢á¶á‘á·ááŸ’á™", "á…áŸá“áŸ’á‘", "á¢á„áŸ’á‚á¶áš", "á–á»á’", "á–áŸ’ášá áŸáŸ’á”áá·áŸ", "áŸá»á€áŸ’áš", "áŸáŸ…ášáŸ"];
        
        // --- CONFIG ---
        // UPDATED: Using 'faces/' as the base directory for images
        const BASE_IMAGE_URL = "faces/"; 
        const DEFAULT_AVATAR_URL = "https://ui-avatars.com/api/?name=User&background=6366f1&color=fff";
        const PROFILE_ICON_URL = "data:image/svg+xml;base64," + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>');

        // --- UTILS (MUST BE DEFINED EARLY) ---

        /**
         * Converts number to Khmer currency format (e.g., 1,000,000 áŸ›).
         */
        function formatCurrency(amount) {
            const num = parseFloat(amount) || 0;
            return `${num.toLocaleString('km-KH', { maximumFractionDigits: 0 })} áŸ›`;
        }

        /**
         * Checks if two date strings are the same day (ignoring time).
         */
        function isSameDay(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        }

        // --- NEW: Export Modal Functions ---
        function openExportModal() {
            document.getElementById('mobileExportModal').classList.add('active');
        }
        function closeExportModal() {
            document.getElementById('mobileExportModal').classList.remove('active');
        }

        // --- NEW: Filter Modal Functions (for FAB) ---
        function openFilterModal() {
             // Sync desktop filter states to the modal filters before opening
            document.getElementById('modal-filter-day').value = document.getElementById('filter-day').value;
            document.getElementById('modal-filter-month').value = document.getElementById('filter-month').value;
            document.getElementById('modal-filter-year').value = document.getElementById('filter-year').value;

            document.getElementById('filterModal').classList.add('active');
            lucide.createIcons();
        }
        function closeFilterModal() {
            document.getElementById('filterModal').classList.remove('active');
        }

        function applyModalFilters() {
            // Apply modal filter states back to the original filter elements
            document.getElementById('filter-day').value = document.getElementById('modal-filter-day').value;
            document.getElementById('filter-month').value = document.getElementById('modal-filter-month').value;
            document.getElementById('filter-year').value = document.getElementById('modal-filter-year').value;

            closeFilterModal();
            filterRecords();
        }

        // --- NEW: TAB SWITCHING FUNCTION (UNCHANGED) ---
        function setActiveTab(tabName) {
            activeTab = tabName;

            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            document.querySelectorAll('#report-tabs button').forEach(btn => {
                btn.classList.remove('text-indigo-600', 'border-indigo-600');
                btn.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
            });

            const activeBtn = document.getElementById(`tab-${tabName}-btn`);
            activeBtn.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
            activeBtn.classList.add('text-indigo-600', 'border-indigo-600');

            // Handle FAB visibility 
            const fabBtnAdd = document.getElementById('fab-add-btn');
            const fabBtnExport = document.getElementById('fab-export-btn');
            const fabBtnFilter = document.getElementById('fab-filter-btn');
            const isDesktop = window.innerWidth >= 1024;
            
            if (isDesktop) {
                fabBtnAdd.style.display = 'none';
                fabBtnExport.style.display = 'none';
                fabBtnFilter.style.display = 'none';
            } else if (tabName === 'report') {
                fabBtnAdd.style.display = 'inline-flex';
                fabBtnExport.style.display = 'inline-flex';
                fabBtnFilter.style.display = 'inline-flex';
            } else {
                fabBtnAdd.style.display = 'inline-flex';
                fabBtnExport.style.display = 'none';
                fabBtnFilter.style.display = 'none';
            }

            // Ensure forms are reset and data loaded when switching to Report tab
            if (tabName === 'report') {
                const reportForm = document.getElementById('report-form');
                if (reportForm) {
                    resetForm(reportForm);
                    if (isDesktop) activeFormElement = reportForm; 
                }
                
                // Reset all filters to default 'all'
                if(document.getElementById('filter-day')) document.getElementById('filter-day').value = 'all';
                if(document.getElementById('filter-month')) document.getElementById('filter-month').value = 'all';
                if(document.getElementById('filter-year')) document.getElementById('filter-year').value = 'all';
                
                filterRecords();
            } else {
                if (document.getElementById('mobile-expense-form')) resetForm(document.getElementById('mobile-expense-form'));
            }

            lucide.createIcons();
        }

        // --- TOAST NOTIFICATION FUNCTION (UNCHANGED) ---
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            let bgColor, icon, iconColor;
            switch (type) {
                case 'success': bgColor = 'bg-green-600'; icon = 'check-circle'; iconColor = 'text-green-200'; break;
                case 'error': bgColor = 'bg-red-600'; icon = 'x-circle'; iconColor = 'text-red-200'; break;
                case 'warning': bgColor = 'bg-yellow-500'; icon = 'alert-triangle'; iconColor = 'text-yellow-200'; break;
                case 'info': default: bgColor = 'bg-blue-600'; icon = 'info'; iconColor = 'text-blue-200'; break;
            }
            const toast = document.createElement('div');
            toast.className = `p-4 max-w-sm w-full rounded-lg shadow-xl text-white flex items-center space-x-3 transform transition-all ease-in-out duration-300 opacity-0 translate-x-full pointer-events-auto ${bgColor}`;
            toast.style.minWidth = '250px';
            toast.innerHTML = `
                <i data-lucide="${icon}" class="w-6 h-6 ${iconColor} flex-shrink-0"></i>
                <p class="font-medium text-sm flex-1">${message}</p>
                <button onclick="this.closest('div').remove()" class="p-1 -mr-1 rounded-full hover:bg-white/20 transition-all flex-shrink-0">
                    <i data-lucide="x" class="w-4 h-4 text-white"></i>
                </button>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-x-full');
                toast.classList.add('opacity-100', 'translate-x-0');
            }, 50);
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-x-0');
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // --- CUSTOM CONFIRMATION MODAL FUNCTION (UNCHANGED) ---
        function customConfirm(title, message, actionText, type = 'delete') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const actionBtn = document.getElementById('confirm-action-btn');
                const iconBox = document.getElementById('confirm-icon-box');
                actionBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700', 'bg-red-800', 'hover:bg-red-900', 'bg-indigo-600', 'hover:bg-indigo-700', 'bg-blue-600', 'hover:bg-blue-700');
                iconBox.className = 'w-12 h-12 rounded-full mx-auto mb-4 flex items-center justify-center';

                let iconHtml = '';
                if (type === 'delete') { actionBtn.classList.add('bg-red-600', 'hover:bg-red-700'); iconBox.classList.add('bg-red-100'); iconHtml = '<i data-lucide="trash-2" class="w-6 h-6 text-red-600"></i>';
                } else if (type === 'permanent_delete') { actionBtn.classList.add('bg-red-800', 'hover:bg-red-900'); iconBox.classList.add('bg-red-200'); iconHtml = '<i data-lucide="skull" class="w-6 h-6 text-red-800"></i>';
                } else if (type === 'restore') { actionBtn.classList.add('bg-green-600', 'hover:bg-green-700'); iconBox.classList.add('bg-green-100'); iconHtml = '<i data-lucide="rotate-ccw" class="w-6 h-6 text-green-600"></i>';
                } else if (type === 'logout') { actionBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700'); iconBox.classList.add('bg-indigo-100'); iconHtml = '<i data-lucide="log-out" class="w-6 h-6 text-indigo-600"></i>';
                } else { actionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); iconBox.classList.add('bg-blue-100'); iconHtml = '<i data-lucide="help-circle" class="w-6 h-6 text-blue-600"></i>';
                }

                titleEl.textContent = title;
                messageEl.textContent = message;
                actionBtn.textContent = actionText;
                iconBox.innerHTML = iconHtml;
                lucide.createIcons();
                customConfirmResolver = resolve;
                modal.classList.add('active');
            });
        }

        function resolveCustomConfirm(result) {
            document.getElementById('customConfirmModal').classList.remove('active');
            if (customConfirmResolver) {
                customConfirmResolver(result);
                customConfirmResolver = null;
            }
        }

        async function customLogout() {
            const confirmed = await customConfirm(
                "á…á¶á€á…áŸá‰á–á¸á‚áá“á¸",
                "áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á…á¶á€á…áŸá‰á–á¸á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™á˜áŸ‚á“á‘áŸ?",
                "á…á¶á€á…áŸá‰",
                "logout"
            );

            if (confirmed) {
                localStorage.removeItem("user");
                localStorage.clear();
                window.location.href = "index.html";
            }
        }
        function logout() { customLogout(); }

        // --- INIT & AUTH (UPDATED for Avatar) ---
        if (!user) {
            showToast("âš ï¸ áŸá¼á˜á…á¼á›á”áŸ’ášá–áŸá“áŸ’á’á‡á¶á˜á»á“áŸá·á“áŸ”", 'warning');
            window.location.href = "index.html";
        } else {
            document.getElementById("dropdown-email").textContent = user.Email || 'N/A';
            document.getElementById("dropdown-role").textContent = user.Role || 'User';
            
            // NEW: Set the profile avatar
            updateProfileAvatar();

            if (user.Role === 'Owner') {
                document.getElementById('user-management-link').classList.remove('hidden');
                document.getElementById('user-management-link').classList.add('flex');
            }
        }
        
        // NEW: Avatar Logic
        function updateProfileAvatar() {
            const avatarImg = document.getElementById('profile-avatar');
            let avatarSource = PROFILE_ICON_URL;
            
            if (user && user.FaceImageFile && user.FaceImageFile !== 'N/A' && user.FaceImageFile.toLowerCase().endsWith('.jpg')) {
                // Use relative path for local images
                avatarSource = BASE_IMAGE_URL + user.FaceImageFile;
            } else if (user && user.Email) {
                // Fallback to UI Avatars based on email name
                const userName = user.Email.split('@')[0].toUpperCase();
                avatarSource = DEFAULT_AVATAR_URL.replace('User', userName);
            } else {
                avatarSource = PROFILE_ICON_URL;
            }
            
            if (avatarImg) {
                avatarImg.src = avatarSource;
                // Use white background if profile icon is loaded, otherwise transparent (for API images)
                if (avatarSource === PROFILE_ICON_URL) {
                    avatarImg.style.backgroundColor = '#6366f1'; 
                } else {
                    avatarImg.style.backgroundColor = 'transparent'; 
                }
                
                // Add a simple error handler in case the dynamic image fails to load
                avatarImg.onerror = () => {
                    avatarImg.src = PROFILE_ICON_URL;  
                    avatarImg.style.backgroundColor = '#6366f1';
                };
            }
        }


        // --- PROFILE/DROPDOWN/MODALS (UNCHANGED) ---
        function toggleDropdown(event) {
            const menu = document.getElementById('profile-dropdown-menu');
            document.querySelectorAll('.dropdown-menu.active').forEach(m => {
                if (m !== menu) m.classList.remove('active');
            });
            menu.classList.toggle('active');
            event.stopPropagation();
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profile-dropdown-menu');
            if (dropdown.classList.contains('active') && !event.target.closest('.dropdown')) {
                dropdown.classList.remove('active');
            }
        });

        function closeDropdown() { document.getElementById('profile-dropdown-menu').classList.remove('active'); }
        function openProfileModal() {
            closeDropdown();
            document.getElementById('modal-profile-email').textContent = user.Email;
            document.getElementById('modal-profile-role').textContent = user.Role;
            document.getElementById('profileModal').classList.add('active');
        }
        function closeProfileModal() { document.getElementById('profileModal').classList.remove('active'); }

        // --- DETAIL MODAL (UNCHANGED logic) ---
        function openDetailModal(record) {
            // FIX: Close edit/add form before opening detail modal
            if (window.innerWidth >= 1024 && editingID) {
                resetForm(document.getElementById('report-form'));
            } else if (window.innerWidth < 1024) {
                 closeFormModal();
            }

            activeDetailRecord = record;

            document.getElementById('detail-date').textContent = record.Date;
            document.getElementById('detail-amount').textContent = formatCurrency(parseFloat(record.Amount));
            document.getElementById('detail-amount').className = 'text-3xl font-extrabold mt-1 text-red-600';

            // NEW: Populate Breakdown
            document.getElementById('detail-meat').textContent = formatCurrency(parseFloat(record.Meat));
            document.getElementById('detail-vegetable').textContent = formatCurrency(parseFloat(record.Vegetable));
            document.getElementById('detail-fruit').textContent = formatCurrency(parseFloat(record.Fruit));

            // Use Description
            document.getElementById('detail-desc').textContent = record.Description || 'á‚áŸ’á˜á¶á“á–á·á–ááŸŒá“á¶';

            document.getElementById('detail-modified').textContent = record.ModifiedDate ? new Date(record.ModifiedDate).toLocaleString('km-KH') : 'N/A';
            document.getElementById('detail-status').textContent = record.Status === 'Deleted' ? 'á›á»á”á”ááŸ’áŠáŸ„áŸ‡á¢á¶áŸá“áŸ’á“' : 'áŸá€á˜áŸ’á˜';

            document.getElementById('detailModal').classList.add('active');
            lucide.createIcons();
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
            activeDetailRecord = null;
        }

        // --- FORM LOGIC (MODIFIED to handle two forms) ---

        function updateAmountSummary(formElement) {
            const meat = parseFloat(formElement.querySelector("#meat").value) || 0;
            const vegetable = parseFloat(formElement.querySelector("#vegetable").value) || 0;
            const fruit = parseFloat(formElement.querySelector("#fruit").value) || 0;

            // NEW: Sum all dynamically added custom amounts
            let customTotal = 0;
            formElement.querySelectorAll('.custom-input-amount').forEach(input => {
                customTotal += parseFloat(input.value) || 0;
            });

            const total = meat + vegetable + fruit + customTotal; // UPDATED TOTAL CALCULATION

            // Update the display field
            formElement.querySelector("#amount-summary").value = formatCurrency(total);

            // Update the hidden field used for data submission (We use the hidden field with ID 'amount' for submission)
            formElement.querySelector("#amount").value = total;

            // Apply visual cue if total is zero
            const summaryInput = formElement.querySelector("#amount-summary");
            if (total === 0) {
                summaryInput.classList.remove('text-red-600');
                summaryInput.classList.add('text-gray-500');
            } else {
                summaryInput.classList.remove('text-gray-500');
                summaryInput.classList.add('text-red-600');
            }
        }
        
        /**
         * Generates the HTML string for a single Custom Expense input row.
         */
        function createCustomExpenseFieldHTML(index, label = '', amount = 0, formId) {
            const inputId = `custom-amount-${index}-${formId}`;
            const labelId = `custom-label-${index}-${formId}`;
            
            return `
                <div id="custom-row-${index}-${formId}" class="custom-expense-row grid grid-cols-5 gap-2 border-b border-gray-200 pb-2 relative">
                    <div class="col-span-3">
                         <label for="${labelId}" class="block text-xs font-medium text-gray-500">á”áŸ’ášá—á– #${index}</label>
                         <input id="${labelId}" type="text" class="w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="á§. ááŸ’á›áŸƒáŸá¶á›á¶" value="${label}" maxlength="50" data-index="${index}" data-type="label">
                    </div>
                    <div class="col-span-2 relative">
                         <label for="${inputId}" class="block text-xs font-medium text-gray-500">áá˜áŸ’á›áŸƒ (áŸ›)</label>
                         <input id="${inputId}" type="number" class="w-full p-2 border border-gray-300 rounded-lg text-sm expense-input custom-input-amount" placeholder="0" value="${amount}" min="0" data-index="${index}" data-type="amount">
                    </div>
                    <button type="button" onclick="removeCustomExpenseField(this, '${formId}')" class="absolute top-0 right-0 p-1 text-red-500 hover:text-red-700 transition">
                         <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        }

        /**
         * Adds a new custom expense row to the specified form.
         */
        function addCustomExpenseField(element, data = {label: '', amount: 0}) {
            const formElement = element ? element.closest('form') : document.getElementById('report-form');
            if (!formElement) return;

            const container = formElement.querySelector('#custom-expense-inputs');
            if (!container) return;

            const formId = formElement.id;
            const existingRows = container.querySelectorAll('.custom-expense-row').length;

            if (existingRows >= MAX_CUSTOM_FIELDS) {
                // Hide the add button if max reached
                formElement.querySelector('#add-custom-btn').style.display = 'none';
                return;
            }

            const newIndex = existingRows + 1;
            const html = createCustomExpenseFieldHTML(newIndex, data.label, data.amount, formId);
            container.insertAdjacentHTML('beforeend', html);
            lucide.createIcons();
            
            // Re-check button visibility
            if (newIndex >= MAX_CUSTOM_FIELDS) {
                formElement.querySelector('#add-custom-btn').style.display = 'none';
            }
        }

        /**
         * Removes a custom expense row and re-updates the total.
         */
        function removeCustomExpenseField(button, formId) {
            const row = button.closest('.custom-expense-row');
            if (row) {
                row.remove();
                
                const formElement = document.getElementById(formId);
                const container = formElement.querySelector('#custom-expense-inputs');
                
                // Re-index remaining fields (Important for SheetDB mapping)
                container.querySelectorAll('.custom-expense-row').forEach((row, i) => {
                    const index = i + 1;
                    const amountInput = row.querySelector('.custom-input-amount');
                    const labelInput = row.querySelector('input[data-type="label"]');
                    
                    if (amountInput) {
                        amountInput.id = `custom-amount-${index}-${formId}`;
                        amountInput.dataset.index = index;
                    }
                    if (labelInput) {
                        labelInput.id = `custom-label-${index}-${formId}`;
                        labelInput.dataset.index = index;
                    }
                    row.id = `custom-row-${index}-${formId}`;
                    row.querySelector('.block.text-xs.font-medium.text-gray-500').textContent = `á”áŸ’ášá—á– #${index}`;
                });
                
                updateAmountSummary(formElement);
                // Ensure add button is visible again if capacity allows
                formElement.querySelector('#add-custom-btn').style.display = 'flex';
                lucide.createIcons();
            }
        }


        // Global setup for custom fields and delegated events
        function initCustomFields(formElement) {
            const container = formElement.querySelector('#custom-expense-inputs');
            if (container) {
                // Clear any existing content
                container.innerHTML = '';
                
                // Add initial listeners (delegated)
                formElement.addEventListener('input', (e) => {
                    if (e.target.classList.contains('expense-input')) {
                        updateAmountSummary(formElement);
                    }
                });
            }
            // Add one initial empty custom field when initializing (if not editing)
            if (!editingID) {
               addCustomExpenseField(formElement);
            }
        }

        function setupForms() {
            const formTemplate = document.getElementById('form-template').innerHTML;

            // Setup Report Form (Desktop Only)
            const reportForm = document.getElementById('report-form');
            if (reportForm) {
                reportForm.innerHTML = formTemplate;
                reportForm.addEventListener('submit', (e) => handleFormSubmission(e, 'report-desktop'));
                initCustomFields(reportForm);
            }
            
            // Setup Mobile Form (Used for FAB/Mobile Modal)
            const mobileForm = document.getElementById('mobile-expense-form');
            if (mobileForm) {
                mobileForm.innerHTML = formTemplate;
                mobileForm.addEventListener('submit', (e) => handleFormSubmission(e, 'mobile'));
                initCustomFields(mobileForm);
            }
        }

        function openFormModal() {
            activeFormElement = document.getElementById('mobile-expense-form');
            resetForm(activeFormElement);
            document.getElementById('mobile-form-title').textContent = "â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸";
            document.getElementById('mobileFormModal').classList.add('active');
            lucide.createIcons();
        }

        function closeFormModal() {
            resetForm(document.getElementById('mobile-expense-form'));
            document.getElementById('mobileFormModal').classList.remove('active');
            activeFormElement = null;
        }

        function populateForm(formElement, record) {
            // Re-initialize custom fields container
            const container = formElement.querySelector('#custom-expense-inputs');
            container.innerHTML = ''; // Clear previous fields
            
            // Populate fixed fields
            formElement.querySelector("#date").value = record.Date;
            formElement.querySelector("#meat").value = parseFloat(record.Meat) || 0;
            formElement.querySelector("#vegetable").value = parseFloat(record.Vegetable) || 0;
            formElement.querySelector("#fruit").value = parseFloat(record.Fruit) || 0;
            formElement.querySelector("#desc").value = record.Description;
            
            // Populate Dynamic/Custom fields from record
            let customFieldsFound = 0;
            for(let i = 1; i <= MAX_CUSTOM_FIELDS; i++) {
                const labelKey = `${CUSTOM_FIELD_PREFIX}${i}_Label`;
                const amountKey = `${CUSTOM_FIELD_PREFIX}${i}_Amount`;
                
                const label = record[labelKey] || '';
                const amount = parseFloat(record[amountKey]) || 0;

                // Only add fields if they have data (label or amount > 0)
                if (label || amount > 0) {
                    addCustomExpenseField(formElement, { label: label, amount: amount });
                    customFieldsFound++;
                }
            }

            // If no custom fields were found, ensure at least one empty field exists
            if (customFieldsFound === 0) {
                addCustomExpenseField(formElement);
            }
            
            // Show/Hide Add button based on total fields added
            const addBtn = formElement.querySelector('#add-custom-btn');
            if (addBtn) {
                const currentRows = container.querySelectorAll('.custom-expense-row').length;
                 addBtn.style.display = currentRows < MAX_CUSTOM_FIELDS ? 'flex' : 'none';
            }


            updateAmountSummary(formElement);

            const isEditing = record !== null;
            const submitBtn = formElement.querySelector('#submit-btn');
            const cancelBtn = formElement.querySelector('#cancel-btn');
            
            const reportTitle = document.getElementById('report-form-title');
            const mobileTitle = document.getElementById('mobile-form-title');


            if (isEditing) {
                submitBtn.innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-1"></i> ášá€áŸ’áŸá¶á‘á»á€á€á¶ášá€áŸ‚á”áŸ’ášáŸ‚';
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                cancelBtn.classList.remove('hidden');

                if (reportTitle) reportTitle.textContent = "ğŸ“ á€áŸ‚á”áŸ’ášáŸ‚á€áŸ†áááŸ‹ááŸ’ášá¶";
                if (mobileTitle) mobileTitle.textContent = "ğŸ“ á€áŸ‚á”áŸ’ášáŸ‚á€áŸ†áááŸ‹ááŸ’ášá¶";
                
            } else {
                resetFormUI(formElement);
            }
            lucide.createIcons();
        }

        function resetFormUI(formElement) {
            const submitBtn = formElement.querySelector('#submit-btn');
            const cancelBtn = formElement.querySelector('#cancel-btn');

            submitBtn.innerHTML = '<i data-lucide="plus" class="w-5 h-5 mr-1"></i> á”á“áŸ’ááŸ‚á˜á€áŸ†áááŸ‹ááŸ’ášá¶';
            submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            cancelBtn.classList.add('hidden');

            const reportTitle = document.getElementById('report-form-title');
            const mobileTitle = document.getElementById('mobile-form-title');

            if (reportTitle) reportTitle.textContent = "â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸";
            if (mobileTitle) mobileTitle.textContent = "â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸";

            updateAmountSummary(formElement);
            
            // Ensure fields are reset correctly for dynamic inputs
            const container = formElement.querySelector('#custom-expense-inputs');
            if (container) {
                 container.innerHTML = ''; 
                 const addBtn = formElement.querySelector('#add-custom-btn');
                 if (addBtn) addBtn.style.display = 'flex'; // Ensure add button is visible
                 addCustomExpenseField(formElement); // Add one empty field
            }
        }

        function resetForm(formToReset = null) {
            editingID = null;
            
            if (formToReset) {
                formToReset.reset();
                resetFormUI(formToReset);
            } else {
                const reportForm = document.getElementById('report-form');
                const mobileForm = document.getElementById('mobile-expense-form');
                
                if(reportForm) { reportForm.reset(); resetFormUI(reportForm); }
                if(mobileForm) { mobileForm.reset(); resetFormUI(mobileForm); }
            }
            
            activeFormElement = formToReset; 
            lucide.createIcons();
        }

        /**
         * CRITICAL CHANGE: Handles click on expense item.
         * On ANY screen, opens the Detail Modal.
         */
        function handleCardClick(record) {
            // FIX: Ensure detail modal opens on click regardless of device type,
            // but first, close any open forms to prevent conflicts.
            closeFormModal();
            if (window.innerWidth >= 1024 && editingID) {
                resetForm(document.getElementById('report-form')); // Reset desktop form if editing
            }
            openDetailModal(record);
        }
        
        // Function specifically for Desktop Edit Button (in detail modal)
        function editDesktopForm(id) {
            const record = allExpenses.find(x => x.ID.toString() === id.toString());
            if (!record) return showToast("âŒ á˜á·á“á¢á¶á…ášá€á€áŸ†áááŸ‹ááŸ’ášá¶á”á¶á“á‘áŸáŸ”", 'error');
            
            closeDetailModal(); // Close detail modal
            editingID = id;
            
            const reportForm = document.getElementById('report-form');
            if (reportForm) {
                activeFormElement = reportForm;
                populateForm(reportForm, record); // Populate the visible desktop form
                document.getElementById("report-expense-form-container").scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }


        async function editExpense(id, scrollToForm=true) {
            const record = allExpenses.find(x => x.ID.toString() === id.toString());
            if (!record) {
                showToast("âŒ á˜á·á“á¢á¶á…ášá€á€áŸ†áááŸ‹ááŸ’ášá¶á”á¶á“á‘áŸáŸ”", 'error');
                return;
            }

            closeDetailModal();
            editingID = id;

            const isMobile = window.innerWidth < 1024;

            if (isMobile) {
                // If on mobile, open the form modal for editing
                openFormModal();
                activeFormElement = document.getElementById('mobile-expense-form');
                populateForm(activeFormElement, record);
            } else {
                // If on desktop, populate the desktop form directly
                const reportForm = document.getElementById('report-form');
                if (reportForm) {
                    activeFormElement = reportForm;
                    populateForm(reportForm, record);
                    if (scrollToForm) {
                        document.getElementById("report-expense-form-container").scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }
        }

        // --- UTILS (REVERTED to standard formatCurrency) ---
        function formatCurrency(amount) {
            const num = parseFloat(amount) || 0;
            // Reverted to standard locale formatting for numbers, using comma separation
            return `${num.toLocaleString('km-KH', { maximumFractionDigits: 0 })} áŸ›`;
        }
        
        /**
         * Checks if two date strings are the same day (ignoring time).
         */
        function isSameDay(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        }

        // --- SUMMARY & FILTERING LOGIC (UPDATED) ---
        let filteredDataForReport = [];

        function calculateSummary(data) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();

            const activeExpenses = data.filter(x => x.Status === "Active");
            let totalExpense = 0;
            let todayExpense = 0;
            let monthlyExpense = 0;
            let totalMeat = 0;
            let totalVegetable = 0;
            let totalFruit = 0;
            let totalCount = activeExpenses.length;

            activeExpenses.forEach(x => {
                const amount = parseFloat(x.Amount) || 0;
                const recordDate = new Date(x.Date);

                // --- Breakdown Sums ---
                const meat = parseFloat(x.Meat) || 0;
                const vegetable = parseFloat(x.Vegetable) || 0;
                const fruit = parseFloat(x.Fruit) || 0;
                totalMeat += meat;
                totalVegetable += vegetable;
                totalFruit += fruit;

                // --- Time-based Sums (Uses the Amount from the Sheet's formula) ---
                totalExpense += amount;

                if (isSameDay(x.Date, today)) {
                    todayExpense += amount;
                }

                if (recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear) {
                    monthlyExpense += amount;
                }
            });

            // --- Rendering Summary Cards ---
            document.getElementById('total-expense-summary').textContent = formatCurrency(totalExpense);
            document.getElementById('today-expense-summary').textContent = formatCurrency(todayExpense);
            document.getElementById('monthly-expense-summary').textContent = formatCurrency(monthlyExpense);

            document.getElementById('meat-total-summary').textContent = formatCurrency(totalMeat);
            document.getElementById('vegetable-total-summary').textContent = formatCurrency(totalVegetable);
            document.getElementById('fruit-total-summary').textContent = formatCurrency(totalFruit);

            document.getElementById('total-count-summary').textContent = `${totalCount} á€áŸ†áááŸ‹ááŸ’ášá¶`;
            
            // Set the filtered total to the overall total initially
            const filteredSummaryElement = document.getElementById('filtered-expense-summary');
            if (filteredSummaryElement) {
                filteredSummaryElement.textContent = formatCurrency(totalExpense);
            }
        }

        // NEW: Populate years dynamically for filtering
        function populateYearOptions(data) {
            const selectDesktop = document.getElementById('filter-year');
            const selectModal = document.getElementById('modal-filter-year');
            
            if (!selectDesktop || !selectModal) return;

            // Clear existing custom year options (keep default 'all' and 'yearly')
            const clearOptions = (select) => {
                let existingYearOptions = select.querySelectorAll('option:not([value="all"]):not([value="yearly"])');
                existingYearOptions.forEach(opt => opt.remove());
            };

            clearOptions(selectDesktop);
            clearOptions(selectModal);

            const uniqueYears = new Set();
            data.filter(x => x.Status === "Active").forEach(x => {
                const year = new Date(x.Date).getFullYear();
                uniqueYears.add(year);
            });
            
            const sortedYears = Array.from(uniqueYears).sort((a, b) => b - a);

            const createYearOptions = (selectElement) => {
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = `year_${year}`;
                    option.textContent = year;
                    selectElement.appendChild(option.cloneNode(true));
                });
            };
            
            createYearOptions(selectDesktop);
            createYearOptions(selectModal);
        }

        function filterRecords() {
            // Get filter values (filters are always present in the DOM, even if hidden by CSS)
            const filterDay = document.getElementById('filter-day').value;
            const filterMonth = document.getElementById('filter-month').value;
            const filterYear = document.getElementById('filter-year').value;

            const expenseOnlyData = allExpenses.filter(x => x.Type === "Expense" || x.Status === "Deleted");

            const dataToFilter = currentView === 'active' ?
                                 expenseOnlyData.filter(x => x.Status === "Active") :
                                 expenseOnlyData.filter(x => x.Status === "Deleted");

            let filtered = dataToFilter;

            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            let filteredTotal = 0;


            filtered = filtered.filter(x => {
                const recordDate = new Date(x.Date + 'T00:00:00'); 
                const recordYear = recordDate.getFullYear();
                const recordMonth = recordDate.getMonth();
                const recordDay = recordDate.getDay();
                
                let matchesDay = true;
                let matchesMonth = true;
                let matchesYear = true;

                // 1. Day Filter
                if (filterDay === 'daily') {
                    matchesDay = isSameDay(x.Date, today);
                } else if (filterDay.startsWith('day_')) {
                    const targetDayIndex = filterDay === 'day_sun' ? 0 : (filterDay === 'day_mon' ? 1 : (filterDay === 'day_tue' ? 2 : (filterDay === 'day_wed' ? 3 : (filterDay === 'day_thu' ? 4 : (filterDay === 'day_fri' ? 5 : (filterDay === 'day_sat' ? 6 : -1))))));
                    matchesDay = recordDay === targetDayIndex;
                }

                // 2. Month Filter
                if (filterMonth === 'monthly') {
                    matchesMonth = recordMonth === currentMonth && recordYear === currentYear;
                } else if (filterMonth.startsWith('month_')) {
                    const targetMonth = parseInt(filterMonth.split('_')[1]);
                    
                    if (filterYear === 'all') { 
                        matchesMonth = recordMonth === targetMonth;
                    } else if (filterYear === 'yearly') { 
                        matchesMonth = recordMonth === targetMonth && recordYear === currentYear;
                    } else if (filterYear.startsWith('year_')) { 
                        const targetYear = parseInt(filterYear.split('_')[1]);
                        matchesMonth = recordMonth === targetMonth && recordYear === targetYear;
                    }
                }

                // 3. Year Filter
                if (filterYear === 'yearly') {
                    matchesYear = recordYear === currentYear;
                } else if (filterYear.startsWith('year_')) {
                    const targetYear = parseInt(filterYear.split('_')[1]);
                    matchesYear = recordYear === targetYear;
                }
                
                const matchesAll = matchesDay && matchesMonth && matchesYear;

                if(matchesAll && x.Status === "Active") {
                    filteredTotal += parseFloat(x.Amount) || 0;
                }

                return matchesAll;
            }).sort((a, b) => new Date(b.Date) - new Date(a.Date));

            filteredDataForReport = filtered;
            
            // NEW: Update the filtered total summary card
            document.getElementById('filtered-expense-summary').textContent = formatCurrency(filteredTotal);
            
            renderExpenseList(filtered);
        }

        function switchView(view) {
            currentView = view;
            const trashBtn = document.getElementById('trash-btn');
            trashBtn.innerHTML = view === 'active' ?
                '<i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> á€áŸ†áááŸ‹ááŸ’ášá¶áŠáŸ‚á›á”á¶á“á›á»á”' :
                '<i data-lucide="check-circle" class="w-4 h-4 mr-2"></i> á˜á¾á›á€áŸ†áááŸ‹ááŸ’ášá¶áŸá€á˜áŸ’á˜';
            trashBtn.onclick = view === 'active' ? () => switchView('trash') : () => switchView('active');
            trashBtn.classList.toggle('bg-gray-100', view === 'active');
            trashBtn.classList.toggle('bg-indigo-500', view === 'trash');
            trashBtn.classList.toggle('text-white', view === 'trash');
            trashBtn.classList.toggle('text-gray-600', view === 'active');

            // Reset all filters to default 'all'
            if(document.getElementById('filter-day')) document.getElementById('filter-day').value = 'all';
            if(document.getElementById('filter-month')) document.getElementById('filter-month').value = 'all';
            if(document.getElementById('filter-year')) document.getElementById('filter-year').value = 'all';

            filterRecords();
            lucide.createIcons();
        }

        // --- RENDER LIST (UPDATED UX/UI for mobile) ---
        function renderExpenseList(data) {
            const list = document.getElementById("expense-list");
            const isTrashView = currentView === 'trash';
            const today = new Date().toISOString().slice(0, 10);
            
            if (data.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500 py-10 text-xl border-dashed border-2 border-gray-300 rounded-lg m-4 bg-gray-50">
                    ${isTrashView ? 'ğŸ—‘ï¸ á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™á€áŸ’á“á»á„á’á»á„áŸáŸ†ášá¶á˜á‘áŸáŸ”' : 'âœ… á˜á·á“á˜á¶á“á€áŸ†áááŸ‹ááŸ’ášá¶á…áŸ†áá¶á™áŸá€á˜áŸ’á˜á‘áŸáŸ”'}
                </p>`;
                lucide.createIcons();
                return;
            }

            list.innerHTML = data.map(x => {
                const isDeleted = x.Status === 'Deleted';
                const badgeClass = isDeleted ? 'badge-deleted' : 'badge-expense';
                const amountTextClass = isDeleted ? 'text-gray-500 line-through' : 'text-red-600';
                const icon = 'arrow-down-left';

                const recordDate = new Date(x.Date + 'T00:00:00'); 
                const dayName = dayNames[recordDate.getDay()];
                const isToday = x.Date === today;
                
                // UX/UI Improvement: Place date on the right of the badge row
                const dateDisplay = `<span class="text-xs text-gray-500 text-right">${dayName} | ${x.Date}</span>${isToday ? ' <span class="font-bold text-red-500 text-xs">(ááŸ’á„áŸƒá“áŸáŸ‡)</span>' : ''}`;

                const recordJson = JSON.stringify(x).split("'").join("\\'");

                // Compact Breakdown (SHOWN ON MOBILE AND DESKTOP)
                const breakdown = `
                    <div class="mobile-description-and-breakdown">
                        <p class="text-xs text-gray-600 truncate">${x.Description || 'á˜á·á“á˜á¶á“á–á·á–ááŸŒá“á¶'}</p>
                        <div class="mobile-breakdown">
                            <span>áŸá¶á…áŸ‹: <span class="text-orange-600 font-medium">${formatCurrency(x.Meat)}</span></span>
                            <span>á”á“áŸ’á›áŸ‚: <span class="text-green-600 font-medium">${formatCurrency(x.Vegetable)}</span></span>
                            <span>á•áŸ’á›áŸ‚áˆá¾: <span class="text-yellow-600 font-medium">${formatCurrency(x.Fruit)}</span></span>
                        </div>
                    </div>
                `;

                // CRITICAL FIX: Ensure mobile action buttons prevent opening the detail modal when clicked
                const actionButtons = isDeleted ? `
                    <button onclick="event.stopPropagation(); restoreExpense('${x.ID}')" class="text-green-600 hover:text-green-800 p-2 rounded-full hover:bg-green-50 transition" title="á‘á¶á‰á™á€á˜á€áœá·á‰">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                    </button>
                    <button onclick="event.stopPropagation(); permanentDeleteExpense('${x.ID}')" class="text-gray-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 transition" title="á›á»á”á‡á¶á¢á…á·á“áŸ’ááŸ’ášáŸƒá™áŸ">
                        <i data-lucide="x-circle" class="w-5 h-5"></i>
                    </button>
                ` : `
                    <button onclick="event.stopPropagation(); editExpense('${x.ID}')" class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50 transition" title="á€áŸ‚á”áŸ’ášáŸ‚">
                        <i data-lucide="pencil" class="w-5 h-5"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteExpense('${x.ID}')" class="text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 transition" title="á›á»á”">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;

                return `
                    <div onclick="handleCardClick(${recordJson})" class="expense-item bg-white p-4 rounded-xl shadow-md border-l-4 ${isDeleted ? 'border-gray-500' : 'border-red-500'} flex justify-between items-start">
                        <div class="flex-main-content">
                            <div class="header-row">
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full ${badgeClass}">${x.Type === 'Expense' ? 'á…áŸ†áá¶á™' : 'á…áŸ†áá¼á›'}</span>
                                ${dateDisplay}
                            </div>
                            
                            <p class="mobile-title">á…áŸ†áá¶á™á‚áŸ’ášá¿á„á‘áŸáŸ</p>
                            
                            <div class="mobile-description-and-breakdown">
                                <p class="text-xs text-gray-600 truncate">${x.Description || 'á˜á·á“á˜á¶á“á–á·á–ááŸŒá“á¶'}</p>
                                <div class="mobile-breakdown">
                                    <span>áŸá¶á…áŸ‹: <span class="text-orange-600 font-medium">${formatCurrency(x.Meat)}</span></span>
                                    <span>á”á“áŸ’á›áŸ‚: <span class="text-green-600 font-medium">${formatCurrency(x.Vegetable)}</span></span>
                                    <span>á•áŸ’á›áŸ‚áˆá¾: <span class="text-yellow-600 font-medium">${formatCurrency(x.Fruit)}</span></span>
                                </div>
                            </div>
                        </div>

                        <div class="text-right ml-4 flex flex-col justify-between items-end">
                            <p class="mobile-amount font-extrabold ${amountTextClass} flex items-center justify-end whitespace-nowrap">
                                ${!isDeleted ? `<i data-lucide="${icon}" class="w-4 h-4 mr-1"></i>` : ''}
                                ${formatCurrency(parseFloat(x.Amount))}
                            </p>
                            <div class="item-actions flex space-x-1 mt-2 flex-shrink-0">
                                ${actionButtons}
                            </div>
                        </div>
                    </div>
                `;
            }).join("");

            lucide.createIcons();
        }

        // --- CRUD/DATA OPERATIONS (CRITICAL UPDATE) ---

        async function handleFormSubmission(e, source) {
            e.preventDefault();
            // Determine which form submitted the data
            const formElement = source === 'mobile' ? document.getElementById('mobile-expense-form') : document.getElementById('report-form');

            const date = formElement.querySelector("#date").value;
            const meat = parseFloat(formElement.querySelector("#meat").value) || 0;
            const vegetable = parseFloat(formElement.querySelector("#vegetable").value) || 0;
            const fruit = parseFloat(formElement.querySelector("#fruit").value) || 0;
            const desc = formElement.querySelector("#desc").value;

            // CAPTURE ALL CUSTOM INPUTS
            const customRows = formElement.querySelectorAll('.custom-expense-row');
            let customData = {};
            let totalOtherAmount = 0;

            customRows.forEach((row, i) => {
                const index = i + 1;
                const amountInput = row.querySelector('.custom-input-amount');
                const labelInput = row.querySelector('input[data-type="label"]');
                
                const amount = parseFloat(amountInput.value) || 0;
                const label = labelInput.value.trim();

                if (amount > 0 || label) {
                    customData[`${CUSTOM_FIELD_PREFIX}${index}_Label`] = label || `Custom #${index}`;
                    customData[`${CUSTOM_FIELD_PREFIX}${index}_Amount`] = amount;
                    totalOtherAmount += amount;
                } else {
                    customData[`${CUSTOM_FIELD_PREFIX}${index}_Label`] = '';
                    customData[`${CUSTOM_FIELD_PREFIX}${index}_Amount`] = 0;
                }
            });
            
            // IMPORTANT: Ensure unused fields up to MAX are explicitly sent as empty/0
            for(let i = customRows.length + 1; i <= MAX_CUSTOM_FIELDS; i++) {
                customData[`${CUSTOM_FIELD_PREFIX}${i}_Label`] = '';
                customData[`${CUSTOM_FIELD_PREFIX}${i}_Amount`] = 0;
            }


            const totalAmount = meat + vegetable + fruit + totalOtherAmount; // Re-verify total
            const type = 'Expense';

            const submitBtn = formElement.querySelector("#submit-btn");

            if (!date || totalAmount <= 0) { // UPDATED CHECK
                showToast("âš ï¸ áŸá¼á˜á”áŸ†á–áŸá‰á€á¶á›á”ášá·á…áŸ’á†áŸá‘ á“á·á„ááŸ’ášá¼áœááŸ‚á˜á¶á“á…áŸ†á“á½á“á”áŸ’ášá¶á€áŸ‹á…áŸ†áá¶á™áŸášá»á”!", 'warning');
                return;
            }

            const originalText = submitBtn.textContent;
            submitBtn.innerHTML = editingID ? '<i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-1"></i> á€áŸ†á–á»á„á€áŸ‚á”áŸ’ášáŸ‚...' : '<i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-1"></i> á€áŸ†á–á»á„á”á“áŸ’ááŸ‚á˜...';
            lucide.createIcons();
            submitBtn.disabled = true;

            let recordData = {
                Date: date,
                Type: type,
                Meat: meat,
                Vegetable: vegetable,
                Fruit: fruit,
                Description: desc,
                ModifiedDate: new Date().toISOString()
            };
            
            // Merge custom data into the main record payload
            recordData = {...recordData, ...customData};


            let res;
            if (editingID) {
                // PATCH request
                const url = `${SHEETDB_BASE_URL}/ID/${editingID}?sheet=${SHEET_EXPENSES}`;
                res = await fetch(url, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ data: [recordData] })
                });
                if (res.ok) showToast("âœ… á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“á€áŸ‚á”áŸ’ášáŸ‚áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!", 'success');
            } else {
                // POST request (Add new record)
                const payload = {
                    data: [{
                        ID: Date.now(),
                        UserEmail: user.Email,
                        Status: "Active",
                        ...recordData
                    }]
                };
                res = await fetch(sheetUrl(SHEET_EXPENSES), {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                if (res.ok) showToast("âœ… á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“á”á“áŸ’ááŸ‚á˜áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!", 'success');
            }

            if (res.ok) {
                if(source === 'mobile') closeFormModal();
                
                resetForm(formElement);
                setTimeout(loadAllData, 1500);
            } else {
                showToast("âŒ á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá”ášá¶á‡áŸá™áŸ”", 'error');
            }

            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            lucide.createIcons();
        }

        // --- Soft Delete/Restore/Permanent Delete functions (UNCHANGED logic) ---
        async function deleteExpense(id) {
            const confirmed = await customConfirm(
                "á”á‰áŸ’á‡á¶á€áŸ‹á€á¶ášá›á»á”á”ááŸ’áŠáŸ„áŸ‡á¢á¶áŸá“áŸ’á“",
                "á€áŸ†áááŸ‹ááŸ’ášá¶á“áŸáŸ‡á“á¹á„ááŸ’ášá¼áœá”á¶á“á•áŸ’á›á¶áŸáŸ‹á‘áŸ…á€á¶á“áŸ‹á’á»á„áŸáŸ†ášá¶á˜áŸ” áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠá‘áŸ?",
                "á•áŸ’á›á¶áŸáŸ‹á‘áŸ…á’á»á„áŸáŸ†ášá¶á˜",
                "delete"
            );
            if (confirmed) { await updateStatus(id, "Deleted", "á›á»á”á”ááŸ’áŠáŸ„áŸ‡á¢á¶áŸá“áŸ’á“"); }
        }

        async function restoreExpense(id) {
            const confirmed = await customConfirm(
                "á”á‰áŸ’á‡á¶á€áŸ‹á€á¶ášá‘á¶á‰á™á€á˜á€áœá·á‰",
                "áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á‘á¶á‰á™á€á€áŸ†áááŸ‹ááŸ’ášá¶á“áŸáŸ‡ááŸ’ášá¡á”áŸ‹á˜á€áœá·á‰á‘áŸ?",
                "á‘á¶á‰á™á€á˜á€áœá·á‰",
                "restore"
            );
            if (confirmed) { await updateStatus(id, "Active", "á‘á¶á‰á™á€á˜á€áœá·á‰"); }
        }

        async function permanentDeleteExpense(id) {
            const confirmed = await customConfirm(
                "âš ï¸ á›á»á”á‡á¶á¢á…á·á“áŸ’ááŸ’ášáŸƒá™áŸ",
                "á€áŸ†áááŸ‹ááŸ’ášá¶á“áŸáŸ‡á“á¹á„ááŸ’ášá¼áœá›á»á”á…áŸá‰á–á¸á”áŸ’ášá–áŸá“áŸ’á’á‘á¶áŸ†á„áŸáŸ’ášá»á„ á á¾á™á˜á·á“á¢á¶á…á™á€á˜á€áœá·á‰á”á¶á“á‘áŸáŸ” áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠá‘áŸ?",
                "á›á»á”á‡á¶á¢á…á·á“áŸ’ááŸ’ášáŸƒá™áŸ",
                "permanent_delete"
            );

            if (!confirmed) return;
            const url = `${SHEETDB_BASE_URL}/ID/${id}?sheet=${SHEET_EXPENSES}`;
            const res = await fetch(url, { method: "DELETE" });

            if (res.ok) {
                showToast("ğŸ—‘ï¸ á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“á›á»á”á‡á¶á¢á…á·á“áŸ’ááŸ’ášáŸƒá™áŸáŠáŸ„á™á‡áŸ„á‚á‡áŸá™áŸ”", 'success');
                loadAllData();
            } else {
                showToast("âŒ á€á¶ášá›á»á”á”ášá¶á‡áŸá™áŸ”", 'error');
            }
        }

        async function updateStatus(id, newStatus, actionName) {
            const url = `${SHEETDB_BASE_URL}/ID/${id}?sheet=${SHEET_EXPENSES}`;
            const res = await fetch(url, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data: [{ Status: newStatus, ModifiedDate: new Date().toISOString() }] })
            });

            if (res.ok) {
                showToast(`âœ… á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“${actionName}áŠáŸ„á™á‡áŸ„á‚á‡áŸá™áŸ”`, 'success');
                // Delay loading data briefly to allow Google Sheet's formula to update
                setTimeout(loadAllData, 1500);
            } else {
                showToast("âŒ á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá”ášá¶á‡áŸá™áŸ”", 'error');
            }
        }

        // --- DATA EXPORT (UPDATED logic) ---
        async function exportData(format) {
            const dataToExport = filteredDataForReport;
            
            // Reconstruct report name from individual filters (Use current filter states, even if hidden)
            const filterDayElement = document.getElementById('filter-day');
            const filterMonthElement = document.getElementById('filter-month');
            const filterYearElement = document.getElementById('filter-year');
            
            const dayText = filterDayElement.options[filterDayElement.selectedIndex].text;
            const monthText = filterMonthElement.options[filterMonthElement.selectedIndex].text;
            const yearText = filterYearElement.options[filterYearElement.selectedIndex].text;
            const reportName = `Report_${dayText}_${monthText}_${yearText}`;
            
            if (dataToExport.length === 0) {
                showToast("âš ï¸ á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŸá˜áŸ’ášá¶á”áŸ‹á‘á¶á‰á™á€á‘áŸáŸ” áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸášá”á¶á™á€á¶ášááŸá•áŸ’áŸáŸá„á‘áŸ€ááŸ”", 'warning', 6000);
                return;
            }

            // --- EXCEL EXPORT ---
            if (format === 'excel') {
                // IMPORTANT: Ensure you include all Custom columns here for export!
                const exportColumns = ['á€á¶á›á”ášá·á…áŸ’á†áŸá‘', 'á”áŸ’ášá—áŸá‘', 'áŸášá»á”á”áŸ’ášá¶á€áŸ‹ (áŸ›)', 'áŸá¶á…áŸ‹ (áŸ›)', 'á”á“áŸ’á›áŸ‚ (áŸ›)', 'á•áŸ’á›áŸ‚áˆá¾ (áŸ›)'];
                
                // Add dynamic custom columns to the header row for export
                for(let i=1; i<=MAX_CUSTOM_FIELDS; i++) {
                    exportColumns.push(`Custom${i}_Label`);
                    exportColumns.push(`Custom${i}_Amount`);
                }
                exportColumns.push('á–á·á–ááŸŒá“á¶', 'áŸáŸ’áá¶á“á—á¶á–');

                const structuredData = dataToExport.map(x => {
                    let row = {
                        'á€á¶á›á”ášá·á…áŸ’á†áŸá‘': x.Date,
                        'á”áŸ’ášá—áŸá‘': x.Type,
                        'áŸášá»á”á”áŸ’ášá¶á€áŸ‹ (áŸ›)': parseFloat(x.Amount) || 0,
                        'áŸá¶á…áŸ‹ (áŸ›)': parseFloat(x.Meat) || 0,
                        'á”á“áŸ’á›áŸ‚ (áŸ›)': parseFloat(x.Vegetable) || 0,
                        'á•áŸ’á›áŸ‚áˆá¾ (áŸ›)': parseFloat(x.Fruit) || 0,
                    };
                    
                    for(let i=1; i<=MAX_CUSTOM_FIELDS; i++) {
                         row[`Custom${i}_Label`] = x[`Custom${i}_Label`] || '';
                         row[`Custom${i}_Amount`] = parseFloat(x[`Custom${i}_Amount`]) || 0;
                    }
                    
                    row['á–á·á–ááŸŒá“á¶'] = x.Description || '';
                    row['áŸáŸ’áá¶á“á—á¶á–'] = x.Status;
                    return row;
                });


                if (typeof XLSX === 'undefined') {
                    showToast("âŒ á€áŸ†á á»áŸ! SheetJS (XLSX) library á˜á·á“ááŸ’ášá¼áœá”á¶á“á•áŸ’á‘á»á€á‘áŸáŸ”", 'error');
                    return;
                }

                try {
                    const workbook = XLSX.utils.book_new();
                    const worksheet = XLSX.utils.json_to_sheet(structuredData, {header: exportColumns});
                    XLSX.utils.book_append_sheet(workbook, worksheet, reportName);
                    XLSX.writeFile(workbook, `${reportName}_ExpenseReport_${new Date().toISOString().slice(0,10)}.xlsx`);
                    showToast(`âœ… á¯á€áŸá¶áš Excel (.xlsx) ááŸ’ášá¼áœá”á¶á“á‘á¶á‰á™á€áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!`, 'success');
                } catch (error) {
                    console.error("Excel Export Failed:", error);
                    showToast("âŒ á€á¶ášá‘á¶á‰á™á€á¯á€áŸá¶áš Excel á”ášá¶á‡áŸá™áŸ”", 'error');
                }

            } 
            // --- PDF EXPORT (UNCHANGED Logic) ---
            else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const inputElement = document.getElementById('data-view-section');

                document.querySelectorAll('.item-actions').forEach(el => el.style.display = 'none');

                const pdfBtn = document.querySelector('button[onclick="exportData(\'pdf\')"]');
                if (window.innerWidth >= 1024) { // Only update desktop button state
                    pdfBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 mr-1"></i> á€áŸ†á–á»á„ášáŸ€á”á…áŸ† PDF...';
                    pdfBtn.disabled = true;
                }


                try {
                    const canvas = await html2canvas(inputElement, {
                        scale: 2,
                        useCORS: true,
                        windowWidth: inputElement.scrollWidth,
                        windowHeight: inputElement.scrollHeight
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const pdf = new jsPDF('p', 'mm', 'a4');

                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();

                    const imgHeight = canvas.height * pdfWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.setFontSize(16);
                    pdf.text(`ášá”á¶á™á€á¶ášááŸá…áŸ†áá¶á™: ${reportName}`, 10, 10);
                    pdf.setFontSize(10);
                    pdf.text(`á€á¶á›á”ášá·á…áŸ’á†áŸá‘: ${new Date().toLocaleDateString('km-KH')}`, 10, 17);

                    position = 25;

                    while (heightLeft >= 0) {
                        if (position > 25) {
                            pdf.addPage();
                        }

                        pdf.addImage(imgData, 'JPEG', 0, position - imgHeight, pdfWidth, imgHeight);

                        heightLeft -= pdfHeight - 15;

                        position -= pdfHeight - 15;
                    }

                    pdf.save(`${reportName}_Report_${new Date().toISOString().slice(0,10)}.pdf`);
                    showToast(`âœ… á¯á€áŸá¶áš PDF ááŸ’ášá¼áœá”á¶á“á‘á¶á‰á™á€áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!`, 'success');

                } catch(error) {
                    console.error("PDF Export failed:", error);
                    showToast("âŒ á€á¶ášá‘á¶á‰á™á€ PDF á”ášá¶á‡áŸá™áŸ”", 'error');
                } finally {
                    document.querySelectorAll('.item-actions').forEach(el => el.style.display = 'flex');
                    if (window.innerWidth >= 1024) {
                        pdfBtn.innerHTML = '<i data-lucide="file-text" class="w-4 h-4 mr-1"></i> á‘á¶á‰á™á€ PDF';
                        pdfBtn.disabled = false;
                    }
                    
                    lucide.createIcons();
                }
            }
        }

        // --- Initialization ---
        async function loadAllData() {
            // Only show loading text if we're on the report tab
            if (activeTab === 'report') {
                document.getElementById("expense-list").innerHTML = '<p class="text-center text-gray-500 py-10 flex items-center justify-center"><i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-3"></i> á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</p>';
            }

            try {
                const res = await fetch(sheetUrl(SHEET_EXPENSES));
                const data = await res.json();

                // CRITICAL: Filter records and ensure the necessary fields exist
                allExpenses = data.filter(x => x.ID && (x.Type === 'Expense' || x.Status === 'Deleted') && x.Amount !== undefined);

                populateYearOptions(allExpenses); // NEW: Populate year options
                calculateSummary(allExpenses);
                filterRecords();
            } catch (error) {
                // Only update error state for the list if we'll viewing the list
                if (activeTab === 'report') {
                    document.getElementById("expense-list").innerHTML = '<p class="text-center text-red-500 py-10 text-lg">âŒ á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá‘á¶á‰á‘á·á“áŸ’á“á“áŸá™áŸ” áŸá¼á˜á–á·á“á·ááŸ’á™á˜á¾á› Column headers á€áŸ’á“á»á„ SheetDB</p>';
                }
                console.error("Error loading expenses:", error);
                showToast("âŒ á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá•áŸ’á‘á»á€á‘á·á“áŸ’á“á“áŸá™á…áŸ†áá¶á™! (á–á·á“á·ááŸ’á™ Column names á€áŸ’á“á»á„ SheetDB)", 'error', 6000);
            }
        }

        // Execute setup and data loading
        setupForms();
        loadAllData();
        setActiveTab('dashboard'); // NEW: Set initial view to Dashboard
    </script>
</body>
</html>