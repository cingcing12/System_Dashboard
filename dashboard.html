<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Expense Manager Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="icon" href="iconApp.jpg">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Khmer+OS+Muol:wght@400;600;700&family=Khmer+OS+Battambang:wght@400;600;700&display=swap');
        
        body { font-family: 'Khmer OS Battambang', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; padding-bottom: 100px; }
        h1, h2, h3, .font-khmer-header { font-family: 'Khmer OS Muol', 'Khmer OS Battambang', sans-serif !important; }
        
        /* ANIMATIONS */
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        .animate-pop-in { animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }

        /* MODALS */
        .modal { 
            display: none; position: fixed; inset: 0; 
            background: rgba(15, 23, 42, 0.65); 
            justify-content: center; align-items: center; 
            z-index: 50; backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }
        .modal.active { display: flex; animation: fadeIn 0.2s; }

        /* BOTTOM DOCK */
        .bottom-dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            border-radius: 24px; padding: 8px 24px;
            box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255,255,255,0.5);
            display: flex; justify-content: space-between; align-items: center; z-index: 40;
        }
        .add-btn-dock {
            background: linear-gradient(135deg, #4f46e5, #3730a3);
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; box-shadow: 0 8px 20px -4px rgba(79, 70, 229, 0.5);
            transform: translateY(-30px); transition: transform 0.2s; border: 4px solid #f8fafc;
        }
        .add-btn-dock:active { transform: translateY(-30px) scale(0.95); }
        .dock-icon { color: #64748b; padding: 10px; border-radius: 14px; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .dock-icon span { font-size: 10px; font-weight: 600; }
        .dock-icon:active { background-color: #f1f5f9; color: #334155; }

        /* CONFIRM BOX */
        .confirm-box { background: white; border-radius: 24px; padding: 24px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: popIn 0.2s forwards; }

        /* TOAST */
        .toast-box { 
            background: white; border-left: 4px solid; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15); 
            border-radius: 12px; padding: 16px; 
            display: flex; align-items: center; gap: 12px; 
            min-width: 300px; animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* CARDS */
        .card-gradient-1 { background: linear-gradient(135deg, #6366f1, #4338ca); color: white; }
        .card-gradient-2 { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .card-gradient-3 { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .card-gradient-4 { background: linear-gradient(135deg, #ec4899, #be185d); color: white; }
        
        .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 60; flex-direction: column; }
        .tab-btn.active { border-bottom: 3px solid #4f46e5; color: #4f46e5; font-weight: bold; }
        .tab-btn { color: #64748b; }

        /* Custom Select Styling */
        select.custom-select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body>

    <div id="toast-container" class="fixed top-4 right-4 z-[100] space-y-2 pointer-events-none"></div>

    <div id="customConfirmModal" class="modal items-center" style="z-index: 60;">
        <div class="confirm-box">
            <div id="confirm-icon-box" class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i id="confirm-icon" data-lucide="alert-triangle" class="w-8 h-8 text-red-500"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2 font-khmer-header" id="confirm-title">Are you sure?</h3>
            <p class="text-sm text-slate-500 mb-6" id="confirm-msg">This action cannot be undone.</p>
            <div class="flex gap-3">
                <button id="confirm-cancel-btn" onclick="closeConfirm(false)" class="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition">Cancel</button>
                <button id="confirm-yes-btn" class="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition shadow-lg shadow-red-200">Yes</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal px-4 items-center" style="z-index: 55;">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 animate-slide-up flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-start mb-6 border-b border-slate-100 pb-4 shrink-0">
                <div>
                    <p class="text-xs text-slate-400 uppercase font-bold mb-1">Details</p>
                    <h3 class="text-xl font-bold text-slate-800 font-khmer-header" id="detail-date">...</h3>
                </div>
                <button onclick="closeModal('detailModal')" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200 text-slate-500">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-6 overflow-y-auto pr-1">
                <div class="text-center py-2">
                      <p class="text-sm text-slate-500 mb-1">Total Amount</p>
                      <p class="text-3xl font-bold text-indigo-600" id="detail-amount">0 ៛</p>
                </div>

                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-2">Description</p>
                    <p class="text-slate-700 font-medium leading-relaxed" id="detail-desc">...</p>
                </div>

                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase mb-3">Breakdown</p>
                    <div id="detail-breakdown" class="space-y-2"></div>
                </div>
                
                <div class="flex items-center justify-between text-xs text-slate-400 border-t pt-4 mt-4">
                    <span id="detail-user" class="flex items-center gap-1"><i data-lucide="user" class="w-3"></i> ...</span>
                    <span id="detail-status" class="px-2 py-1 rounded bg-emerald-100 text-emerald-700 font-bold">Active</span>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-slate-100 flex gap-2 shrink-0" id="detail-actions"></div>
        </div>
    </div>


    <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2 font-khmer-header">
                <div class="p-2 bg-indigo-100 rounded-lg text-indigo-600"><i data-lucide="wallet" class="w-5 h-5"></i></div>
                Expense
            </h1>
            <div class="flex items-center gap-3">
                <button onclick="openSettingsModal()" class="p-2 text-slate-500 hover:bg-slate-100 rounded-full transition"><i data-lucide="settings-2" class="w-6 h-6"></i></button>
                <div class="relative">
                    <button onclick="toggleProfileMenu()" class="w-10 h-10 rounded-full bg-indigo-100 border-2 border-white shadow-sm flex items-center justify-center overflow-hidden">
                        <img id="header-avatar" src="" class="w-full h-full object-cover">
                    </button>
                    <div id="profile-menu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-xl py-2 border border-slate-100 z-50">
                        <div class="px-4 py-3 border-b border-slate-50">
                            <p class="text-sm font-bold text-slate-800 truncate" id="menu-email">Loading...</p>
                            <span class="text-xs px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded-full font-medium" id="menu-role">...</span>
                        </div>
                        <a href="#" onclick="openInfoModal()" class="block px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i data-lucide="user" class="w-4 h-4"></i> ព័ត៌មានគណនី</a>
                        <a href="user.html" id="btn-manage-users" class="hidden px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> គ្រប់គ្រងអ្នកប្រើ</a>
                        <a href="#" onclick="confirmLogout()" class="block px-4 py-2 text-sm text-red-500 hover:bg-red-50 flex items-center gap-2 mt-1"><i data-lucide="log-out" class="w-4 h-4"></i> ចាកចេញ</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="bg-white border-b border-slate-200 sticky top-[64px] z-30">
        <div class="max-w-7xl mx-auto px-4 flex gap-6">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn active py-3 px-2 text-sm font-medium transition">ផ្ទាំងគ្រប់គ្រង</button>
            <button onclick="switchTab('report')" id="tab-report" class="tab-btn py-3 px-2 text-sm font-medium transition">របាយការណ៍</button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4">
        <div id="view-dashboard" class="block space-y-6 fade-in">
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                <div class="card-gradient-1 p-4 rounded-2xl shadow-lg col-span-2 sm:col-span-1">
                    <p class="text-xs text-indigo-100 mb-1">ចំណាយសរុប</p>
                    <p class="text-2xl font-bold truncate" id="total-summary">0 ៛</p>
                </div>
                <div class="card-gradient-2 p-4 rounded-2xl shadow-lg">
                    <p class="text-xs text-emerald-100 mb-1">ថ្ងៃនេះ</p>
                    <p class="text-xl font-bold truncate" id="today-summary">0 ៛</p>
                </div>
                <div class="card-gradient-3 p-4 rounded-2xl shadow-lg">
                    <p class="text-xs text-amber-100 mb-1">ខែនេះ</p>
                    <p class="text-xl font-bold truncate" id="month-summary">0 ៛</p>
                </div>
                <div class="card-gradient-4 p-4 rounded-2xl shadow-lg">
                    <p class="text-xs text-pink-100 mb-1">ឆ្នាំនេះ</p>
                    <p class="text-xl font-bold truncate" id="year-summary">0 ៛</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <p class="text-xs text-slate-400 mb-1">កំណត់ត្រា</p>
                    <p class="text-xl font-bold text-slate-700 truncate" id="count-summary">0</p>
                </div>
            </div>
        </div>

        <div id="view-report" class="hidden">
             <div class="hidden lg:flex bg-white p-3 rounded-2xl shadow-sm border border-slate-200 items-center gap-3 mb-6">
                <div class="relative flex-grow max-w-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="h-4 w-4 text-slate-400"></i>
                    </div>
                    <input type="text" id="d-search-input" class="block w-full pl-10 pr-3 py-2.5 border border-slate-200 rounded-xl leading-5 bg-slate-50 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 sm:text-sm transition" placeholder="Search description..." oninput="applyFilters()">
                </div>
                <div class="h-8 w-px bg-slate-200 mx-2"></div>
                <div class="flex items-center gap-2">
                    <div class="relative"><input type="date" id="d-filter-date" class="pl-3 pr-2 py-2 border border-slate-200 rounded-xl bg-slate-50 text-sm focus:ring-2 focus:ring-indigo-500 text-slate-600" onchange="syncAndApply('desktop')"></div>
                    <div class="relative"><select id="d-filter-day" class="custom-select pl-3 pr-8 py-2 border border-slate-200 rounded-xl bg-slate-50 text-sm focus:ring-2 focus:ring-indigo-500 text-slate-600 cursor-pointer hover:bg-white transition" onchange="syncAndApply('desktop')"><option value="">Day</option><option value="1">Mon</option><option value="2">Tue</option><option value="3">Wed</option><option value="4">Thu</option><option value="5">Fri</option><option value="6">Sat</option><option value="0">Sun</option></select></div>
                    <select id="d-filter-month" class="custom-select pl-3 pr-8 py-2 border border-slate-200 rounded-xl bg-slate-50 text-sm focus:ring-2 focus:ring-indigo-500 text-slate-600 cursor-pointer hover:bg-white transition" onchange="syncAndApply('desktop')"><option value="">Month</option></select>
                    <select id="d-filter-year" class="custom-select pl-3 pr-8 py-2 border border-slate-200 rounded-xl bg-slate-50 text-sm focus:ring-2 focus:ring-indigo-500 text-slate-600 cursor-pointer hover:bg-white transition" onchange="syncAndApply('desktop')"><option value="">Year</option></select>
                </div>
                <div class="flex-grow"></div>
                <div class="flex items-center gap-2">
                    <button onclick="resetFilters()" class="p-2.5 text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-xl transition" title="Reset Filters"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                    <button onclick="openExportModal()" class="flex items-center gap-2 px-4 py-2.5 bg-slate-900 text-white text-sm font-medium rounded-xl hover:bg-slate-800 transition shadow-md"><i data-lucide="download" class="w-4 h-4"></i> Export</button>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-slate-800 font-khmer-header" id="list-header-title">បញ្ជីចំណាយ</h2>
                        <div class="flex gap-2">
                            <button onclick="toggleTrashView()" id="trash-toggle-btn" class="text-sm text-gray-500 flex items-center gap-1 hover:text-red-500 transition px-3 py-1 rounded-lg border border-gray-200 bg-white shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i> Trash</button>
                            <button onclick="loadData()" class="text-sm text-indigo-600 flex items-center gap-1 px-3 py-1 rounded-lg border border-indigo-100 bg-indigo-50 hover:bg-indigo-100 transition"><i data-lucide="refresh-ccw" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div id="expense-list" class="space-y-3 pb-20 lg:pb-0"></div>
                </div>
                <div class="hidden lg:block bg-white p-6 rounded-2xl shadow-md h-fit sticky top-24 border border-slate-100">
                    <h2 class="text-xl font-bold text-indigo-700 mb-4 font-khmer-header" id="desktop-form-title">➕ បន្ថែមកំណត់ត្រា</h2>
                    <form id="desktop-form" onsubmit="handleFormSubmit(event, 'desktop-form')">
                        <input type="hidden" name="ID" id="desktop-edit-id">
                        <div id="desktop-dynamic-inputs" class="space-y-4"><div class="text-center p-4"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto text-indigo-500"></i><p class="text-xs text-gray-400 mt-2">Loading categories...</p></div></div>
                        <div class="mt-4 pt-4 border-t">
                            <label class="block text-sm font-medium text-slate-600 mb-1">ពិពណ៌នា</label>
                            <textarea name="Description" rows="2" class="w-full p-3 border rounded-xl bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none transition"></textarea>
                        </div>
                        <div class="mt-4 p-3 bg-indigo-50 rounded-xl flex justify-between items-center">
                            <span class="text-sm font-medium text-indigo-800">សរុប:</span>
                            <span class="text-xl font-bold text-indigo-700" id="desktop-total-display">0 ៛</span>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button type="button" id="desktop-cancel-btn" onclick="resetForm('desktop-form')" class="hidden w-1/3 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold">Cancel</button>
                            <button type="submit" id="desktop-submit-btn" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">រក្សាទុក</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <div id="mobile-dock" class="bottom-dock lg:hidden hidden">
        <button onclick="openFilterModal()" class="dock-icon"><i data-lucide="search" class="w-6 h-6"></i><span>Search</span></button>
        <button onclick="openMobileModal()" class="add-btn-dock"><i data-lucide="plus" class="w-8 h-8"></i></button>
        <button onclick="openExportModal()" class="dock-icon"><i data-lucide="download" class="w-6 h-6"></i><span>Export</span></button>
    </div>

    <div id="filterModal" class="modal px-4 items-center">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i data-lucide="filter" class="w-5 h-5 text-indigo-600"></i> ស្វែងរក</h3>
                <button onclick="closeModal('filterModal')" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button>
            </div>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500 uppercase mb-1">ថ្ងៃ (Day)</label><select id="m-filter-day" class="w-full p-3 border rounded-xl bg-slate-50"><option value="">ទាំងអស់</option><option value="1">ច័ន្ទ</option><option value="2">អង្គារ</option><option value="3">ពុធ</option><option value="4">ព្រហស្បតិ៍</option><option value="5">សុក្រ</option><option value="6">សៅរ៍</option><option value="0">អាទិត្យ</option></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase mb-1">ខែ</label><select id="m-filter-month" class="w-full p-3 border rounded-xl bg-slate-50"><option value="">ទាំងអស់</option></select></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase mb-1">ឆ្នាំ</label><select id="m-filter-year" class="w-full p-3 border rounded-xl bg-slate-50"><option value="">ទាំងអស់</option></select></div>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="resetFilters(); closeModal('filterModal')" class="flex-1 py-3 bg-slate-100 text-slate-700 font-bold rounded-xl">Reset</button>
                <button onclick="syncAndApply('mobile'); closeModal('filterModal')" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">Search</button>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal px-4 items-center">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 animate-pop-in">
            <h3 class="text-lg font-bold text-slate-800 mb-4 font-khmer-header">Export Data</h3>
            <div class="space-y-3">
                <button onclick="openDateSelection('pdf')" class="w-full flex items-center p-4 bg-red-50 text-red-700 rounded-xl border border-red-100 hover:bg-red-100 transition group">
                    <div class="p-2 bg-white rounded-lg mr-4 shadow-sm group-hover:scale-110 transition-transform">
                        <i data-lucide="file-text" class="w-6 h-6 text-red-600"></i>
                    </div>
                    <div class="text-left">
                        <p class="font-bold">Save as PDF</p>
                        <p class="text-xs text-red-500">Professional Report</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 ml-auto opacity-50"></i>
                </button>

                <button onclick="openDateSelection('excel')" class="w-full flex items-center p-4 bg-green-50 text-green-700 rounded-xl border border-green-100 hover:bg-green-100 transition group">
                    <div class="p-2 bg-white rounded-lg mr-4 shadow-sm group-hover:scale-110 transition-transform">
                        <i data-lucide="table" class="w-6 h-6 text-green-600"></i>
                    </div>
                    <div class="text-left">
                        <p class="font-bold">Save as Excel</p>
                        <p class="text-xs text-green-600">Styled Spreadsheet</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 ml-auto opacity-50"></i>
                </button>
            </div>
            <button onclick="closeModal('exportModal')" class="w-full mt-6 py-3 text-slate-400 font-medium hover:text-slate-600">Cancel</button>
        </div>
    </div>

    <div id="dateSelectionModal" class="modal px-4 items-center" style="z-index: 55;">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2 font-khmer-header">
                    <i data-lucide="calendar-days" class="w-5 h-5 text-indigo-600"></i> Select Range
                </h3>
                <button onclick="closeModal('dateSelectionModal')" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                </button>
            </div>

            <input type="hidden" id="export-target-type" value="">

            <div class="space-y-4">
                <p class="text-sm text-slate-500 font-medium">Select data range:</p>
                
                <label class="flex items-center p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition" onclick="togglePDFInputs('all')">
                    <input type="radio" name="pdf_option" value="all" class="w-5 h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked>
                    <span class="ml-3 font-bold text-slate-700">All Data</span>
                </label>

                <label class="flex items-center p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition" onclick="togglePDFInputs('month')">
                    <input type="radio" name="pdf_option" value="month" class="w-5 h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                    <div class="ml-3 w-full">
                        <span class="font-bold text-slate-700 block">Monthly</span>
                        <div id="pdf-input-month" class="hidden mt-2">
                            <input type="month" id="pdf-month-val" class="w-full p-2 border rounded-lg text-sm bg-white">
                        </div>
                    </div>
                </label>

                <label class="flex items-center p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition" onclick="togglePDFInputs('year')">
                    <input type="radio" name="pdf_option" value="year" class="w-5 h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                    <div class="ml-3 w-full">
                        <span class="font-bold text-slate-700 block">Yearly</span>
                        <div id="pdf-input-year" class="hidden mt-2">
                            <select id="pdf-year-val" class="w-full p-2 border rounded-lg text-sm bg-white"></select>
                        </div>
                    </div>
                </label>

                <label class="flex items-center p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition" onclick="togglePDFInputs('range')">
                    <input type="radio" name="pdf_option" value="range" class="w-5 h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                    <div class="ml-3 w-full">
                        <span class="font-bold text-slate-700 block">Date Range</span>
                        <div id="pdf-input-range" class="hidden mt-2 grid grid-cols-2 gap-2">
                            <input type="date" id="pdf-start-val" class="w-full p-2 border rounded-lg text-sm bg-white" placeholder="Start">
                            <input type="date" id="pdf-end-val" class="w-full p-2 border rounded-lg text-sm bg-white" placeholder="End">
                        </div>
                    </div>
                </label>
            </div>

            <button onclick="handleExportConfirmation()" class="w-full mt-6 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
                <i data-lucide="download" class="w-4 h-4"></i> Generate File
            </button>
        </div>
    </div>

    <div id="mobileModal" class="modal px-4 items-center">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800 font-khmer-header" id="mobile-modal-title">បន្ថែមចំណាយ</h3>
                <button onclick="closeMobileModal()" class="text-slate-400"><i data-lucide="x"></i></button>
            </div>
            <div class="overflow-y-auto p-4">
                <form id="mobile-form" onsubmit="handleFormSubmit(event, 'mobile-form')">
                    <input type="hidden" name="ID" id="mobile-edit-id">
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">កាលបរិច្ឆេទ</label>
                        <input type="date" name="Date" id="mobile-date" class="w-full p-3 border rounded-xl bg-slate-50 font-medium" required onchange="checkExistingDate(this.value, 'mobile-form')">
                    </div>
                    <div id="mobile-dynamic-inputs" class="space-y-4"><div class="text-center p-4"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto text-indigo-500"></i><p class="text-xs text-gray-400 mt-2">Loading categories...</p></div></div>
                    <div class="mt-6 pt-4 border-t">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ពិពណ៌នា</label>
                        <textarea name="Description" rows="2" class="w-full p-3 border rounded-xl bg-slate-50" placeholder="..."></textarea>
                    </div>
                </form>
            </div>
            <div class="p-4 border-t bg-slate-50">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-sm text-slate-500">សរុប</span>
                    <span class="text-2xl font-bold text-indigo-600" id="mobile-total-display">0 ៛</span>
                </div>
                <button id="mobile-submit-btn" onclick="document.getElementById('mobile-form').requestSubmit()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">រក្សាទុក</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal px-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 relative overflow-hidden">
            <div id="settings-loading" class="loading-overlay hidden flex-col">
                <i data-lucide="loader-2" class="w-10 h-10 animate-spin text-indigo-600 mb-3"></i>
                <p class="text-sm font-bold text-slate-700 animate-pulse">Syncing with Cloud...</p>
            </div>
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 font-khmer-header">កំណត់ប្រភេទចំណាយ</h3>
                <button onclick="closeSettingsModal()" class="text-slate-400"><i data-lucide="x"></i></button>
            </div>
            
            <div class="flex justify-between text-xs font-bold text-slate-400 uppercase mb-2 px-2">
                <span>Category</span>
                <span>Actions / Show</span>
            </div>

            <div id="category-list" class="space-y-2 max-h-[40vh] overflow-y-auto mb-4 pr-1">
                <div class="text-center py-4 text-slate-400 text-sm"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading from Cloud...</div>
            </div>

            <form onsubmit="handleCategorySubmit(event)" class="bg-slate-50 p-4 rounded-xl border border-slate-200 relative">
                <input type="hidden" id="edit-mode-index" value="-1">
                <input type="hidden" id="edit-old-key" value="">
                <p class="text-xs font-bold text-slate-500 mb-3 uppercase" id="form-title">បន្ថែមប្រភេទថ្មី</p>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label class="text-[10px] text-slate-400 font-bold">Key (English)</label><input type="text" id="new-cat-en" placeholder="Food" class="w-full p-2 border rounded-lg text-sm" required pattern="[A-Za-z0-9_]+"></div>
                    <div><label class="text-[10px] text-slate-400 font-bold">Name (Khmer)</label><input type="text" id="new-cat-km" placeholder="អាហារ" class="w-full p-2 border rounded-lg text-sm" required></div>
                </div>
                <div class="flex gap-2">
                    <button type="button" id="cancel-edit-btn" onclick="resetCategoryForm()" class="hidden w-1/3 bg-slate-200 text-slate-700 py-2 rounded-lg text-sm font-bold">Cancel</button>
                    <button type="submit" id="save-cat-btn" class="w-full bg-slate-800 text-white py-2 rounded-lg text-sm font-bold hover:bg-slate-900 flex items-center justify-center"><i data-lucide="plus-circle" class="w-4 h-4 mr-1"></i> Add</button>
                </div>
            </form>
        </div>
    </div>

    <div id="infoModal" class="modal px-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-xl p-6">
            <h3 class="text-xl font-bold text-indigo-700 mb-4 font-khmer-header">ព័ត៌មានគណនី</h3>
            <div class="text-center mb-4"><img id="modal-avatar" src="" class="w-24 h-24 rounded-full mx-auto border-4 border-indigo-50 object-cover shadow-sm"></div>
            <div class="text-center mb-6">
                <p class="text-slate-800 font-bold text-lg" id="modal-email-display">...</p>
                <span class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full font-medium mt-2 inline-block" id="modal-role-display">...</span>
            </div>
            <button onclick="document.getElementById('infoModal').classList.remove('active')" class="w-full bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200">បិទ</button>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // --- AUTH CHECK ---
        const userStr = localStorage.getItem('user');
        if (!userStr) { window.location.href = 'index.html'; throw new Error("User not logged in"); }
        const user = JSON.parse(userStr); 

        // CONFIG
        const SHEETDB_URL = "https://sheetdb.io/api/v1/lman7mvjnhxo8"; 
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxgwmWfbIQb7ETnPQHlmydgAhShl9a9Nn-lIjhlBKdB7aYi4WiyjFYfjL2cIUXfpes7ig/exec"; 

        // USER STATE
        let categories = []; 
        let allExpenses = [];
        let filteredExpenses = [];
        let currentView = 'active';
        
        // --- LOGO (Base64) ---
        const LOGO_BASE64 = "logoPdf.jpg";

        // --- DATE FORMATTER ---
        function formatDateFriendly(dateStr) {
            if(!dateStr) return '';
            const parts = dateStr.split('-');
            if(parts.length !== 3) return dateStr;
            const date = new Date(parts[0], parts[1] - 1, parts[2]);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        }
        function formatDateMinimal(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: '2-digit' });
        }

        // --- HELPER: Convert English Numbers to Khmer (0-9 -> ០-៩) ---
        function toKhmerNum(num) {
            const khmerNums = ['០', '១', '២', '៣', '៤', '៥', '៦', '៧', '៨', '៩'];
            return num.toString().replace(/[0-9]/g, w => khmerNums[+w]);
        }

        // --- HELPER: Get Complex Khmer Footer Dates ---
        function getKhmerFooterDates() {
            const date = new Date();
            const days = ['អាទិត្យ', 'ច័ន្ទ', 'អង្គារ', 'ពុធ', 'ព្រហស្បតិ៍', 'សុក្រ', 'សៅរ៍'];
            const months = ["មករា", "កុម្ភៈ", "មីនា", "មេសា", "ឧសភា", "មិថុនា", "កក្កដា", "សីហា", "កញ្ញា", "តុលា", "វិច្ឆិកា", "ធ្នូ"];

            // Gregorian Data
            const dayName = days[date.getDay()];
            const dayNum = date.getDate();
            const monthName = months[date.getMonth()];
            const year = date.getFullYear();
            const beYear = year + 543; // Buddhist Era (Approximate)

            // Convert to Khmer Numerals
            const kDay = toKhmerNum(dayNum);
            const kYear = toKhmerNum(year);
            const kBeYear = toKhmerNum(beYear);

            // LINE 1: Lunar Format (Traditional)
            const lunarLine = `ថ្ងៃ${dayName} ៥កើត ខែមិគសិរ ឆ្នាំម្សាញ់ សប្តស័ក ព.ស ២៥៦៩`; 

            // LINE 2: Location & Gregorian Date
            const gregorianLine = `កំពង់ស្ពឺ ថ្ងៃទី ${kDay} ខែ ${monthName} ឆ្នាំ ${kYear}`;

            return { lunar: lunarLine, gregorian: gregorianLine };
        }

        // --- CUSTOM CONFIRM/ALERT ---
        let confirmCallback = null;
        function customConfirm(title, msg, yesText, colorClass, callback) {
            const iconContainer = document.getElementById('confirm-icon-box');
            iconContainer.className = 'w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4';
            iconContainer.innerHTML = '<i data-lucide="alert-triangle" class="w-8 h-8 text-red-500"></i>';
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('confirm-cancel-btn').classList.remove('hidden');
            const btn = document.getElementById('confirm-yes-btn');
            btn.innerText = yesText;
            btn.className = `flex-1 py-3 text-white font-bold rounded-xl shadow-lg transition ${colorClass}`;
            document.getElementById('customConfirmModal').classList.add('active');
            confirmCallback = callback;
            lucide.createIcons();
        }

        function customAlert(title, msg, type = 'info') {
            let icon = 'info'; let color = 'text-blue-500'; let bg = 'bg-blue-50'; let btnBg = 'bg-blue-600 hover:bg-blue-700 shadow-blue-200';
            if(type === 'error') { icon = 'x-circle'; color = 'text-red-500'; bg = 'bg-red-50'; btnBg = 'bg-red-600 hover:bg-red-700 shadow-red-200'; }
            if(type === 'warning') { icon = 'alert-triangle'; color = 'text-amber-500'; bg = 'bg-amber-50'; btnBg = 'bg-amber-600 hover:bg-amber-700 shadow-amber-200'; }
            if(type === 'success') { icon = 'check-circle'; color = 'text-emerald-500'; bg = 'bg-emerald-50'; btnBg = 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200'; }
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            const iconContainer = document.getElementById('confirm-icon-box');
            iconContainer.className = `w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ${bg}`;
            iconContainer.innerHTML = `<i data-lucide="${icon}" class="w-8 h-8 ${color}"></i>`;
            document.getElementById('confirm-cancel-btn').classList.add('hidden');
            const btn = document.getElementById('confirm-yes-btn');
            btn.innerText = "OK";
            btn.className = `flex-1 py-3 text-white font-bold rounded-xl shadow-lg transition ${btnBg}`;
            document.getElementById('customConfirmModal').classList.add('active');
            confirmCallback = null;
            lucide.createIcons();
        }

        function closeConfirm(val) {
            document.getElementById('customConfirmModal').classList.remove('active');
            if(val && confirmCallback) confirmCallback();
        }
        document.getElementById('confirm-yes-btn').onclick = () => closeConfirm(true);

        // Standard Actions
        function confirmLogout() { customConfirm("Logout?", "Are you sure you want to logout?", "Logout", "bg-red-600 hover:bg-red-700 shadow-red-200", () => { localStorage.removeItem('user'); window.location.href="index.html"; }); }
        function askTrash(id) { customConfirm("Move to Trash?", "This item will be moved to trash.", "Move to Trash", "bg-orange-500 hover:bg-orange-600 shadow-orange-200", () => moveToTrash(id)); }
        function askRestore(id) { customConfirm("Restore Item?", "This item will be restored to the list.", "Restore", "bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200", () => restoreItem(id)); }
        function askDeleteForever(id) { customConfirm("Delete Forever?", "This cannot be undone!", "Delete Forever", "bg-red-600 hover:bg-red-700 shadow-red-200", () => deleteForever(id)); }


        // INIT
        window.onload = async () => { 
            initProfile(); 
            await loadCategories(); 
            await loadData(); // Wait for data before checking date
            populateDropdowns(); 
            
            // Initial check for today's date on Desktop form is REMOVED to comply with "no selected auto"
            // If you want the field to be empty, the renderForms function handles it below.

            lucide.createIcons(); 
        };

        function initProfile() {
            // UPDATED: Use user.Name instead of user.Email for avatars and display
            const avatarUrl = user.FaceImageFile ? `faces/${user.FaceImageFile}` : `https://ui-avatars.com/api/?name=${user.Name}&background=random`;
            document.getElementById('header-avatar').src = avatarUrl;
            document.getElementById('menu-email').innerText = user.Name; // Display Name
            document.getElementById('menu-role').innerText = user.Role;
            document.getElementById('modal-avatar').src = avatarUrl;
            document.getElementById('modal-email-display').innerText = user.Name; // Display Name
            document.getElementById('modal-role-display').innerText = user.Role;

            if(user.Role !== 'Owner') {
                const manageBtn = document.getElementById('btn-manage-users');
                if(manageBtn) manageBtn.remove();
            } else {
                document.getElementById('btn-manage-users').classList.remove('hidden');
            }
        }

        // --- LOAD CATEGORIES + VISIBILITY ---
        async function loadCategories() {
            try {
                const res = await fetch(`${SHEETDB_URL}?sheet=Categories`);
                if(res.ok) {
                    const data = await res.json();
                    categories = data.map(item => ({ 
                        key: item.Key, 
                        label: item.Label,
                        visible: item.Visible !== 'false' 
                    }));
                    renderForms(); 
                    renderCategorySettings();
                }
            } catch (e) { console.error("Failed to load categories", e); }
        }

        // --- TOGGLE VISIBILITY FUNCTION ---
        async function toggleCategoryVisibility(index) {
            const cat = categories[index];
            const newStatus = !cat.visible;
            cat.visible = newStatus;
            renderCategorySettings(); 
            renderForms(); 
            try {
                await fetch(`${SHEETDB_URL}/Key/${cat.key}?sheet=Categories`, { 
                    method: 'PATCH', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ data: { Visible: newStatus.toString() } }) 
                });
            } catch(e) {
                console.error("Failed to save visibility", e);
                cat.visible = !newStatus;
                renderCategorySettings();
                renderForms();
                showToast("Failed to update settings", "error");
            }
        }

        function formatCurrency(amount) { return (parseFloat(amount) || 0).toLocaleString('km-KH') + ' ៛'; }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if(tabName === 'dashboard') {
                document.getElementById('view-dashboard').classList.remove('hidden');
                document.getElementById('view-report').classList.add('hidden');
                document.getElementById('mobile-dock').classList.add('hidden');
            } else {
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-report').classList.remove('hidden');
                if(window.innerWidth < 1024) document.getElementById('mobile-dock').classList.remove('hidden');
                populateYearFilter();
            }
        }

        async function loadData() {
            const list = document.getElementById('expense-list');
            list.innerHTML = '<div class="text-center py-10"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto text-indigo-500"></i><p class="text-gray-500 mt-2">Loading data...</p></div>';
            lucide.createIcons();
            try { 
                const res = await fetch(`${SHEETDB_URL}?sheet=Expenses`); 
                if (!res.ok) throw new Error("Failed to fetch");
                const rawData = await res.json();
                allExpenses = rawData.filter(item => item.ID && !isNaN(item.ID)); 
                allExpenses.sort((a,b)=>new Date(b.Date)-new Date(a.Date)); 
                applyFilters();
            } catch(e){ console.error(e); list.innerHTML = `<div class="text-center py-10 text-red-500 p-4 bg-red-50 rounded-xl border border-red-100"><p class="font-bold">Error Loading Data</p><button onclick="loadData()" class="mt-3 px-4 py-2 bg-white border border-red-200 text-red-600 rounded-lg text-sm font-medium">Retry</button></div>`; }
        }

        // --- NEW: CHECK EXISTING DATE LOGIC (UPDATED TO NAME) ---
        function checkExistingDate(dateStr, formId) {
            if (!dateStr) return;

            // 1. Find if there is an active entry for this date AND this user
            // UPDATED: Using UserName instead of UserEmail
            const existingEntry = allExpenses.find(x => x.Date === dateStr && x.Status !== 'Deleted' && x.UserName === user.Name);

            if (existingEntry) {
                // FOUND: Populate form for EDIT
                populateForm(formId, existingEntry);
                showToast("Found existing report for this date. Switched to Edit mode.", "info");
                
                // Update UI to reflect Edit Mode
                if(formId === 'desktop-form') {
                    document.getElementById('desktop-submit-btn').innerText = 'Update';
                    document.getElementById('desktop-cancel-btn').classList.remove('hidden');
                } else {
                    // Mobile doesn't usually have cancel, but logic is same
                }
            } else {
                // NOT FOUND: This is a new entry for this date
                // We need to clear previous values (ID, amounts) but KEEP the date
                
                // Get the hidden ID field to check if we were previously editing something
                const idField = document.getElementById(formId === 'mobile-form' ? 'mobile-edit-id' : 'desktop-edit-id');
                
                // Only reset if the form currently has an ID (meaning we were editing, now we are adding new)
                // OR if we just want to ensure it's clean.
                
                // 1. Clear ID
                idField.value = '';
                
                // 2. Clear Description
                const descField = document.getElementById(formId).querySelector('[name="Description"]');
                if(descField) descField.value = '';

                // 3. Clear Amounts
                categories.forEach(c => {
                    const input = document.getElementById(formId).querySelector(`[name="${c.key}"]`);
                    if(input) input.value = '';
                });

                // 4. Reset Total
                calculateTotal(formId.replace('-form', ''));

                // 5. Update Buttons to "Save"
                if(formId === 'desktop-form') {
                    document.getElementById('desktop-submit-btn').innerText = 'រក្សាទុក'; // Save
                    document.getElementById('desktop-cancel-btn').classList.add('hidden');
                }
            }
        }

        function populateDropdowns() {
            const months = ["មករា", "កុម្ភៈ", "មីនា", "មេសា", "ឧសភា", "មិថុនា", "កក្កដា", "សីហា", "កញ្ញា", "តុលា", "វិច្ឆិកា", "ធ្នូ"];
            ['d','m'].forEach(p => {
                const mSel = document.getElementById(`${p}-filter-month`);
                mSel.innerHTML = '<option value="">ទាំងអស់</option>' + months.map((m,i) => `<option value="${i}">${m}</option>`).join('');
            });
        }
        function populateYearFilter() {
            const years = [...new Set(allExpenses.map(x => x.Date.substring(0, 4)))].sort().reverse();
            ['d','m'].forEach(p => { const s = document.getElementById(`${p}-filter-year`); while(s.options.length > 1) s.remove(1); years.forEach(y => s.add(new Option(y, y))); });
        }

        function safeVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function syncAndApply(source) {
            ['day','month','year'].forEach(f => {
                const val = safeVal(`${source.charAt(0)}-filter-${f}`);
                const target = source === 'desktop' ? 'm' : 'd';
                const targetEl = document.getElementById(`${target}-filter-${f}`);
                if(targetEl) targetEl.value = val;
            });
            applyFilters();
        }

        function applyFilters() {
            const fDay = safeVal('d-filter-day');
            const fMonth = safeVal('d-filter-month');
            const fYear = safeVal('d-filter-year');
            const fDate = safeVal('d-filter-date');
            const fSearch = document.getElementById('d-search-input').value.toLowerCase();
            filteredExpenses = allExpenses.filter(x => {
                if(currentView === 'active' && x.Status === 'Deleted') return false;
                if(currentView === 'trash' && x.Status !== 'Deleted') return false;
                if (fDate && x.Date !== fDate) return false;
                if (fDay !== "" && new Date(x.Date).getDay().toString() !== fDay) return false;
                if (fMonth !== "" && new Date(x.Date).getMonth().toString() !== fMonth) return false;
                if (fYear !== "" && x.Date.substring(0,4) !== fYear) return false;
                if (fSearch && !x.Description.toLowerCase().includes(fSearch)) return false;
                return true;
            });
            renderList(filteredExpenses);
            const badge = document.getElementById('active-filter-badge');
            if(badge) badge.classList.toggle('hidden', !fDate && !fDay && !fMonth && !fYear);
            const activeAll = allExpenses.filter(x => x.Status !== 'Deleted');
            updateSummary(activeAll);
        }

        function resetFilters() {
            ['d','m'].forEach(p => { 
                if(document.getElementById(`${p}-filter-day`)) document.getElementById(`${p}-filter-day`).value='';
                if(document.getElementById(`${p}-filter-month`)) document.getElementById(`${p}-filter-month`).value=''; 
                if(document.getElementById(`${p}-filter-year`)) document.getElementById(`${p}-filter-year`).value='';
                if(document.getElementById(`${p}-filter-date`)) document.getElementById(`${p}-filter-date`).value='';
            });
            document.getElementById('d-search-input').value = '';
            applyFilters();
        }

        function viewItem(id) {
            const item = allExpenses.find(x => x.ID == id);
            if (!item) return;
            document.getElementById('detail-date').innerText = formatDateFriendly(item.Date);
            document.getElementById('detail-amount').innerText = formatCurrency(item.Amount);
            document.getElementById('detail-desc').innerText = item.Description || "No description provided.";
            // UPDATED: Show UserName
            document.getElementById('detail-user').innerHTML = `<i data-lucide="user" class="w-3"></i> ${item.UserName || 'Unknown'}`;
            document.getElementById('detail-status').innerText = item.Status;
            document.getElementById('detail-status').className = item.Status === 'Active' ? "px-2 py-1 rounded bg-emerald-100 text-emerald-700 font-bold" : "px-2 py-1 rounded bg-red-100 text-red-700 font-bold";

            const breakdown = document.getElementById('detail-breakdown');
            breakdown.innerHTML = '';
            categories.forEach(cat => {
                const val = parseFloat(item[cat.key]) || 0;
                if (val > 0) {
                    breakdown.innerHTML += `<div class="flex justify-between items-center p-2 bg-slate-50 rounded border border-slate-100"><span class="text-sm font-medium text-slate-600">${cat.label}</span><span class="text-sm font-bold text-indigo-600">${formatCurrency(val)}</span></div>`;
                }
            });
            
            const actions = document.getElementById('detail-actions');
            if(item.Status === 'Active') {
                actions.innerHTML = `
                    <button onclick="editItem('${item.ID}'); closeModal('detailModal')" class="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition">Edit</button>
                    <button onclick="askTrash('${item.ID}'); closeModal('detailModal')" class="flex-1 py-3 bg-red-50 text-red-600 font-bold rounded-xl hover:bg-red-100 transition">Trash</button>
                `;
            } else {
                actions.innerHTML = `
                    <button onclick="askRestore('${item.ID}'); closeModal('detailModal')" class="flex-1 py-3 bg-emerald-50 text-emerald-600 font-bold rounded-xl hover:bg-emerald-100 transition">Restore</button>
                    <button onclick="askDeleteForever('${item.ID}'); closeModal('detailModal')" class="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition">Delete</button>
                `;
            }
            document.getElementById('detailModal').classList.add('active');
            lucide.createIcons();
        }

        function updateSummary(data) {
            let t=0, td=0, tm=0, ty=0;
            const today=new Date().toISOString().split('T')[0], d=new Date(), m=d.getMonth(), y=d.getFullYear();
            data.forEach(x=>{
                const v=parseFloat(x.Amount)||0; t+=v;
                if(x.Date===today) td+=v;
                const xD = new Date(x.Date);
                if(xD.getMonth()===m && xD.getFullYear()===y) tm+=v;
                if(xD.getFullYear()===y) ty+=v;
            });
            document.getElementById('total-summary').innerText=formatCurrency(t);
            document.getElementById('today-summary').innerText=formatCurrency(td);
            document.getElementById('month-summary').innerText=formatCurrency(tm);
            document.getElementById('year-summary').innerText=formatCurrency(ty);
            document.getElementById('count-summary').innerText = data.length;
        }

        // --- CRUD FUNCTIONS ---
        function toggleTrashView() { 
            currentView = currentView === 'active' ? 'trash' : 'active'; 
            const btn = document.getElementById('trash-toggle-btn'); 
            const title = currentView === 'trash' ? 'ធុងសំរាម (Trash)' : 'បញ្ជីចំណាយ';
            const mobileTitle = document.getElementById('list-header-title-mobile');
            if(mobileTitle) mobileTitle.innerText = title;
            const desktopTitle = document.getElementById('list-header-title');
            if(desktopTitle) desktopTitle.innerText = title;

            if(currentView === 'trash') { 
                btn.classList.add('text-red-600','bg-red-50'); 
                btn.classList.remove('text-gray-500');
                btn.innerHTML = `<i data-lucide="arrow-left" class="w-4 h-4"></i> Back`; 
            } else { 
                btn.classList.remove('text-red-600','bg-red-50'); 
                btn.classList.add('text-gray-500');
                btn.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i> Trash`; 
            } 
            applyFilters(); 
        }

        async function moveToTrash(id) {
            await fetch(`${SHEETDB_URL}/ID/${id}?sheet=Expenses`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ data: { Status: 'Deleted' } }) });
            loadData();
            showActionToast("Moved to Trash", "View Trash", () => toggleTrashView());
        }

        async function restoreItem(id) {
            await fetch(`${SHEETDB_URL}/ID/${id}?sheet=Expenses`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ data: { Status: 'Active' } }) });
            loadData(); showToast('Restored Successfully!', 'success');
        }

        async function deleteForever(id) {
            showToast('Deleting...', 'info');
            try {
                const res = await fetch(`${SHEETDB_URL}/ID/${id}?sheet=Expenses`, { method: 'DELETE' });
                if(res.ok) { showToast('Deleted Permanently', 'success'); loadData(); } else { throw new Error("API Error"); }
            } catch(e) { console.error(e); customAlert("Error", "Could not delete item. Check connection.", "error"); }
        }

        function renderList(data) {
            const list = document.getElementById('expense-list'); list.innerHTML = '';
            if (data.length === 0) { list.innerHTML = `<div class="text-center py-10 text-slate-400"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i><p>No ${currentView} items</p></div>`; lucide.createIcons(); return; }
            
            data.forEach(item => {
                let breakdownHtml = '', itemTotal = 0;
                categories.forEach(cat => { 
                    const val = parseFloat(item[cat.key]) || 0; 
                    if (val > 0) { 
                        itemTotal += val; 
                        breakdownHtml += `<span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-600 border border-slate-200">${cat.label}: ${formatCurrency(val)}</span> `; 
                    } 
                });
                let btns = '';
                if(currentView === 'active') {
                    btns = `<button onclick="event.stopPropagation(); editItem('${item.ID}')" class="text-xs flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg font-bold border border-blue-200 hover:bg-blue-100 transition"><i data-lucide="pencil" class="w-3 h-3"></i> Edit</button><button onclick="event.stopPropagation(); askTrash('${item.ID}')" class="text-xs flex items-center gap-1 px-3 py-1.5 bg-orange-50 text-orange-600 rounded-lg font-bold border border-orange-200 hover:bg-orange-100 transition"><i data-lucide="trash-2" class="w-3 h-3"></i> Trash</button>`;
                } else {
                    btns = `<button onclick="event.stopPropagation(); askRestore('${item.ID}')" class="text-xs flex items-center gap-1 px-3 py-1.5 bg-emerald-50 text-emerald-600 rounded-lg font-bold border border-emerald-200 hover:bg-emerald-100 transition"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> Restore</button><button onclick="event.stopPropagation(); askDeleteForever('${item.ID}')" class="text-xs flex items-center gap-1 px-3 py-1.5 bg-red-50 text-red-600 rounded-lg font-bold border border-red-200 hover:bg-red-100 transition"><i data-lucide="x" class="w-3 h-3"></i> Delete</button>`;
                }
                
                list.innerHTML += `<div onclick="viewItem('${item.ID}')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-3 animate-fade-in cursor-pointer hover:bg-slate-50 transition ${currentView==='trash'?'opacity-80 bg-red-50/30':''}"><div class="flex justify-between mb-1"><div><p class="text-xs font-bold text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded-md inline-block mb-1">${formatDateFriendly(item.Date)}</p></div><p class="text-lg font-bold text-indigo-600">${formatCurrency(item.Amount||itemTotal)}</p></div><p class="text-slate-700 text-sm font-medium line-clamp-1 mb-2">${item.Description||'No Description'}</p><div class="flex flex-wrap gap-1 mt-2 border-t pt-2 border-dashed border-slate-200">${breakdownHtml}</div><div class="flex justify-end gap-2 mt-3 pt-2 border-t border-slate-50">${btns}</div></div>`;
            });
            lucide.createIcons();
        }

        // --- HELPERS ---
        function showToast(msg, type) { const d=document.createElement('div'); const color=type==='success'?'bg-green-600 border-l-4 border-green-800':(type==='info'?'bg-blue-600 border-l-4 border-blue-800':'bg-red-600 border-l-4 border-red-800'); d.className=`${color} text-white px-4 py-3 rounded-lg shadow-lg flex gap-2 pointer-events-auto toast-box`; d.innerHTML=`<i data-lucide="check-circle" class="w-4"></i> ${msg}`; document.getElementById('toast-container').appendChild(d); setTimeout(()=>d.remove(),3000); lucide.createIcons(); }
        function showActionToast(msg, actionText, callback) { const d=document.createElement('div'); d.className=`bg-slate-800 text-white px-4 py-3 rounded-lg shadow-xl flex items-center justify-between gap-4 pointer-events-auto toast-box w-full max-w-sm`; d.innerHTML=`<div class="flex items-center gap-2 text-sm font-medium"><i data-lucide="trash-2" class="w-4 h-4 text-gray-400"></i> ${msg}</div><button id="toast-action-btn" class="text-indigo-400 hover:text-white font-bold text-sm uppercase tracking-wide">${actionText}</button>`; document.getElementById('toast-container').appendChild(d); d.querySelector('#toast-action-btn').onclick=()=>{callback();d.remove();}; setTimeout(()=>{if(d.isConnected)d.remove();},5000); lucide.createIcons(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openSettingsModal() { renderCategorySettings(); document.getElementById('settingsModal').classList.add('active'); }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('active'); resetCategoryForm(); }
        
        function openMobileModal() { 
            document.getElementById('mobileModal').classList.add('active'); 
            resetForm('mobile-form'); // Reset and ensure no data is pre-filled on open
            document.querySelectorAll('.dock-icon').forEach(i => i.blur()); 
        }
        
        function closeMobileModal() { document.getElementById('mobileModal').classList.remove('active'); resetForm('mobile-form'); }
        function toggleProfileMenu() { document.getElementById('profile-menu').classList.toggle('hidden'); }
        document.addEventListener('click', e => { if(!e.target.closest('.relative')) document.getElementById('profile-menu').classList.add('hidden'); });
        function openInfoModal() { document.getElementById('infoModal').classList.add('active'); }
        function openFilterModal() { ['day','month'].forEach(f => document.getElementById(`m-filter-${f}`).value = document.getElementById(`d-filter-${f}`).value); const mY=document.getElementById('m-filter-year'), dY=document.getElementById('d-filter-year'); mY.innerHTML=dY.innerHTML; mY.value=dY.value; document.getElementById('filterModal').classList.add('active'); }
        function openExportModal() { document.getElementById('exportModal').classList.add('active'); }
        
        // --- SETTINGS & FORMS: VISIBILITY ---
        async function handleCategorySubmit(e) {
            e.preventDefault();
            const key=document.getElementById('new-cat-en').value.trim(), label=document.getElementById('new-cat-km').value.trim(), idx=parseInt(document.getElementById('edit-mode-index').value), oldKey=document.getElementById('edit-old-key').value;
            if(idx===-1 && categories.some(c=>c.key.toLowerCase()===key.toLowerCase())) { customAlert("Attention", "This category key already exists!", "warning"); return; }
            document.getElementById('settings-loading').classList.remove('hidden');
            try {
                if(idx===-1) { 
                    await callScript({ action: "ADD", key, label }); 
                    await fetch(`${SHEETDB_URL}?sheet=Categories`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ data: { Key: key, Label: label, Visible: 'true' } }) });
                } else { 
                    if(oldKey!==key || categories[idx].label!==label) {
                        await callScript({ action: "EDIT", oldKey, key, label }); 
                        await fetch(`${SHEETDB_URL}/Key/${oldKey}?sheet=Categories`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ data: { Key: key, Label: label } }) });
                    }
                }
                await loadCategories(); resetCategoryForm(); showToast('Success', 'success');
            } catch(e){ customAlert("Error", "Failed to sync category.", "error"); } finally { document.getElementById('settings-loading').classList.add('hidden'); }
        }
        async function removeCategory(i) { 
            customConfirm("Delete Category?", "Are you sure? This removes it for EVERYONE.", "Delete", "bg-red-600 hover:bg-red-700 shadow-red-200", async () => {
                document.getElementById('settings-loading').classList.remove('hidden'); 
                try { 
                    const keyToRemove = categories[i].key;
                    await callScript({ action: "DELETE_COLUMN", key: keyToRemove }); 
                    await fetch(`${SHEETDB_URL}/Key/${keyToRemove}?sheet=Categories`, { method: 'DELETE' });
                    await loadCategories(); 
                } catch(e){ customAlert("Error", "Failed to delete category.", "error"); } finally { document.getElementById('settings-loading').classList.add('hidden'); }
            });
        }

        // --- RENDER FORMS ---
        function renderForms() { 
            const gen = (cid, p) => { 
                const c = document.getElementById(cid); 
                c.innerHTML = ''; 
                if(p==='desktop') c.innerHTML += `<div class="mb-4"><label class="text-xs font-bold text-slate-500 uppercase mb-1">កាលបរិច្ឆេទ</label><input type="date" name="Date" class="w-full p-3 border rounded-xl bg-slate-50" required onchange="checkExistingDate(this.value, 'desktop-form')"></div>`; 
                if(categories.length===0) c.innerHTML=`<div class="text-center p-4 bg-amber-50 text-amber-700 text-sm rounded-xl">Please add categories in Settings.</div>`; 
                else {
                    categories.forEach(cat => { 
                        if (cat.visible !== false) { 
                            c.innerHTML+=`<div class="relative mb-3"><label class="block text-xs font-medium text-slate-600 mb-1">${cat.label}</label><div class="relative"><input type="number" name="${cat.key}" class="w-full p-3 pl-3 pr-12 border rounded-xl" placeholder="0" oninput="calculateTotal('${p}')"><span class="absolute right-4 top-3 text-slate-400 text-sm">៛</span></div></div>`;
                        }
                    }); 
                }
            }; 
            gen('desktop-dynamic-inputs', 'desktop'); 
            gen('mobile-dynamic-inputs', 'mobile'); 
        }

        // --- SETTINGS RENDER ---
        function renderCategorySettings() { 
            const l = document.getElementById('category-list'); 
            l.innerHTML = categories.length ? categories.map((c,i)=>`
                <div class="flex justify-between items-center p-3 bg-slate-50 border rounded-lg mb-2">
                    <div><p class="text-sm font-bold ${c.visible === false ? 'text-slate-400' : 'text-slate-800'}">${c.label}</p><p class="text-xs text-slate-400">${c.key}</p></div>
                    <div class="flex items-center gap-3"><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleCategoryVisibility(${i})" ${c.visible !== false ? 'checked' : ''}><div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div></label><div class="h-4 w-px bg-slate-300 mx-1"></div><button onclick="prepareEditCategory(${i})" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="removeCategory(${i})" class="p-1.5 text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash" class="w-4 h-4"></i></button></div>
                </div>
            `).join('') : '<div class="text-center py-4 text-slate-400 text-sm">No categories</div>'; 
            lucide.createIcons(); 
        }

        function calculateTotal(p) { let t=0; categories.forEach(c => { if(c.visible !== false) t += parseFloat(document.getElementById(p+'-form').querySelector(`[name="${c.key}"]`)?.value)||0; }); document.getElementById(p+'-total-display').innerText = formatCurrency(t); }
        
        function prepareEditCategory(i) { const c=categories[i]; document.getElementById('new-cat-en').value=c.key; document.getElementById('new-cat-km').value=c.label; document.getElementById('edit-mode-index').value=i; document.getElementById('edit-old-key').value=c.key; document.getElementById('form-title').innerText="Edit"; document.getElementById('save-cat-btn').innerText='Update'; document.getElementById('cancel-edit-btn').classList.remove('hidden'); }
        function resetCategoryForm() { document.getElementById('new-cat-en').value=''; document.getElementById('new-cat-km').value=''; document.getElementById('edit-mode-index').value='-1'; document.getElementById('save-cat-btn').innerHTML='<i data-lucide="plus" class="w-4 mr-1"></i> Add'; document.getElementById('cancel-edit-btn').classList.add('hidden'); document.getElementById('form-title').innerText="Add New"; }
        function resetForm(fid) { document.getElementById(fid).reset(); document.getElementById(fid.replace('-form','-total-display')).innerText='0 ៛'; if(fid==='desktop-form') { document.getElementById('desktop-edit-id').value=''; document.getElementById('desktop-submit-btn').innerText='Save'; document.getElementById('desktop-cancel-btn').classList.add('hidden'); } }
        
        // EDIT
        window.editItem = function(id) {
            const item = allExpenses.find(x => x.ID == id);
            if (!item) return;
            const fid = window.innerWidth < 1024 ? 'mobile-form' : 'desktop-form';
            if (fid === 'mobile-form') openMobileModal();
            populateForm(fid, item);
            if (fid === 'desktop-form') { document.getElementById('desktop-submit-btn').innerText = 'Update'; document.getElementById('desktop-cancel-btn').classList.remove('hidden'); }
        };

        function populateForm(fid, item) {
            const idField = document.getElementById(fid === 'mobile-form' ? 'mobile-edit-id' : 'desktop-edit-id');
            if (idField) idField.value = item.ID;
            const actualDateField = fid === 'mobile-form' ? document.getElementById('mobile-date') : document.querySelector('#desktop-form input[name="Date"]');
            if (actualDateField) actualDateField.value = item.Date;
            const descField = document.getElementById(fid).querySelector('[name="Description"]');
            if (descField) descField.value = item.Description;
            categories.forEach(c => { if (c.visible !== false) { const input = document.getElementById(fid).querySelector(`[name="${c.key}"]`); if (input) { input.value = item[c.key] || 0; } } });
            calculateTotal(fid.replace('-form', ''));
        }

        async function handleFormSubmit(e, fid) {
            e.preventDefault(); 
            if(categories.length === 0) return customAlert("Setup Required", "Please add expense categories in Settings first.", "info");
            const form = document.getElementById(fid);
            const data = new FormData(form);
            let btn;
            if (fid === 'desktop-form') { btn = document.getElementById('desktop-submit-btn'); } else { btn = document.getElementById('mobile-submit-btn'); }
            const id = data.get('ID');
            let payload = { Date: data.get('Date'), Description: data.get('Description'), ModifiedDate: new Date().toISOString() };
            let total = 0;
            categories.forEach(c => { if(c.visible !== false) { const v = parseFloat(data.get(c.key)) || 0; payload[c.key] = v; total += v; } });
            payload.Amount = total; 
            if(total === 0) return customAlert("Missing Data", "Please enter a valid amount.", "warning");
            if (btn) { btn.disabled = true; btn.innerHTML = 'Saving...'; }
            try {
                if(id) await fetch(`${SHEETDB_URL}/ID/${id}?sheet=Expenses`, {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({data:payload})});
                else { 
                    payload.ID=Date.now(); 
                    payload.Status='Active'; 
                    payload.Type='Expense'; 
                    // UPDATED: Using UserName
                    payload.UserName = user.Name; 
                    await fetch(`${SHEETDB_URL}?sheet=Expenses`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({data:payload})}); 
                }
                showToast('Saved Successfully!', 'success'); resetForm(fid); 
                if(fid === 'mobile-form') closeMobileModal(); 
                loadData();
            } catch(e){ customAlert("Error", "Something went wrong saving data.", "error"); } finally { if (btn) { btn.disabled = false; btn.innerText = 'រក្សាទុក'; } }
        }

        async function callScript(payload) { try { await fetch(APPS_SCRIPT_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) }); return true; } catch (e) { return false; } }
        
        // --- HELPER: AGGREGATE DATA FOR EXPORT ---
        function aggregateExpensesByDate(data) {
            const grouped = {};
            const activeCats = categories.filter(c => c.visible !== false);
            data.forEach(item => {
                if (!item.Date) return;
                if (!grouped[item.Date]) {
                    grouped[item.Date] = { Date: item.Date, Amount: 0 };
                    activeCats.forEach(c => grouped[item.Date][c.key] = 0);
                }
                grouped[item.Date].Amount += (parseFloat(item.Amount) || 0);
                activeCats.forEach(c => { grouped[item.Date][c.key] += (parseFloat(item[c.key]) || 0); });
            });
            return Object.values(grouped).map(g => ({ ...g })).sort((a,b) => new Date(a.Date) - new Date(b.Date));
        }

        // --- UNIFIED EXPORT LOGIC (PDF & EXCEL) ---

        function openDateSelection(type) {
            closeModal('exportModal');
            document.getElementById('dateSelectionModal').classList.add('active');
            document.getElementById('export-target-type').value = type; // Store if PDF or Excel

            // Set default values
            const today = new Date();
            document.getElementById('pdf-month-val').value = today.toISOString().slice(0, 7); 
            
            // Populate Year Dropdown
            const yearSelect = document.getElementById('pdf-year-val');
            yearSelect.innerHTML = '';
            const years = [...new Set(allExpenses.map(x => x.Date.substring(0, 4)))].sort().reverse();
            if(years.length === 0) years.push(today.getFullYear());
            years.forEach(y => yearSelect.add(new Option(y, y)));
            
            togglePDFInputs('all');
        }

        function togglePDFInputs(type) {
            // Hide all inputs first
            ['month', 'year', 'range'].forEach(t => document.getElementById(`pdf-input-${t}`).classList.add('hidden'));
            
            // Show selected
            if(type !== 'all') {
                document.getElementById(`pdf-input-${type}`).classList.remove('hidden');
            }
        }

        function handleExportConfirmation() {
            const type = document.getElementById('export-target-type').value;
            const option = document.querySelector('input[name="pdf_option"]:checked').value;
            let dataToExport = [];
            
            // Base filters: Not deleted
            let baseData = allExpenses.filter(x => x.Status !== 'Deleted');

            if (option === 'all') {
                dataToExport = baseData;
            } 
            else if (option === 'month') {
                const mVal = document.getElementById('pdf-month-val').value; 
                if(!mVal) return customAlert("Error", "Please select a month", "warning");
                dataToExport = baseData.filter(x => x.Date.startsWith(mVal));
            } 
            else if (option === 'year') {
                const yVal = document.getElementById('pdf-year-val').value;
                if(!yVal) return customAlert("Error", "Please select a year", "warning");
                dataToExport = baseData.filter(x => x.Date.startsWith(yVal));
            } 
            else if (option === 'range') {
                const sVal = document.getElementById('pdf-start-val').value;
                const eVal = document.getElementById('pdf-end-val').value;
                if(!sVal || !eVal) return customAlert("Error", "Please select start and end dates", "warning");
                dataToExport = baseData.filter(x => x.Date >= sVal && x.Date <= eVal);
            }

            if (dataToExport.length === 0) {
                return customAlert("No Data", "No records found for this selection.", "warning");
            }

            closeModal('dateSelectionModal');

            if(type === 'pdf') {
                generatePDF(dataToExport, option);
            } else {
                generateStyledExcel(dataToExport, option);
            }
        }

        // --- STYLED EXCEL GENERATION ---
        function generateStyledExcel(data, titleType) {
            showToast("Generating Excel...", "info");

            const activeCats = categories.filter(c => c.visible !== false);
            const aggregatedData = aggregateExpensesByDate(data);
            const getYearKey = (dateStr) => dateStr.substring(0, 4);

            // 1. DEFINE STYLES
            const styles = {
                header: {
                    font: { bold: true, sz: 14, color: { rgb: "FFFFFF" }, name: "Khmer OS Muol" },
                    fill: { fgColor: { rgb: "312e81" } }, // Dark Blue
                    alignment: { horizontal: "center", vertical: "center" },
                    border: { bottom: { style: "medium", color: { rgb: "000000" } } }
                },
                cell: {
                    font: { sz: 11, name: "Khmer OS Battambang" },
                    alignment: { vertical: "center" },
                    border: { bottom: { style: "thin", color: { rgb: "E2E8F0" } } }
                },
                currency: {
                    font: { sz: 11, name: "Khmer OS Battambang" },
                    alignment: { horizontal: "right", vertical: "center" },
                    border: { bottom: { style: "thin", color: { rgb: "E2E8F0" } } }
                },
                subTotal: {
                    font: { bold: true, color: { rgb: "1e40af" }, name: "Khmer OS Muol" }, // Blue Text
                    fill: { fgColor: { rgb: "e0e7ff" } }, // Light Blue Bg
                    alignment: { vertical: "center" },
                    border: { top: { style: "thin" }, bottom: { style: "thin" } }
                },
                grandTotal: {
                    font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12, name: "Khmer OS Muol" },
                    fill: { fgColor: { rgb: "1e1b4b" } }, // Very Dark Blue
                    alignment: { vertical: "center" },
                    border: { top: { style: "medium" } }
                }
            };

            // 2. BUILD DATA ROWS WITH STYLES
            let rows = [];
            let currentYearTotal = {};
            let grandTotal = {};
            activeCats.forEach(c => { currentYearTotal[c.key] = 0; grandTotal[c.key] = 0; });
            currentYearTotal.Amount = 0; grandTotal.Amount = 0;

            // -- Add Header Row --
            let headerRow = [
                { v: "Date", s: styles.header },
                ...activeCats.map(c => ({ v: c.label, s: styles.header })),
                { v: "Total", s: styles.header }
            ];
            rows.push(headerRow);

            // -- Add Data --
            for (let i = 0; i < aggregatedData.length; i++) {
                const item = aggregatedData[i];
                
                // Calculate Totals
                activeCats.forEach(c => {
                    const val = parseFloat(item[c.key]) || 0;
                    currentYearTotal[c.key] += val;
                    grandTotal[c.key] += val;
                });
                currentYearTotal.Amount += item.Amount;
                grandTotal.Amount += item.Amount;

                // Create Data Row
                let rowData = [
                    { v: item.Date, t: 's', s: styles.cell }
                ];
                activeCats.forEach(c => {
                    rowData.push({ v: (item[c.key] || 0), t: 'n', s: styles.currency, z: '#,##0 "៛"' }); // Format Number
                });
                rowData.push({ v: item.Amount, t: 'n', s: {...styles.currency, font: {bold:true, color:{rgb:"4f46e5"}}}, z: '#,##0 "៛"' });
                rows.push(rowData);

                // Check for Subtotal (Year Change)
                const nextItem = aggregatedData[i+1];
                const isLastItem = (i === aggregatedData.length - 1);
                const currentYear = getYearKey(item.Date);
                const nextYear = nextItem ? getYearKey(nextItem.Date) : null;

                if (titleType === 'all' && (isLastItem || currentYear !== nextYear)) {
                    let subRow = [
                        { v: `Total ${currentYear}`, s: styles.subTotal }
                    ];
                    activeCats.forEach(c => {
                        subRow.push({ v: currentYearTotal[c.key], t: 'n', s: {...styles.subTotal, alignment:{horizontal:"right"}}, z: '#,##0 "៛"' });
                    });
                    subRow.push({ v: currentYearTotal.Amount, t: 'n', s: {...styles.subTotal, alignment:{horizontal:"right"}}, z: '#,##0 "៛"' });
                    rows.push(subRow);
                    
                    // Reset Year Total
                    activeCats.forEach(c => currentYearTotal[c.key] = 0); currentYearTotal.Amount = 0;
                }
            }

            // -- Add Grand Total --
            let grandRow = [
                { v: "GRAND TOTAL", s: styles.grandTotal }
            ];
            activeCats.forEach(c => {
                grandRow.push({ v: grandTotal[c.key], t: 'n', s: {...styles.grandTotal, alignment:{horizontal:"right"}}, z: '#,##0 "៛"' });
            });
            grandRow.push({ v: grandTotal.Amount, t: 'n', s: {...styles.grandTotal, alignment:{horizontal:"right"}}, z: '#,##0 "៛"' });
            rows.push(grandRow);

            // 3. CREATE WORKBOOK
            const ws = XLSX.utils.aoa_to_sheet([]); // Init empty
            
            // Add data manually to support styled cells
            XLSX.utils.sheet_add_aoa(ws, rows, { origin: "A1" });

            // Set Column Widths
            const wscols = [
                { wch: 15 }, // Date
                ...activeCats.map(() => ({ wch: 18 })), // Cats
                { wch: 20 } // Total
            ];
            ws['!cols'] = wscols;

            // Set Row Height for Header
            if(!ws['!rows']) ws['!rows'] = [];
            ws['!rows'][0] = { hpt: 30 }; // Header Height

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Expenses");

            // 4. DOWNLOAD
            XLSX.writeFile(wb, `Expense_Report_${titleType}_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showToast("Success!", "success");
        }

        function generatePDF(data, titleType) {
            showToast("Generating PDF...", "info");

            // --- 1. CONFIGURATION ---
            const MAX_PAGE_HEIGHT = 780; 
            const ROW_HEIGHT = 42;       
            const HEADER_HEIGHT = 130;   
            const TABLE_HEADER_HEIGHT = 45; 
            const FOOTER_HEIGHT = 180;   
            const SUMMARY_HEIGHT = 140;  

            // --- 2. PREPARE DATA ---
            const activeCats = categories.filter(c => c.visible !== false);
            const aggregatedData = aggregateExpensesByDate(data);
            
            // --- CALCULATE COLUMN WIDTHS ---
            const dateColWidth = "12%";
            const totalColWidth = "13%";
            const catColWidth = (75 / (activeCats.length || 1)) + "%";

            const getYearKey = (dateStr) => dateStr.substring(0, 4);
            let flatData = []; 
            let currentYearTotal = {};
            let grandTotal = {};
            
            activeCats.forEach(c => { currentYearTotal[c.key]=0; grandTotal[c.key]=0; });
            currentYearTotal.Amount = 0; grandTotal.Amount = 0;

            for (let i = 0; i < aggregatedData.length; i++) {
                const item = aggregatedData[i];
                flatData.push({ type: 'data', ...item });

                activeCats.forEach(c => {
                    const val = parseFloat(item[c.key]) || 0;
                    currentYearTotal[c.key] += val; 
                    grandTotal[c.key] += val;
                });
                currentYearTotal.Amount += item.Amount; 
                grandTotal.Amount += item.Amount;

                const nextItem = aggregatedData[i+1];
                const isLastItem = (i === aggregatedData.length - 1);
                const currentYear = getYearKey(item.Date);
                const nextYear = nextItem ? getYearKey(nextItem.Date) : null;

                if (titleType === 'all' && (isLastItem || currentYear !== nextYear)) {
                    flatData.push({ type: 'year_total', label: `សរុបប្រចាំឆ្នាំ ${currentYear}`, totals: {...currentYearTotal} });
                    activeCats.forEach(c => currentYearTotal[c.key] = 0); currentYearTotal.Amount = 0;
                }
            }
            flatData.push({ type: 'grand_total', totals: grandTotal });

            // --- 3. SMART PAGINATION ---
            let pages = [];
            let currentPageRows = [];
            let currentHeight = 0;

            currentHeight = HEADER_HEIGHT + SUMMARY_HEIGHT + TABLE_HEADER_HEIGHT;

            for (let i = 0; i < flatData.length; i++) {
                const row = flatData[i];
                if (currentHeight + ROW_HEIGHT > MAX_PAGE_HEIGHT) {
                    pages.push(currentPageRows); 
                    currentPageRows = []; 
                    currentHeight = HEADER_HEIGHT + TABLE_HEADER_HEIGHT; 
                }
                currentPageRows.push(row);
                currentHeight += ROW_HEIGHT;
            }

            // --- 4. ORPHAN LOGIC ---
            if (currentHeight + FOOTER_HEIGHT > MAX_PAGE_HEIGHT) {
                let rowsToMove = [];
                if (currentPageRows.length > 2) {
                    rowsToMove = currentPageRows.splice(-2); 
                } else if (currentPageRows.length > 0) {
                     rowsToMove = currentPageRows.splice(-1);
                }
                pages.push(currentPageRows);
                pages.push(rowsToMove); 
            } else {
                pages.push(currentPageRows);
            }

            // --- 5. RENDER HTML ---
            let fullHTML = `<div style="font-family: 'Khmer OS Battambang', sans-serif; color: #1e293b; background: white; width: 100%;">`;

            for (let i = 0; i < pages.length; i++) {
                const pageRows = pages[i];
                const breakStyle = i > 0 ? 'page-break-before: always;' : '';
                const isFirstPage = i === 0;
                const isLastPage = i === pages.length - 1; 

                fullHTML += `<div style="${breakStyle} padding: 20px 30px; height: 100%; box-sizing: border-box; position: relative;">`;

                // HEADER
                fullHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #312e81;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <img src="${LOGO_BASE64}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #e0e7ff;">
                            <div>
                                <h1 style="font-family: 'Khmer OS Muol'; color: #312e81; font-size: 20px; margin: 0; line-height: 1.2;">Expense Manager Pro</h1>
                                <p style="font-size: 10px; color: #6b7280; margin: 2px 0 0 0; font-weight: 600; letter-spacing: 0.5px;">OFFICIAL FINANCIAL REPORT</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                             <div style="background: #f1f5f9; padding: 6px 12px; border-radius: 6px; display:inline-block; margin-bottom: 4px;">
                                <p style="font-size: 9px; color: #64748b; font-weight: bold; text-transform: uppercase;">Generated On</p>
                                <p style="font-size: 11px; font-weight: bold; color: #0f172a;">${new Date().toLocaleDateString('en-GB')}</p>
                            </div>
                            <p style="font-size: 10px; color: #4b5563;">User: <span style="font-weight: bold; color: #4f46e5;">${user.Name}</span></p>
                             <p style="font-size: 9px; color: #94a3b8;">Page ${i + 1} of ${pages.length}</p>
                        </div>
                    </div>`;

                // SUMMARY CARDS (Page 1 Only)
                if (isFirstPage) {
                    fullHTML += `
                    <div style="display: flex; gap: 15px; margin-bottom: 25px;">
                        <div style="flex: 1; padding: 12px 16px; border-radius: 10px; background-color: #312e81; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                             <p style="font-size: 9px; font-weight: bold; font-family: 'Khmer OS Battambang'; opacity: 0.8; margin-bottom: 4px; text-transform: uppercase;">សរុបរួម (GRAND TOTAL)</p>
                             <p style="font-size: 20px; font-weight: bold; letter-spacing: -0.5px;">${grandTotal.Amount.toLocaleString('en-US')} ៛</p>
                        </div>
                         <div style="flex: 1; padding: 12px 16px; border-radius: 10px; background: #ffffff; border: 1px solid #cbd5e1; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);">
                             <p style="font-size: 9px; font-weight: bold; color: #64748b; margin-bottom: 4px; font-family: 'Khmer OS Battambang'; text-transform: uppercase;">ចន្លោះកាលបរិច្ឆេទ (RANGE)</p>
                             <div style="display:flex; align-items:center; gap: 8px;">
                                <span style="font-size: 13px; font-weight: bold; color: #334155;">${formatDateMinimal(aggregatedData[0].Date)}</span>
                                <span style="color:#94a3b8;">➜</span>
                                <span style="font-size: 13px; font-weight: bold; color: #334155;">${formatDateMinimal(aggregatedData[aggregatedData.length-1].Date)}</span>
                             </div>
                        </div>
                    </div>
                    `;
                }

                // TABLE
                if (pageRows.length > 0) {
                    fullHTML += `
                        <table style="width: 100%; table-layout: fixed; border-collapse: collapse; font-size: 9px; margin-bottom: 10px;">
                            <thead>
                                <tr style="background-color: #f8fafc; border-bottom: 2px solid #334155; height: 40px;">
                                    <th style="vertical-align: middle; padding: 0 8px; text-align: left; font-family: 'Khmer OS Muol'; width: ${dateColWidth}; color: #334155;">កាលបរិច្ឆេទ</th>
                                    ${activeCats.map(c => `<th style="vertical-align: middle; padding: 0 8px; text-align: right; font-family: 'Khmer OS Muol'; width: ${catColWidth}; color: #334155;">${c.label}</th>`).join('')}
                                    <th style="vertical-align: middle; padding: 0 8px; text-align: right; font-family: 'Khmer OS Muol'; width: ${totalColWidth}; color: #312e81; background-color: #f1f5f9;">សរុប</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    pageRows.forEach((row, idx) => {
                        let bgStyle = (idx % 2 === 0) ? 'background-color: #ffffff;' : 'background-color: #f8fafc;';
                        let rowStyle = `height: ${ROW_HEIGHT}px; vertical-align: middle;`;
                        let borderStyle = 'border-bottom: 1px solid #e2e8f0;';
                        let cellStyle = `${rowStyle} padding: 0 8px; text-align: right; color: #475569; ${borderStyle}`;
                        let labelStyle = `${rowStyle} padding: 0 8px; text-align: left; font-weight: 500; color: #334155; ${borderStyle}`;

                        if (row.type === 'data') {
                            fullHTML += `<tr style="${bgStyle}"><td style="${labelStyle} overflow: hidden; white-space: nowrap;">${formatDateMinimal(row.Date)}</td>`;
                            activeCats.forEach(c => {
                                const val = parseFloat(row[c.key]) || 0;
                                fullHTML += `<td style="${cellStyle}">${val > 0 ? val.toLocaleString('en-US') + ' ៛' : '<span style="color:#cbd5e1;">-</span>'}</td>`;
                            });
                            fullHTML += `<td style="${cellStyle} font-weight: bold; color: #4f46e5; background-color: ${idx % 2 === 0 ? '#f5f3ff' : '#eef2ff'};">${row.Amount.toLocaleString('en-US')} ៛</td></tr>`;
                        } 
                        else if (row.type === 'year_total') {
                            fullHTML += `<tr style="background-color: #e0e7ff; border-top: 1px solid #818cf8;"><td style="${labelStyle} font-family: 'Khmer OS Muol'; color: #1e40af; padding-left: 15px;">${row.label}</td>`;
                            activeCats.forEach(c => {
                                fullHTML += `<td style="${cellStyle} font-weight: bold; color: #1e40af;">${row.totals[c.key] > 0 ? row.totals[c.key].toLocaleString('en-US') + ' ៛' : '-'}</td>`;
                            });
                            fullHTML += `<td style="${cellStyle} font-weight: bold; color: #1e40af;">${row.totals.Amount.toLocaleString('en-US')} ៛</td></tr>`;
                        }
                        else if (row.type === 'grand_total') {
                             fullHTML += `<tr style="background-color: #1e1b4b; color: white;">
                                <td style="${rowStyle} padding: 0 8px; text-align: center; font-family: 'Khmer OS Muol'; border:none;">សរុបរួម</td>`;
                            activeCats.forEach(c => {
                                fullHTML += `<td style="${rowStyle} padding: 0 8px; text-align: right; border:none; font-weight:bold;">${row.totals[c.key].toLocaleString('en-US')} ៛</td>`;
                            });
                            fullHTML += `<td style="${rowStyle} padding: 0 8px; text-align: right; font-size: 11px; border:none; font-weight:bold; background-color:#312e81;">${row.totals.Amount.toLocaleString('en-US')} ៛</td></tr>`;
                        }
                    });
                    fullHTML += `</tbody></table>`;
                }

                // SIGNATURE FOOTER (Only on Last Page)
                if (isLastPage) {
                    const footerDates = getKhmerFooterDates(); 
                    fullHTML += `
                        <div style="margin-top: 40px; display: flex; justify-content: space-between; font-family: 'Khmer OS Battambang'; color: #334155;">
                            
                            <div style="text-align: center; width: 40%; padding-top: 150px;">
                                <p style="font-weight: bold; font-size: 11px; margin-bottom: 60px;">អ្នកត្រួតពិនិត្យ (Approved By)</p>
                                <div style="border-bottom: 1px solid #94a3b8; width: 140px; margin: 0 auto;"></div>
                            </div>
                            
                            <div style="text-align: center; width: 40%;">
                                <p style="font-size: 11px; margin-bottom: 4px;">${footerDates.lunar}</p>
                                <p style="font-size: 11px; margin-bottom: 15px; font-weight: 600;">${footerDates.gregorian}</p>
                                <p style="font-weight: bold; font-size: 11px; margin-bottom: 60px;">អ្នកធ្វើរបាយការណ៍ (Prepared By)</p>
                                <div style="border-bottom: 1px solid #94a3b8; width: 140px; margin: 0 auto;"></div>
                                <p style="font-size: 10px; margin-top: 8px; font-weight:bold; color: #475569;">${user.Name}</p>
                            </div>
                        </div>
                    `;
                }
                fullHTML += `</div>`; 
            }
            fullHTML += `</div>`; 

            const element = document.createElement('div');
            element.innerHTML = fullHTML;
            document.body.appendChild(element);

            const opt = {
                margin:       0, 
                filename:     `Expense_Report_${titleType}_${new Date().toISOString().split('T')[0]}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, letterRendering: true, scrollY: 0 }, 
                jsPDF:        { unit: 'pt', format: 'a4', orientation: 'landscape' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                document.body.removeChild(element);
                showToast("ជោគជ័យ!", "success");
            });
        }
    </script>
</body>
</html>
