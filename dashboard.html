<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ - á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™á‚áŸ’ášá¿á„á‘áŸáŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Khmer+OS+Battambang:wght@400;600;700&display=swap');
        body {
            font-family: 'Khmer OS Battambang', sans-serif;
            min-height: 100vh;
            background-color: #f7f9fc; 
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 999; backdrop-filter: blur(4px); transition: opacity 0.3s ease; }
        .modal.active { display:flex; }
        .card-shadow-lg { box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05), 0 5px 15px rgba(0, 0, 0, 0.03); }
        .dropdown { position: relative; }
        .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; min-width: 240px; background-color: white; border-radius: 12px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); z-index: 100; margin-top: 12px; transform: translateY(-10px); opacity: 0; transition: all 0.2s ease-out; }
        .dropdown-menu.active { display: block; transform: translateY(0); opacity: 1; }
        
        .expense-item { 
            transition: all 0.3s ease; 
            border: 1px solid #e2e8f0; 
            background: #ffffff; 
            border-left: 6px solid; 
        }
        .expense-item:hover { 
            cursor: pointer; 
            transform: translateY(-3px); 
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12); 
            border-color: #93c5fd; 
        }

        #fab-add-btn { position: fixed; bottom: 24px; right: 24px; z-index: 50; width: 64px; height: 64px; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3); }
        @media(max-width:1023px){ #fab-add-btn{ display: none; } /* Controlled by JS showView for mobile */ #mobileFormModal .modal-content-mobile { width: 95%; max-width: 480px; margin: 10px; } }
        
        #main-expense-form-container { display: none; }
        @media (min-width: 1024px) { #main-expense-form-container { display: block !important; } #mobileFormModal { display: none !important; } }
        
        /* Avatar Styles */
        .avatar-initials {
            width: 40px; height: 40px; border-radius: 50%; 
            background-color: #6366f1; color: white; 
            font-size: 16px; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        .avatar-image { 
            background-color: transparent !important;
            color: transparent !important;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .confirm-modal-content { animation: fadeInScale 0.3s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .view-content.hidden { display: none !important; }
        .view-content.active { display: block; }

        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; background-color: #ffffff !important; }
            .card-shadow-lg { box-shadow: none !important; border: 1px solid #ccc; }
            .hide-on-print { display: none !important; }
            .expense-item { page-break-inside: avoid; border: 1px solid #eee; margin-bottom: 5px !important; }
            header, #fab-add-btn, .item-actions, #main-expense-form-container { display: none !important; }
            #operation-list-view { padding: 0 !important; }
            #expense-list { max-height: unset !important; overflow-y: visible !important; }
        }
    </style>
</head>
<body>
    
    <div id="toast-container" class="fixed top-4 right-4 z-[1000] space-y-3 pointer-events-none"></div>
    <div id="customConfirmModal" class="modal">
        <div class="confirm-modal-content bg-white rounded-2xl p-8 w-full max-w-sm relative shadow-2xl">
            <div id="confirm-icon-box" class="w-12 h-12 rounded-full mx-auto mb-4 flex items-center justify-center text-white bg-red-100">
                   <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
            </div>
            <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-2 text-center">áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠá‘áŸ?</h3>
            <p id="confirm-message" class="text-gray-600 mb-6 text-center text-sm">á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá“áŸáŸ‡á˜á·á“á¢á¶á…ááŸ’ášá›á”áŸ‹á€áŸ’ášáŸ„á™á”á¶á“á‘áŸáŸ”</p>
            
            <div class="flex justify-center space-x-4">
                <button type="button" onclick="resolveCustomConfirm(false)" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”áŸ„áŸ‡á”á„áŸ‹</button>
                <button type="button" id="confirm-action-btn" onclick="resolveCustomConfirm(true)" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition">á™á›áŸ‹á–áŸ’ášá˜</button>
            </div>
        </div>
    </div>
    
    <header class="bg-white shadow-lg sticky top-0 z-50 border-b border-gray-200">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center px-4">
            
            <div class="flex justify-between w-full md:w-auto items-center py-4">
                <h1 class="text-xl sm:text-3xl font-bold text-indigo-700 flex items-center">
                    <i data-lucide="wallet" class="w-6 h-6 sm:w-7 sm:h-7 mr-2 sm:mr-3 text-indigo-500"></i>
                    á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™á‚áŸ’ášá¿á„á‘áŸáŸ
                </h1>
                
                <div class="dropdown md:hidden">
                    <button onclick="openProfileModal(); return false;" class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-semibold hover:bg-indigo-600 transition duration-150 relative ring-2 ring-indigo-300 ring-offset-2">
                        <div id="user-avatar-initials-mobile" class="avatar-initials w-full h-full text-sm">...</div>
                    </button>
                </div>
            </div>

            <nav class="flex-1 overflow-x-auto w-full md:w-auto custom-scrollbar md:pb-0" style="scrollbar-width: none; -ms-overflow-style: none;">
                <ul class="flex space-x-6 whitespace-nowrap border-t md:border-t-0 pt-3 md:pt-0">
                    <li onclick="showView('dashboard')" id="nav-dashboard" class="nav-item pb-3 border-b-4 border-indigo-600 text-indigo-600 font-bold flex items-center cursor-pointer">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 mr-1"></i> á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„
                    </li>
                    <li onclick="showView('operation')" id="nav-operation" class="nav-item pb-3 border-b-4 border-transparent text-gray-600 hover:border-indigo-100 hover:text-indigo-500 transition cursor-pointer flex items-center">
                        <i data-lucide="list-ordered" class="w-4 h-4 mr-1"></i> á”á‰áŸ’á‡á¸á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá…áŸ†áá¶á™
                    </li>
                    <li onclick="window.location.href='user.html'" id="user-management-tab" class="hidden pb-3 border-b-4 border-transparent text-gray-600 hover:border-purple-100 hover:text-purple-500 transition cursor-pointer flex items-center">
                        <i data-lucide="users" class="w-4 h-4 mr-1"></i> á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¢áŸ’á“á€á”áŸ’ášá¾
                    </li>
                </ul>
            </nav>
            
            <div class="dropdown hidden md:block pl-4 py-3">
                <button onclick="openProfileModal(); return false;" class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-semibold hover:bg-indigo-600 transition duration-150 relative ring-2 ring-indigo-300 ring-offset-2">
                    <div id="user-avatar-initials-desktop" class="avatar-initials w-full h-full text-sm">...</div>
                </button>
            </div>
        </div>
    </header>

    <main id="main-content-container" class="max-w-7xl mx-auto p-4 md:p-8">
        
        <div id="dashboard-view" class="view-content active">
            <h2 class="text-3xl font-bold text-gray-700 mb-6 flex items-center"><i data-lucide="layout-dashboard" class="w-6 h-6 mr-2 text-indigo-500"></i> á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„áŸá„áŸ’ááŸá”</h2>
            
            <section class="mb-8">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-red-600 hover:shadow-xl transition transform hover:scale-[1.01]">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="receipt" class="w-4 h-4 mr-2 text-red-600"></i> á…áŸ†áá¶á™áŸášá»á”ášá½á˜</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-700 truncate" id="total-expense-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-red-500 hover:shadow-xl transition transform hover:scale-[1.01]">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="calendar" class="w-4 h-4 mr-2 text-red-500"></i> á…áŸ†áá¶á™á”áŸ’ášá…á¶áŸ†ááŸ‚</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-600 truncate" id="monthly-expense-summary">0 áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-orange-500 hover:shadow-xl transition transform hover:scale-[1.01]">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="utensils" class="w-4 h-4 mr-2 text-orange-500"></i> áŸá¶á…áŸ‹áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-orange-600 truncate" id="meat-total-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-green-500 hover:shadow-xl transition transform hover:scale-[1.01]">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="leaf" class="w-4 h-4 mr-2 text-green-500"></i> á”á“áŸ’á›áŸ‚áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-green-600 truncate" id="vegetable-total-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-yellow-500 hover:shadow-xl transition transform hover:scale-[1.01] mt-4 lg:mt-0">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="apple" class="w-4 h-4 mr-2 text-yellow-500"></i> á•áŸ’á›áŸ‚áˆá¾áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-yellow-600 truncate" id="fruit-total-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-red-300 hover:shadow-xl transition transform hover:scale-[1.01] mt-4 lg:mt-0">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="calendar-check" class="w-4 h-4 mr-2 text-red-300"></i> á…áŸ†áá¶á™ááŸ’á„áŸƒá“áŸáŸ‡</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-500 truncate" id="today-expense-summary">0 áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-gray-400 hover:shadow-xl transition transform hover:scale-[1.01] mt-4 lg:mt-0">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="hash" class="w-4 h-4 mr-2 text-gray-500"></i> á…áŸ†á“á½á“á€áŸ†áááŸ‹ááŸ’ášá¶</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-gray-700" id="total-count-summary">-- á€áŸ†áááŸ‹ááŸ’ášá¶</p>
                    </div>
                    <div class="lg:col-span-1 hidden lg:block mt-4 lg:mt-0"></div> 
                </div>
            </section>
        
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                
                <section id="main-expense-form-container" class="lg:col-span-1 bg-white p-6 rounded-2xl card-shadow-lg h-fit lg:sticky lg:top-24 border border-gray-100">
                    <h2 class="text-2xl font-bold mb-6 text-indigo-600 border-b pb-3" id="main-form-title">â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸</h2>
                    <form id="expense-form" class="space-y-4"></form>
                </section>
                
                <section class="lg:col-span-3">
                    <div class="bg-white p-6 rounded-2xl card-shadow-lg h-full flex items-center justify-center border border-gray-100">
                        <div class="text-center p-8">
                            <i data-lucide="arrow-left-circle" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-700">áŸá¼á˜á”áŸ’ášá¾á‘á˜áŸ’ášá„áŸ‹áá¶á„á†áŸ’áœáŸá„áŠá¾á˜áŸ’á”á¸á”á‰áŸ’á…á¼á›á‘á·á“áŸ’á“á“áŸá™</h3>
                            <p class="text-gray-500 mt-2">á˜á¾á›á”á‰áŸ’á‡á¸á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá–áŸá‰á›áŸá‰áŠáŸ„á™á…á»á…á›á¾ Tab **"á”á‰áŸ’á‡á¸á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá…áŸ†áá¶á™"** á“áŸ…áá¶á„á›á¾áŸ”</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <div id="operation-view" class="view-content hidden">
            <section id="data-view-section" class="bg-white p-4 sm:p-6 rounded-2xl card-shadow-lg border border-gray-100">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-2">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-700 mb-2 sm:mb-0 flex items-center">
                        <i data-lucide="list-ordered" class="w-6 h-6 mr-2 text-indigo-500"></i> á”á‰áŸ’á‡á¸á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá…áŸ†áá¶á™
                    </h2>
                    <div class="flex space-x-3">
                        <button onclick="openFormModal();" class="bg-indigo-600 text-white hover:bg-indigo-700 px-4 py-2 rounded-lg transition flex items-center font-semibold text-sm shadow-md md:hidden">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i> á”á“áŸ’ááŸ‚á˜á…áŸ†áá¶á™
                        </button>
                        <button onclick="switchView('trash')" id="trash-btn" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg transition flex items-center font-semibold text-sm shadow-sm">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> á€áŸ†áááŸ‹ááŸ’ášá¶áŠáŸ‚á›á”á¶á“á›á»á”
                        </button>
                    </div>
                </div>

                <div class="mb-6 p-4 border rounded-xl bg-indigo-50 border-indigo-200 shadow-inner">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="col-span-1">
                            <label for="filter-day-of-week" class="block text-xs font-medium text-indigo-700 mb-1">ááŸ’ášá„áá¶á˜ááŸ’á„áŸƒ:</label>
                            <select id="filter-day-of-week" class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()"></select>
                        </div>
                        <div class="col-span-1">
                            <label for="filter-today" class="block text-xs font-medium text-indigo-700 mb-1">ááŸ’ášá„áá¶á˜ááŸ’á„áŸƒá‡á¶á€áŸ‹á›á¶á€áŸ‹:</label>
                            <select id="filter-today" class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()">
                                <option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
                                <option value="today">ááŸ’á„áŸƒá“áŸáŸ‡</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label for="filter-month" class="block text-xs font-medium text-indigo-700 mb-1">ááŸ’ášá„áá¶á˜ááŸ‚:</label>
                            <select id="filter-month" class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()"></select>
                        </div>
                        <div class="col-span-1">
                             <label for="filter-year" class="block text-xs font-medium text-indigo-700 mb-1">ááŸ’ášá„áá¶á˜á†áŸ’á“á¶áŸ†:</label>
                            <select id="filter-year" class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()"></select>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label for="search-input" class="block text-xs font-medium text-indigo-700 mb-1">áŸáŸ’áœáŸ‚á„ášá€:</label>
                             <input type="text" id="search-input" oninput="filterRecords()" placeholder="á§. á‘á·á‰á˜áŸ’á á¼á”" class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap justify-end gap-3 border-t border-indigo-300 pt-3 mt-3">
                        <button onclick="exportData('pdf')" class="bg-red-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-red-700 transition text-sm font-semibold shadow-md">
                            <i data-lucide="file-text" class="w-4 h-4 mr-1"></i> á‘á¶á‰á™á€ PDF
                        </button>
                        <button onclick="exportData('excel')" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-green-700 transition text-sm font-semibold shadow-md">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-1"></i> á‘á¶á‰á™á€ Excel
                        </button>
                    </div>
                </div>

                <div id="expense-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar">
                    <p class="text-center text-gray-500 py-10">á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</p>
                </div>
            </section>
        </div>

    </main>
    
    <button id="fab-add-btn" onclick="openFormModal()" class="bg-indigo-600 text-white transition hover:bg-indigo-700 ring-4 ring-indigo-300 ring-offset-2">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>
    
    <div id="profileModal" class="modal">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md relative shadow-2xl">
            <h3 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2">á–áŸááŸŒá˜á¶á“á‚áá“á¸</h3>
            
            <div class="space-y-4">
                <div class="p-3 bg-gray-50 rounded-lg border flex items-center space-x-3">
                    <div id="modal-profile-avatar" class="avatar-initials w-12 h-12 text-lg">...</div> 
                    <div>
                        <label class="block text-sm font-medium text-gray-500">á¢áŸŠá¸á˜áŸ‰áŸ‚á›</label>
                        <p class="font-semibold text-gray-800" id="modal-profile-email">N/A</p>
                    </div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <label class="block text-sm font-medium text-gray-500">áá½á“á¶á‘á¸</label>
                    <p class="font-semibold text-indigo-700" id="modal-profile-role">N/A</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
                <button type="button" onclick="closeProfileModal()" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”á·á‘</button>
                <button type="button" onclick="customLogout()" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition flex items-center">
                    <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> á…á¶á€á…áŸá‰
                </button>
            </div>
            
            <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>
    
    <div id="detailModal" class="modal">
        <div class="bg-white rounded-2xl p-8 w-full max-w-lg relative shadow-2xl transform transition-all">
            <h3 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2 flex items-center">
                <i data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-gray-500"></i> á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·áá€áŸ†áááŸ‹ááŸ’ášá¶
            </h3>
            
            <div class="space-y-4 text-gray-700">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-1"></i> á€á¶á›á”ášá·á…áŸ’á†áŸá‘</label>
                        <p class="font-semibold text-base" id="detail-date">N/A</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="tag" class="w-4 h-4 mr-1"></i> á”áŸ’ášá—áŸá‘á”áŸ’ášáá·á”ááŸ’áá·á€á¶áš</label>
                        <p class="font-semibold text-base text-red-600" id="detail-type">á…áŸ†áá¶á™ ğŸ“‰</p>
                    </div>
                </div>
                
                <div class="p-4 bg-red-50 rounded-xl border border-red-200 shadow-inner">
                    <label class="block text-sm font-medium text-red-700">á…áŸ†á“á½á“á”áŸ’ášá¶á€áŸ‹áŸášá»á” (Amount)</label>
                    <p class="text-3xl font-extrabold mt-1 text-red-600" id="detail-amount">-- áŸ›</p>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="p-3 bg-white rounded-lg border shadow-sm">
                        <label class="block text-xs font-medium text-gray-500 flex items-center"><i data-lucide="utensils" class="w-3 h-3 mr-1 text-orange-500"></i> áŸá¶á…áŸ‹</label>
                        <p class="font-semibold text-base text-orange-600" id="detail-meat">0 áŸ›</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg border shadow-sm">
                        <label class="block text-xs font-medium text-gray-500 flex items-center"><i data-lucide="leaf" class="w-3 h-3 mr-1 text-green-500"></i> á”á“áŸ’á›áŸ‚</label>
                        <p class="font-semibold text-base text-green-600" id="detail-vegetable">0 áŸ›</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg border shadow-sm">
                        <label class="block text-xs font-medium text-gray-500 flex items-center"><i data-lucide="apple" class="w-3 h-3 mr-1 text-yellow-500"></i> á•áŸ’á›áŸ‚áˆá¾</label>
                        <p class="font-semibold text-base text-yellow-600" id="detail-fruit">0 áŸ›</p>
                    </div>
                </div>
                
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="align-left" class="w-4 h-4 mr-1"></i> á–á·á–ááŸŒá“á¶á›á˜áŸ’á¢á·á</label>
                    <p id="detail-desc" class="whitespace-pre-wrap text-sm">N/A</p>
                </div>
                
                <div class="text-xs text-gray-500 pt-3 flex justify-between">
                    <p>á€áŸ‚á”áŸ’ášáŸ‚á…á»á„á€áŸ’ášáŸ„á™: <span id="detail-modified">N/A</span></p>
                    <p>áŸáŸ’áá¶á“á—á¶á–: <span id="detail-status" class="font-semibold">N/A</span></p>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
                <button type="button" onclick="editExpense(activeDetailRecord.ID, true);" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition flex items-center shadow-md">
                    <i data-lucide="pencil" class="w-5 h-5 mr-2"></i> á€áŸ‚á”áŸ’ášáŸ‚
                </button>
                <button type="button" onclick="closeDetailModal()" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”á·á‘</button>
            </div>
            
            <button onclick="closeDetailModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>
    
    <div id="mobileFormModal" class="modal">
        <div class="modal-content-mobile bg-white rounded-2xl p-6 w-full relative shadow-2xl">
            <h3 class="text-2xl font-bold text-indigo-600 mb-6 border-b pb-2" id="mobile-form-title">â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸</h3>
            <form id="mobile-expense-form" class="space-y-4"></form>
            <button onclick="closeFormModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>
    
    <div id="form-template" style="display: none;">
        <input type="hidden" id="record-id" value="">
        
        <label for="date" class="block text-sm font-semibold text-gray-700">á€á¶á›á”ášá·á…áŸ’á†áŸá‘</label>
        <input id="date" type="date" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-600 focus:border-indigo-600 transition" required>
        
        <div class="border p-4 rounded-xl bg-gray-50 space-y-3">
            <label class="block text-sm font-semibold text-gray-800 mb-2">á…áŸ†á“á½á“á”áŸ’ášá¶á€áŸ‹áŸášá»á” (Amount)</label>
            <input id="amount-summary" type="text" class="w-full p-3 text-2xl font-extrabold text-red-600 bg-white border border-red-300 rounded-xl text-center" value="0 áŸ›" readonly>
            <input type="hidden" id="amount" value="0"> 
            
            <div class="grid grid-cols-3 gap-3">
                <div>
                    <label for="meat" class="block text-xs font-medium text-gray-600 mb-1">áŸá¶á…áŸ‹ (áŸ›)</label>
                    <input id="meat" type="number" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-orange-600 focus:border-orange-600 transition expense-input" placeholder="0" min="0">
                </div>
                <div>
                    <label for="vegetable" class="block text-xs font-medium text-gray-600 mb-1">á”á“áŸ’á›áŸ‚ (áŸ›)</label>
                    <input id="vegetable" type="number" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-600 focus:border-green-600 transition expense-input" placeholder="0" min="0">
                </div>
                <div>
                    <label for="fruit" class="block text-xs font-medium text-gray-600 mb-1">á•áŸ’á›áŸ‚áˆá¾ (áŸ›)</label>
                    <input id="fruit" type="number" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-yellow-600 focus:border-yellow-600 transition expense-input" placeholder="0" min="0">
                </div>
            </div>
        </div>
        
        <input id="category" type="hidden" value="Grocery"> 
        <input id="type" type="hidden" value="Expense"> 
        
        <label for="desc" class="block text-sm font-semibold text-gray-700">á–á·á–ááŸŒá“á¶á›á˜áŸ’á¢á·á (á”á“áŸ’ááŸ‚á˜)</label>
        <textarea id="desc" rows="3" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-600 focus:border-indigo-600 transition" placeholder="á…áŸ†áá¶á™á›á¾á¢áŸ’áœá¸ááŸ’á›áŸ‡..."></textarea>
        
        <button type="submit" id="submit-btn" class="w-full bg-green-600 text-white p-3 rounded-xl font-semibold hover:bg-green-700 transition duration-150 flex items-center justify-center shadow-lg mt-6">
            <i data-lucide="plus" class="w-5 h-5 mr-1"></i> á”á“áŸ’ááŸ‚á˜á€áŸ†áááŸ‹ááŸ’ášá¶
        </button>
        
        <button type="button" id="cancel-btn" onclick="resetForm()" class="w-full bg-gray-300 text-gray-700 p-3 rounded-xl font-semibold hover:bg-gray-400 transition duration-150 hidden mt-2">
            <i data-lucide="x" class="w-5 h-5 mr-1"></i> á”áŸ„áŸ‡á”á„áŸ‹á€á¶ášá€áŸ‚á”áŸ’ášáŸ‚
        </button>
    </div>


    <script src="config.js"></script>
    <script>
        // --- GLOBAL STATE ---
        const user = JSON.parse(localStorage.getItem("user"));
        let allExpenses = [];
        let currentView = 'active'; 
        let editingID = null;
        let activeDetailRecord = null;
        let customConfirmResolver; 
        let activeFormElement = null; 
        
        // --- HELPER ARRAYS ---
        const MONTH_NAMES = [
            "á‘á¶áŸ†á„á¢áŸáŸ‹", "á˜á€ášá¶", "á€á»á˜áŸ’á—áŸˆ", "á˜á¸á“á¶", "á˜áŸáŸá¶", "á§áŸá—á¶", "á˜á·áá»á“á¶", 
            "á€á€áŸ’á€áŠá¶", "áŸá¸á á¶", "á€á‰áŸ’á‰á¶", "áá»á›á¶", "áœá·á…áŸ’á†á·á€á¶", "á’áŸ’á“á¼"
        ];
        // Day of Week Names (0=Sunday, 1=Monday... 6=Saturday)
        const DAY_NAMES = [
            "á¢á¶á‘á·ááŸ’á™", "á…áŸá“áŸ’á‘", "á¢á„áŸ’á‚á¶áš", "á–á»á’", "á–áŸ’ášá áŸáŸ’á”áá·áŸ", "áŸá»á€áŸ’áš", "áŸáŸ…ášáŸ"
        ];

        // --- AVATAR & IMAGE HANDLING FUNCTION ---
        function getInitials(email) {
            if (!email) return 'U';
            const parts = email.split('@')[0].split('.');
            let initials = '';
            if (parts.length > 0) initials += parts[0][0];
            if (parts.length > 1) initials += parts[parts.length - 1][0];
            return initials.toUpperCase().slice(0, 2);
        }
        
        function setAvatar(element, email, imageUrl = null) {
            element.classList.remove('avatar-image');
            element.style.backgroundImage = '';
            element.textContent = getInitials(email);
            element.style.backgroundColor = '#6366f1';
            element.style.color = 'white';

            if (imageUrl) {
                const img = new Image();
                img.onload = () => {
                    element.style.backgroundImage = `url(${imageUrl})`;
                    element.style.backgroundColor = 'transparent';
                    element.style.color = 'transparent'; 
                    element.textContent = '';
                    element.classList.add('avatar-image');
                };
                img.onerror = () => {
                    element.style.backgroundImage = '';
                };
                img.src = imageUrl;
            }
        }

        // --- SPA NAVIGATION LOGIC ---
        let currentActiveView = 'dashboard';
        
        function showView(viewId) {
            const views = document.querySelectorAll('.view-content');
            views.forEach(view => {
                view.classList.add('hidden');
                view.classList.remove('active');
            });

            const targetView = document.getElementById(`${viewId}-view`);
            if (targetView) {
                targetView.classList.remove('hidden');
                targetView.classList.add('active');
                currentActiveView = viewId;
            }
            
            // Update Navigation Tabs
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('border-indigo-600', 'text-indigo-600', 'font-bold');
                item.classList.add('border-transparent', 'text-gray-600');
            });

            const activeTab = document.getElementById(`nav-${viewId}`);
            if (activeTab) {
                activeTab.classList.add('border-indigo-600', 'text-indigo-600', 'font-bold');
                activeTab.classList.remove('border-transparent', 'text-gray-600');
            }
            
            // Manage FAB button display (always hidden on Operation view, only shown on Dashboard)
            const fabBtn = document.getElementById('fab-add-btn');
            // FAB is only visible on large screens when a form is available, or on mobile when explicitly active (which we handle via the modal now, so just hide it here)
            fabBtn.style.display = 'none';

            lucide.createIcons();
            
            // Rerender list/filters if switching to the Operation List view
            if (viewId === 'operation') {
                filterRecords();
            }
        }

        // --- MODAL & LOGOUT FUNCTIONS ---
        function openProfileModal() {
            document.getElementById('profileModal').classList.add('active');
            lucide.createIcons();
        }
        function closeProfileModal() { document.getElementById('profileModal').classList.remove('active'); }
        async function customLogout() {
            const confirmed = await customConfirm(
                "á…á¶á€á…áŸá‰á–á¸á‚áá“á¸",
                "áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á…á¶á€á…áŸá‰á–á¸á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™á˜áŸ‚á“á‘áŸ?",
                "á…á¶á€á…áŸá‰",
                "logout"
            );
            
            if (confirmed) {
                localStorage.removeItem("user");
                localStorage.clear();
                window.location.href = "index.html";
            }
        }
        
        // --- TOAST, CONFIRM ---
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            let bgColor, icon, iconColor;
            switch (type) {
                case 'success': bgColor = 'bg-green-600'; icon = 'check-circle'; iconColor = 'text-green-200'; break;
                case 'error': bgColor = 'bg-red-600'; icon = 'x-circle'; iconColor = 'text-red-200'; break;
                case 'warning': bgColor = 'bg-yellow-500'; icon = 'alert-triangle'; iconColor = 'text-yellow-200'; break;
                case 'info': default: bgColor = 'bg-blue-600'; icon = 'info'; iconColor = 'text-blue-200'; break;
            }
            const toast = document.createElement('div');
            toast.className = `p-4 max-w-sm w-full rounded-lg shadow-xl text-white flex items-center space-x-3 transform transition-all ease-in-out duration-300 opacity-0 translate-x-full pointer-events-auto ${bgColor}`;
            toast.style.minWidth = '250px'; 
            toast.innerHTML = `
                <i data-lucide="${icon}" class="w-6 h-6 ${iconColor} flex-shrink-0"></i>
                <p class="font-medium text-sm flex-1">${message}</p>
                <button onclick="this.closest('div').remove()" class="p-1 -mr-1 rounded-full hover:bg-white/20 transition-all flex-shrink-0">
                    <i data-lucide="x" class="w-4 h-4 text-white"></i>
                </button>`;
            container.appendChild(toast);
            lucide.createIcons(); 
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-x-full');
                toast.classList.add('opacity-100', 'translate-x-0');
            }, 50); 
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-x-0');
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300); 
            }, duration);
        }

        function customConfirm(title, message, actionText, type = 'delete') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const actionBtn = document.getElementById('confirm-action-btn');
                const iconBox = document.getElementById('confirm-icon-box');
                actionBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700', 'bg-red-800', 'hover:bg-red-900', 'bg-indigo-600', 'hover:bg-indigo-700', 'bg-blue-600', 'hover:bg-blue-700');
                iconBox.className = 'w-12 h-12 rounded-full mx-auto mb-4 flex items-center justify-center';
                let iconHtml = '';

                if (type === 'delete') { actionBtn.classList.add('bg-red-600', 'hover:bg-red-700'); iconBox.classList.add('bg-red-100'); iconHtml = '<i data-lucide="trash-2" class="w-6 h-6 text-red-600"></i>';
                } else if (type === 'permanent_delete') { actionBtn.classList.add('bg-red-800', 'hover:bg-red-900'); iconBox.classList.add('bg-red-200'); iconHtml = '<i data-lucide="skull" class="w-6 h-6 text-red-800"></i>';
                } else if (type === 'restore') { actionBtn.classList.add('bg-green-600', 'hover:bg-green-700'); iconBox.classList.add('bg-green-100'); iconHtml = '<i data-lucide="rotate-ccw" class="w-6 h-6 text-green-600"></i>';
                } else if (type === 'logout') { actionBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700'); iconBox.classList.add('bg-indigo-100'); iconHtml = '<i data-lucide="log-out" class="w-6 h-6 text-indigo-600"></i>';
                } else { actionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); iconBox.classList.add('bg-blue-100'); iconHtml = '<i data-lucide="help-circle" class="w-6 h-6 text-blue-600"></i>';
                }

                titleEl.textContent = title;
                messageEl.textContent = message;
                actionBtn.textContent = actionText;
                iconBox.innerHTML = iconHtml;
                lucide.createIcons();
                customConfirmResolver = resolve;
                modal.classList.add('active');
            });
        }
        
        function resolveCustomConfirm(result) {
            document.getElementById('customConfirmModal').classList.remove('active');
            if (customConfirmResolver) {
                customConfirmResolver(result);
                customConfirmResolver = null;
            }
        }
        
        // --- FORM/DATA FUNCTIONS (Hoisted) ---
        
        function formatCurrency(amount) {
            const num = parseFloat(amount) || 0;
            return `${num.toLocaleString('km-KH')} áŸ›`;
        }

        function isSameDay(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return d1.getFullYear() === d2.getFullYear() &&
                    d1.getMonth() === d2.getMonth() &&
                    d1.getDate() === d2.getDate();
        }

        function setupForms() {
            const formTemplate = document.getElementById('form-template').innerHTML;
            const desktopForm = document.getElementById('expense-form');
            desktopForm.innerHTML = formTemplate;
            desktopForm.addEventListener('submit', (e) => handleFormSubmission(e, 'desktop'));
            desktopForm.querySelectorAll('.expense-input').forEach(input => {
                input.addEventListener('input', () => updateAmountSummary(desktopForm));
            });
            const mobileForm = document.getElementById('mobile-expense-form');
            mobileForm.innerHTML = formTemplate;
            mobileForm.addEventListener('submit', (e) => handleFormSubmission(e, 'mobile'));
            mobileForm.querySelectorAll('.expense-input').forEach(input => {
                input.addEventListener('input', () => updateAmountSummary(mobileForm));
            });
        }

        function updateAmountSummary(formElement) {
            const meat = parseFloat(formElement.querySelector("#meat").value) || 0;
            const vegetable = parseFloat(formElement.querySelector("#vegetable").value) || 0;
            const fruit = parseFloat(formElement.querySelector("#fruit").value) || 0;
            const total = meat + vegetable + fruit;
            formElement.querySelector("#amount-summary").value = formatCurrency(total);
            formElement.querySelector("#amount").value = total;
            const summaryInput = formElement.querySelector("#amount-summary");
            if (total === 0) {
                summaryInput.classList.remove('text-red-600');
                summaryInput.classList.add('text-gray-500');
            } else {
                summaryInput.classList.remove('text-gray-500');
                summaryInput.classList.add('text-red-600');
            }
        }

        function handleCardClick(record) {
            const isMobile = window.innerWidth < 1024;
            if (isMobile) {
                editExpense(record.ID, false); 
            } else {
                openDetailModal(record); 
            }
        }
        
        async function loadAllData() {
            const expenseListElement = document.getElementById("expense-list");
            if (expenseListElement) {
                expenseListElement.innerHTML = '<p class="text-center text-gray-500 py-10 flex items-center justify-center"><i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-3"></i> á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</p>';
            }

            try {
                // Assuming sheetUrl and SHEET_EXPENSES are defined in config.js
                const res = await fetch(sheetUrl(SHEET_EXPENSES));
                const data = await res.json();
                
                allExpenses = data.filter(x => x.ID && (x.Type === 'Expense' || x.Status === 'Deleted') && x.Amount !== undefined); 
                
                calculateSummary(allExpenses); 
                populateDateFilters(); 
                filterRecords(); 
            } catch (error) {
                if (expenseListElement) {
                    expenseListElement.innerHTML = '<p class="text-center text-red-500 py-10 text-lg">âŒ á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá‘á¶á‰á‘á·á“áŸ’á“á“áŸá™áŸ” áŸá¼á˜á–á·á“á·ááŸ’á™á˜á¾á› Column headers á€áŸ’á“á»á„ SheetDB</p>';
                }
                console.error("Error loading expenses:", error);
                showToast("âŒ á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá•áŸ’á‘á»á€á‘á·á“áŸ’á“á“áŸá™á…áŸ†áá¶á™! (á–á·á“á·ááŸ’á™ Column names á€áŸ’á“á»á„ SheetDB)", 'error', 6000); 
            }
        }

        function populateDateFilters() {
            const currentYear = new Date().getFullYear();
            const todayDayIndex = new Date().getDay(); 
            
            const daySelect = document.getElementById('filter-day-of-week');
            const monthSelect = document.getElementById('filter-month');
            const yearSelect = document.getElementById('filter-year');
            const filterTodaySelect = document.getElementById('filter-today');

            // 1. Day of Week Filter
            let dayOptions = `<option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>`;
            DAY_NAMES.forEach((name, index) => {
                dayOptions += `<option value="${index}">${name}</option>`;
            });
            if(daySelect) {
                daySelect.innerHTML = dayOptions;
                daySelect.value = 'all'; 
            }

            // 2. Month Filter
            if(monthSelect) {
                monthSelect.innerHTML = MONTH_NAMES.map((name, index) => 
                    `<option value="${index === 0 ? 'all' : index}">${name}</option>`
                ).join('');
                monthSelect.value = 'all';
            }

            // 3. Year Filter
            const years = ['all', currentYear + 1, currentYear, currentYear - 1, currentYear - 2]; 
            const existingYears = [...new Set(allExpenses.map(x => new Date(x.Date).getFullYear()))].filter(y => !years.includes(y)).sort((a, b) => b - a);
            
            if(yearSelect) {
                yearSelect.innerHTML = `<option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>` + years
                    .filter((y, index) => y !== 'all' && years.indexOf(y) === index) 
                    .concat(existingYears)
                    .map(year => `<option value="${year}">${year}</option>`)
                    .join('');
                yearSelect.value = 'all';
            }
            
            // 4. Update Today filter text
            if(filterTodaySelect) {
                filterTodaySelect.value = 'all';
                filterTodaySelect.options[1].textContent = `ááŸ’á„áŸƒá“áŸáŸ‡ (${DAY_NAMES[todayDayIndex]})`;
            }
        }

        function calculateSummary(data) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();

            const activeExpenses = data.filter(x => x.Status === "Active"); 
            let totalExpense = 0;
            let todayExpense = 0;
            let monthlyExpense = 0;
            let totalMeat = 0;
            let totalVegetable = 0;
            let totalFruit = 0;
            let totalCount = activeExpenses.length;

            activeExpenses.forEach(x => {
                const amount = parseFloat(x.Amount) || 0;
                const recordDate = new Date(x.Date);
                
                const meat = parseFloat(x.Meat) || 0;
                const vegetable = parseFloat(x.Vegetable) || 0;
                const fruit = parseFloat(x.Fruit) || 0;
                totalMeat += meat;
                totalVegetable += vegetable;
                totalFruit += fruit;
                
                totalExpense += amount; 

                if (isSameDay(x.Date, today)) {
                    todayExpense += amount;
                }
                
                if (recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear) {
                    monthlyExpense += amount;
                }
            });
            
            // Rendering Summary Cards (Check if elements exist)
            if (document.getElementById('total-expense-summary')) {
                document.getElementById('total-expense-summary').textContent = formatCurrency(totalExpense);
                document.getElementById('today-expense-summary').textContent = formatCurrency(todayExpense);
                document.getElementById('monthly-expense-summary').textContent = formatCurrency(monthlyExpense);
                document.getElementById('meat-total-summary').textContent = formatCurrency(totalMeat);
                document.getElementById('vegetable-total-summary').textContent = formatCurrency(totalVegetable);
                document.getElementById('fruit-total-summary').textContent = formatCurrency(totalFruit);
                document.getElementById('total-count-summary').textContent = `${totalCount} á€áŸ†áááŸ‹ááŸ’ášá¶`;
            }
        }

        function filterRecords() {
            const filterToday = document.getElementById('filter-today') ? document.getElementById('filter-today').value : 'all';
            const filterDayOfWeek = document.getElementById('filter-day-of-week') ? document.getElementById('filter-day-of-week').value : 'all';
            const filterMonth = document.getElementById('filter-month') ? document.getElementById('filter-month').value : 'all';
            const filterYear = document.getElementById('filter-year') ? document.getElementById('filter-year').value : 'all';
            const searchTerm = document.getElementById('search-input') ? document.getElementById('search-input').value.toLowerCase() : '';
            
            const expenseOnlyData = allExpenses.filter(x => x.Type === "Expense" || x.Status === "Deleted");

            const dataToFilter = currentView === 'active' ? 
                                 expenseOnlyData.filter(x => x.Status === "Active") : 
                                 expenseOnlyData.filter(x => x.Status === "Deleted");
                                    
            let filtered = dataToFilter;

            const today = new Date();

            filtered = filtered.filter(x => {
                const recordDate = new Date(x.Date);
                const description = (x.Description || '').toLowerCase(); 
                
                let matchesToday = true;
                let matchesDayOfWeek = true;
                let matchesMonth = true;
                let matchesYear = true;
                let matchesSearch = true;

                // Filtering logic (same as previous)
                if (filterToday === 'today') { matchesToday = isSameDay(x.Date, today); }
                if (filterDayOfWeek !== 'all') { matchesDayOfWeek = recordDate.getDay() === parseInt(filterDayOfWeek); }
                if (filterMonth !== 'all') { matchesMonth = recordDate.getMonth() === parseInt(filterMonth) - 1; }
                if (filterYear !== 'all') { matchesYear = recordDate.getFullYear() === parseInt(filterYear); }
                if (searchTerm) { matchesSearch = description.includes(searchTerm); }
                
                // If 'today' is active, override month/year filter logic to ensure it shows only today's date
                if (filterToday === 'today') {
                    matchesMonth = true; // Ignored if today is active
                    matchesYear = true;  // Ignored if today is active
                }

                return matchesToday && matchesDayOfWeek && matchesMonth && matchesYear && matchesSearch;
            }).sort((a, b) => new Date(b.Date) - new Date(a.Date)); 

            filteredDataForReport = filtered;
            renderExpenseList(filtered);
        }

        function openDetailModal(record) {
            activeDetailRecord = record;
            document.getElementById('detail-date').textContent = record.Date;
            document.getElementById('detail-amount').textContent = formatCurrency(parseFloat(record.Amount)); 
            document.getElementById('detail-amount').className = 'text-3xl font-extrabold mt-1 text-red-600'; 
            document.getElementById('detail-meat').textContent = formatCurrency(parseFloat(record.Meat));
            document.getElementById('detail-vegetable').textContent = formatCurrency(parseFloat(record.Vegetable));
            document.getElementById('detail-fruit').textContent = formatCurrency(parseFloat(record.Fruit));
            document.getElementById('detail-desc').textContent = record.Description || 'á‚áŸ’á˜á¶á“á–á·á–ááŸŒá“á¶';
            document.getElementById('detail-modified').textContent = record.ModifiedDate ? new Date(record.ModifiedDate).toLocaleString('km-KH') : 'N/A';
            document.getElementById('detail-status').textContent = record.Status === 'Deleted' ? 'á›á»á”á”ááŸ’áŠáŸ„áŸ‡á¢á¶áŸá“áŸ’á“' : 'áŸá€á˜áŸ’á˜';
            document.getElementById('detailModal').classList.add('active');
            lucide.createIcons();
        }

        // --- Execute Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Setup Forms and load data immediately to populate filters/summary
            if (user) {
                // Re-run this setup inside DOMContentLoaded to ensure elements are available
                setupForms();
                loadAllData();
                showView('dashboard');
            }
        });
    </script>
</body>
</html>
