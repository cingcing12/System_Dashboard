<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ - á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™á‚áŸ’ášá¿á„á‘áŸáŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Khmer+OS+Battambang:wght@400;600;700&display=swap');
        body {
            font-family: 'Khmer OS Battambang', sans-serif;
            min-height: 100vh;
            background-color: #f7f9fc; 
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 999; backdrop-filter: blur(4px); transition: opacity 0.3s ease; }
        .modal.active { display:flex; }
        .card-shadow-lg { box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05), 0 5px 15px rgba(0, 0, 0, 0.03); }
        .dropdown { position: relative; }
        .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; min-width: 240px; background-color: white; border-radius: 12px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); z-index: 100; margin-top: 12px; transform: translateY(-10px); opacity: 0; transition: all 0.2s ease-out; }
        .dropdown-menu.active { display: block; transform: translateY(0); opacity: 1; }
        
        .expense-item { 
            transition: all 0.3s ease; 
            border: 1px solid #e2e8f0; 
            background: #ffffff; 
            border-left: 6px solid; 
        }
        .expense-item:hover { 
            cursor: pointer; 
            transform: translateY(-3px); 
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12); 
            border-color: #93c5fd; 
        }

        #fab-add-btn { position: fixed; bottom: 24px; right: 24px; z-index: 50; width: 64px; height: 64px; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3); }
        @media(max-width:1023px){ #fab-add-btn{ display: none; } /* Managed by JS/Form Modal */ #mobileFormModal .modal-content-mobile { width: 95%; max-width: 480px; margin: 10px; } }
        
        /* Form container needs to stay hidden/block on desktop */
        #main-expense-form-container { display: none; }
        @media (min-width: 1024px) { #main-expense-form-container { display: block !important; } #mobileFormModal { display: none !important; } }
        
        /* Avatar Styles */
        .avatar-initials {
            width: 40px; height: 40px; border-radius: 50%; 
            background-color: #6366f1; color: white; 
            font-size: 16px; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        .avatar-image { 
            background-color: transparent !important;
            color: transparent !important;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .confirm-modal-content { animation: fadeInScale 0.3s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .view-content.hidden { display: none !important; }
        .view-content.active { display: block; }

        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; background-color: #ffffff !important; }
            .card-shadow-lg { box-shadow: none !important; border: 1px solid #ccc; }
            .hide-on-print { display: none !important; }
            .expense-item { page-break-inside: avoid; border: 1px solid #eee; margin-bottom: 5px !important; }
            header, #fab-add-btn, .item-actions, #main-expense-form-container, #data-view-section > div:first-child { display: none !important; }
            #data-view-section { border: none !important; box-shadow: none !important; padding: 0 !important; }
            #expense-list { max-height: unset !important; overflow-y: visible !important; }
        }
    </style>
</head>
<body>
    
    <div id="toast-container" class="fixed top-4 right-4 z-[1000] space-y-3 pointer-events-none"></div>
    <div id="customConfirmModal" class="modal">
        <div class="confirm-modal-content bg-white rounded-2xl p-8 w-full max-w-sm relative shadow-2xl">
            <div id="confirm-icon-box" class="w-12 h-12 rounded-full mx-auto mb-4 flex items-center justify-center text-white bg-red-100">
                   <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
            </div>
            <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-2 text-center">áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠá‘áŸ?</h3>
            <p id="confirm-message" class="text-gray-600 mb-6 text-center text-sm">á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá“áŸáŸ‡á˜á·á“á¢á¶á…ááŸ’ášá›á”áŸ‹á€áŸ’ášáŸ„á™á”á¶á“á‘áŸáŸ”</p>
            
            <div class="flex justify-center space-x-4">
                <button type="button" onclick="resolveCustomConfirm(false)" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”áŸ„áŸ‡á”á„áŸ‹</button>
                <button type="button" id="confirm-action-btn" onclick="resolveCustomConfirm(true)" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition">á™á›áŸ‹á–áŸ’ášá˜</button>
            </div>
        </div>
    </div>
    
    <header class="bg-white shadow-lg sticky top-0 z-50 border-b border-gray-200">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center px-4">
            
            <div class="flex justify-between w-full md:w-auto items-center py-4">
                <h1 class="text-xl sm:text-3xl font-bold text-indigo-700 flex items-center">
                    <i data-lucide="wallet" class="w-6 h-6 sm:w-7 sm:h-7 mr-2 sm:mr-3 text-indigo-500"></i>
                    á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™á‚áŸ’ášá¿á„á‘áŸáŸ
                </h1>
                
                <div class="dropdown md:hidden">
                    <button onclick="openProfileModal(); return false;" class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-semibold hover:bg-indigo-600 transition duration-150 relative ring-2 ring-indigo-300 ring-offset-2">
                        <div id="user-avatar-initials-mobile" class="avatar-initials w-full h-full text-sm">...</div>
                    </button>
                </div>
            </div>

            <nav class="flex-1 overflow-x-auto w-full md:w-auto custom-scrollbar md:pb-0" style="scrollbar-width: none; -ms-overflow-style: none;">
                <ul class="flex space-x-6 whitespace-nowrap border-t md:border-t-0 pt-3 md:pt-0">
                    <li onclick="showView('dashboard')" id="nav-dashboard" class="nav-item pb-3 border-b-4 border-indigo-600 text-indigo-600 font-bold flex items-center cursor-pointer">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 mr-1"></i> á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„
                    </li>
                    <li onclick="showView('operation')" id="nav-operation" class="nav-item pb-3 border-b-4 border-transparent text-gray-600 hover:border-indigo-100 hover:text-indigo-500 transition cursor-pointer flex items-center">
                        <i data-lucide="list-ordered" class="w-4 h-4 mr-1"></i> á”á‰áŸ’á‡á¸á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá…áŸ†áá¶á™
                    </li>
                    <li onclick="window.location.href='user.html'" id="user-management-tab" class="hidden pb-3 border-b-4 border-transparent text-gray-600 hover:border-purple-100 hover:text-purple-500 transition cursor-pointer flex items-center">
                        <i data-lucide="users" class="w-4 h-4 mr-1"></i> á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¢áŸ’á“á€á”áŸ’ášá¾
                    </li>
                </ul>
            </nav>
            
            <div class="dropdown hidden md:block pl-4 py-3">
                <button onclick="openProfileModal(); return false;" class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-semibold hover:bg-indigo-600 transition duration-150 relative ring-2 ring-indigo-300 ring-offset-2">
                    <div id="user-avatar-initials-desktop" class="avatar-initials w-full h-full text-sm">...</div>
                </button>
            </div>
        </div>
    </header>

    <main id="main-content-container" class="max-w-7xl mx-auto p-4 md:p-8">
        
        <div id="dashboard-view" class="view-content active">
            <h2 class="text-3xl font-bold text-gray-700 mb-6 flex items-center"><i data-lucide="layout-dashboard" class="w-6 h-6 mr-2 text-indigo-500"></i> á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„áŸá„áŸ’ááŸá”</h2>
            
            <section class="mb-8">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-red-600 hover:shadow-xl transition transform hover:scale-[1.01]">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="receipt" class="w-4 h-4 mr-2 text-red-600"></i> á…áŸ†áá¶á™áŸášá»á”ášá½á˜</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-700 truncate" id="total-expense-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-red-500 hover:shadow-xl transition transform hover:scale-[1.01]">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="calendar" class="w-4 h-4 mr-2 text-red-500"></i> á…áŸ†áá¶á™á”áŸ’ášá…á¶áŸ†ááŸ‚</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-600 truncate" id="monthly-expense-summary">0 áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-orange-500 hover:shadow-xl transition transform hover:scale-[1.01]">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="utensils" class="w-4 h-4 mr-2 text-orange-500"></i> áŸá¶á…áŸ‹áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-orange-600 truncate" id="meat-total-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-green-500 hover:shadow-xl transition transform hover:scale-[1.01]">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="leaf" class="w-4 h-4 mr-2 text-green-500"></i> á”á“áŸ’á›áŸ‚áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-green-600 truncate" id="vegetable-total-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-yellow-500 hover:shadow-xl transition transform hover:scale-[1.01] mt-4 lg:mt-0">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="apple" class="w-4 h-4 mr-2 text-yellow-500"></i> á•áŸ’á›áŸ‚áˆá¾áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-yellow-600 truncate" id="fruit-total-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-red-300 hover:shadow-xl transition transform hover:scale-[1.01] mt-4 lg:mt-0">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="calendar-check" class="w-4 h-4 mr-2 text-red-300"></i> á…áŸ†áá¶á™ááŸ’á„áŸƒá“áŸáŸ‡</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-500 truncate" id="today-expense-summary">0 áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow-lg border-l-4 border-gray-400 hover:shadow-xl transition transform hover:scale-[1.01] mt-4 lg:mt-0">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="hash" class="w-4 h-4 mr-2 text-gray-500"></i> á…áŸ†á“á½á“á€áŸ†áááŸ‹ááŸ’ášá¶</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-gray-700" id="total-count-summary">-- á€áŸ†áááŸ‹ááŸ’ášá¶</p>
                    </div>
                    <div class="lg:col-span-1 hidden lg:block mt-4 lg:mt-0"></div> 
                </div>
            </section>
        
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                
                <section id="main-expense-form-container" class="lg:col-span-1 bg-white p-6 rounded-2xl card-shadow-lg h-fit lg:sticky lg:top-24 border border-gray-100">
                    <h2 class="text-2xl font-bold mb-6 text-indigo-600 border-b pb-3" id="main-form-title">â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸</h2>
                    <form id="expense-form" class="space-y-4"></form>
                </section>
                
                <section class="lg:col-span-3">
                    <div class="bg-white p-6 rounded-2xl card-shadow-lg h-full flex items-center justify-center border border-gray-100">
                        <div class="text-center p-8">
                            <i data-lucide="list-ordered" class="w-12 h-12 text-indigo-400 mx-auto mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-700">á”á‰áŸ’á‡á¸á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášááŸ’ášá¼áœá”á¶á“á•áŸ’á‘áŸášá‘áŸ… Tab áŠá¶á…áŸ‹áŠáŸ„á™á¡áŸ‚á€</h3>
                            <p class="text-gray-500 mt-2">á˜á¾á›á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá‘á¶áŸ†á„á¢áŸáŸ‹áŠáŸ„á™á…á»á…á›á¾ Tab **"á”á‰áŸ’á‡á¸á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá…áŸ†áá¶á™"** á“áŸ…áá¶á„á›á¾áŸ”</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <div id="operation-view" class="view-content hidden">
            <section id="data-view-section" class="bg-white p-4 sm:p-6 rounded-2xl card-shadow-lg border border-gray-100">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-2">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-700 mb-2 sm:mb-0 flex items-center">
                        <i data-lucide="list-ordered" class="w-6 h-6 mr-2 text-indigo-500"></i> á”á‰áŸ’á‡á¸á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá…áŸ†áá¶á™
                    </h2>
                    <div class="flex space-x-3">
                        <button onclick="openFormModal();" class="bg-indigo-600 text-white hover:bg-indigo-700 px-4 py-2 rounded-lg transition flex items-center font-semibold text-sm shadow-md md:hidden">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i> á”á“áŸ’ááŸ‚á˜á…áŸ†áá¶á™
                        </button>
                        <button onclick="switchView('trash')" id="trash-btn" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg transition flex items-center font-semibold text-sm shadow-sm">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> á€áŸ†áááŸ‹ááŸ’ášá¶áŠáŸ‚á›á”á¶á“á›á»á”
                        </button>
                    </div>
                </div>

                <div class="mb-6 p-4 border rounded-xl bg-indigo-50 border-indigo-200 shadow-inner">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <div class="col-span-1">
                            <label for="filter-day-of-week" class="block text-xs font-medium text-indigo-700 mb-1">ááŸ’ášá„áá¶á˜ááŸ’á„áŸƒ:</label>
                            <select id="filter-day-of-week" class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()"></select>
                        </div>
                        <div class="col-span-1">
                            <label for="filter-today" class="block text-xs font-medium text-indigo-700 mb-1">ááŸ’ášá„áá¶á˜ááŸ’á„áŸƒá‡á¶á€áŸ‹á›á¶á€áŸ‹:</label>
                            <select id="filter-today" class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()">
                                <option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
                                <option value="today">ááŸ’á„áŸƒá“áŸáŸ‡</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label for="filter-month" class="block text-xs font-medium text-indigo-700 mb-1">ááŸ’ášá„áá¶á˜ááŸ‚:</label>
                            <select id="filter-month" class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()"></select>
                        </div>
                        <div class="col-span-1">
                             <label for="filter-year" class="block text-xs font-medium text-indigo-700 mb-1">ááŸ’ášá„áá¶á˜á†áŸ’á“á¶áŸ†:</label>
                            <select id="filter-year" class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()"></select>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label for="search-input" class="block text-xs font-medium text-indigo-700 mb-1">áŸáŸ’áœáŸ‚á„ášá€:</label>
                             <input type="text" id="search-input" oninput="filterRecords()" placeholder="á§. á‘á·á‰á˜áŸ’á á¼á”" class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap justify-end gap-3 border-t border-indigo-300 pt-3 mt-3">
                        <button onclick="exportData('pdf')" class="bg-red-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-red-700 transition text-sm font-semibold shadow-md">
                            <i data-lucide="file-text" class="w-4 h-4 mr-1"></i> á‘á¶á‰á™á€ PDF
                        </button>
                        <button onclick="exportData('excel')" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-green-700 transition text-sm font-semibold shadow-md">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-1"></i> á‘á¶á‰á™á€ Excel
                        </button>
                    </div>
                </div>

                <div id="expense-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar">
                    <p class="text-center text-gray-500 py-10">á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</p>
                </div>
            </section>
        </div>

    </main>
    
    <button id="fab-add-btn" onclick="openFormModal()" class="bg-indigo-600 text-white transition hover:bg-indigo-700 ring-4 ring-indigo-300 ring-offset-2">
        <i data-lucide="plus" class="w-8 h-8"></i>
    </button>
    
    <div id="profileModal" class="modal">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md relative shadow-2xl">
            <h3 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2">á–áŸááŸŒá˜á¶á“á‚áá“á¸</h3>
            
            <div class="space-y-4">
                <div class="p-3 bg-gray-50 rounded-lg border flex items-center space-x-3">
                    <div id="modal-profile-avatar" class="avatar-initials w-12 h-12 text-lg">...</div> 
                    <div>
                        <label class="block text-sm font-medium text-gray-500">á¢áŸŠá¸á˜áŸ‰áŸ‚á›</label>
                        <p class="font-semibold text-gray-800" id="modal-profile-email">N/A</p>
                    </div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <label class="block text-sm font-medium text-gray-500">áá½á“á¶á‘á¸</label>
                    <p class="font-semibold text-indigo-700" id="modal-profile-role">N/A</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
                <button type="button" onclick="closeProfileModal()" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”á·á‘</button>
                <button type="button" onclick="customLogout()" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition flex items-center">
                    <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> á…á¶á€á…áŸá‰
                </button>
            </div>
            
            <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>
    
    <div id="detailModal" class="modal">
        <div class="bg-white rounded-2xl p-8 w-full max-w-lg relative shadow-2xl transform transition-all">
            <h3 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2 flex items-center">
                <i data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-gray-500"></i> á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·áá€áŸ†áááŸ‹ááŸ’ášá¶
            </h3>
            
            <div class="space-y-4 text-gray-700">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-1"></i> á€á¶á›á”ášá·á…áŸ’á†áŸá‘</label>
                        <p class="font-semibold text-base" id="detail-date">N/A</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="tag" class="w-4 h-4 mr-1"></i> á”áŸ’ášá—áŸá‘á”áŸ’ášáá·á”ááŸ’áá·á€á¶áš</label>
                        <p class="font-semibold text-base text-red-600" id="detail-type">á…áŸ†áá¶á™ ğŸ“‰</p>
                    </div>
                </div>
                
                <div class="p-4 bg-red-50 rounded-xl border border-red-200 shadow-inner">
                    <label class="block text-sm font-medium text-red-700">á…áŸ†á“á½á“á”áŸ’ášá¶á€áŸ‹áŸášá»á” (Amount)</label>
                    <p class="text-3xl font-extrabold mt-1 text-red-600" id="detail-amount">-- áŸ›</p>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="p-3 bg-white rounded-lg border shadow-sm">
                        <label class="block text-xs font-medium text-gray-500 flex items-center"><i data-lucide="utensils" class="w-3 h-3 mr-1 text-orange-500"></i> áŸá¶á…áŸ‹</label>
                        <p class="font-semibold text-base text-orange-600" id="detail-meat">0 áŸ›</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg border shadow-sm">
                        <label class="block text-xs font-medium text-gray-500 flex items-center"><i data-lucide="leaf" class="w-3 h-3 mr-1 text-green-500"></i> á”á“áŸ’á›áŸ‚</label>
                        <p class="font-semibold text-base text-green-600" id="detail-vegetable">0 áŸ›</p>
                    </div>
                    <div class="p-3 bg-white rounded-lg border shadow-sm">
                        <label class="block text-xs font-medium text-gray-500 flex items-center"><i data-lucide="apple" class="w-3 h-3 mr-1 text-yellow-500"></i> á•áŸ’á›áŸ‚áˆá¾</label>
                        <p class="font-semibold text-base text-yellow-600" id="detail-fruit">0 áŸ›</p>
                    </div>
                </div>
                
                <div class="p-3 bg-gray-50 rounded-lg border">
                    <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="align-left" class="w-4 h-4 mr-1"></i> á–á·á–ááŸŒá“á¶á›á˜áŸ’á¢á·á</label>
                    <p id="detail-desc" class="whitespace-pre-wrap text-sm">N/A</p>
                </div>
                
                <div class="text-xs text-gray-500 pt-3 flex justify-between">
                    <p>á€áŸ‚á”áŸ’ášáŸ‚á…á»á„á€áŸ’ášáŸ„á™: <span id="detail-modified">N/A</span></p>
                    <p>áŸáŸ’áá¶á“á—á¶á–: <span id="detail-status" class="font-semibold">N/A</span></p>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
                <button type="button" onclick="editExpense(activeDetailRecord.ID, true);" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition flex items-center shadow-md">
                    <i data-lucide="pencil" class="w-5 h-5 mr-2"></i> á€áŸ‚á”áŸ’ášáŸ‚
                </button>
                <button type="button" onclick="closeDetailModal()" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”á·á‘</button>
            </div>
            
            <button onclick="closeDetailModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>
    
    <div id="mobileFormModal" class="modal">
        <div class="modal-content-mobile bg-white rounded-2xl p-6 w-full relative shadow-2xl">
            <h3 class="text-2xl font-bold text-indigo-600 mb-6 border-b pb-2" id="mobile-form-title">â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸</h3>
            <form id="mobile-expense-form" class="space-y-4"></form>
            <button onclick="closeFormModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>
    
    <div id="form-template" style="display: none;">
        <input type="hidden" id="record-id" value="">
        
        <label for="date" class="block text-sm font-medium text-gray-700">á€á¶á›á”ášá·á…áŸ’á†áŸá‘</label>
        <input id="date" type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-600 focus:border-indigo-600 transition" required>
        
        <div class="grid grid-cols-3 gap-3 border p-3 rounded-lg bg-gray-50">
            <div class="col-span-3">
                <label class="block text-base font-semibold text-gray-800 mb-2">á…áŸ†á“á½á“á”áŸ’ášá¶á€áŸ‹áŸášá»á” (Amount)</label>
                <input id="amount-summary" type="text" class="w-full p-3 text-2xl font-extrabold text-red-600 bg-white border border-red-300 rounded-lg" value="0 áŸ›" readonly>
                <input type="hidden" id="amount" value="0"> </div>
            
            <div>
                <label for="meat" class="block text-sm font-medium text-gray-700">áŸá¶á…áŸ‹ ($)</label>
                <input id="meat" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-600 focus:border-orange-600 transition expense-input" placeholder="0" min="0">
            </div>
            <div>
                <label for="vegetable" class="block text-sm font-medium text-gray-700">á”á“áŸ’á›áŸ‚ ($)</label>
                <input id="vegetable" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-600 focus:border-green-600 transition expense-input" placeholder="0" min="0">
            </div>
            <div>
                <label for="fruit" class="block text-sm font-medium text-gray-700">á•áŸ’á›áŸ‚áˆá¾ ($)</label>
                <input id="fruit" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-600 focus:border-yellow-600 transition expense-input" placeholder="0" min="0">
            </div>
        </div>
        
        <input id="category" type="hidden" value="Grocery"> 
        <input id="type" type="hidden" value="Expense"> 
        
        <label for="desc" class="block text-sm font-medium text-gray-700">á–á·á–ááŸŒá“á¶á›á˜áŸ’á¢á·á (á”á“áŸ’ááŸ‚á˜)</label>
        <textarea id="desc" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-600 focus:border-indigo-600 transition" placeholder="á…áŸ†áá¶á™á›á¾á¢áŸ’áœá¸ááŸ’á›áŸ‡..."></textarea>
        
        <button type="submit" id="submit-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150 flex items-center justify-center shadow-lg mt-6">
            <i data-lucide="plus" class="w-5 h-5 mr-1"></i> á”á“áŸ’ááŸ‚á˜á€áŸ†áááŸ‹ááŸ’ášá¶
        </button>
        
        <button type="button" id="cancel-btn" onclick="resetForm()" class="w-full bg-gray-300 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-400 transition duration-150 hidden mt-2">
            <i data-lucide="x" class="w-5 h-5 mr-1"></i> á”áŸ„áŸ‡á”á„áŸ‹á€á¶ášá€áŸ‚á”áŸ’ášáŸ‚
        </button>
    </div>


    <script src="config.js"></script>
    <script>
        // --- GLOBAL STATE ---
        const user = JSON.parse(localStorage.getItem("user"));
        let allExpenses = [];
        let currentView = 'active'; 
        let editingID = null;
        let activeDetailRecord = null;
        let customConfirmResolver; 
        let activeFormElement = null; 
        
        // --- HELPER ARRAYS ---
        const MONTH_NAMES = [
            "á‘á¶áŸ†á„á¢áŸáŸ‹", "á˜á€ášá¶", "á€á»á˜áŸ’á—áŸˆ", "á˜á¸á“á¶", "á˜áŸáŸá¶", "á§áŸá—á¶", "á˜á·áá»á“á¶", 
            "á€á€áŸ’á€áŠá¶", "áŸá¸á á¶", "á€á‰áŸ’á‰á¶", "áá»á›á¶", "áœá·á…áŸ’á†á·á€á¶", "á’áŸ’á“á¼"
        ];
        // Day of Week Names (0=Sunday, 1=Monday... 6=Saturday)
        const DAY_NAMES = [
            "á¢á¶á‘á·ááŸ’á™", "á…áŸá“áŸ’á‘", "á¢á„áŸ’á‚á¶áš", "á–á»á’", "á–áŸ’ášá áŸáŸ’á”áá·áŸ", "áŸá»á€áŸ’áš", "áŸáŸ…ášáŸ"
        ];

        // --- AVATAR & IMAGE HANDLING FUNCTION ---
        function getInitials(email) {
            if (!email) return 'U';
            const parts = email.split('@')[0].split('.');
            let initials = '';
            if (parts.length > 0) initials += parts[0][0];
            if (parts.length > 1) initials += parts[parts.length - 1][0];
            return initials.toUpperCase().slice(0, 2);
        }
        
        function setAvatar(element, email, imageUrl = null) {
            element.classList.remove('avatar-image');
            element.style.backgroundImage = '';
            element.textContent = getInitials(email);
            element.style.backgroundColor = '#6366f1';
            element.style.color = 'white';

            if (imageUrl) {
                const img = new Image();
                img.onload = () => {
                    element.style.backgroundImage = `url(${imageUrl})`;
                    element.style.backgroundColor = 'transparent';
                    element.style.color = 'transparent'; 
                    element.textContent = '';
                    element.classList.add('avatar-image');
                };
                img.onerror = () => {
                    element.style.backgroundImage = '';
                };
                img.src = imageUrl;
            }
        }

        // --- SPA NAVIGATION LOGIC ---
        
        function showView(viewId) {
            const views = document.querySelectorAll('.view-content');
            views.forEach(view => {
                view.classList.add('hidden');
                view.classList.remove('active');
            });

            const targetView = document.getElementById(`${viewId}-view`);
            if (targetView) {
                targetView.classList.remove('hidden');
                targetView.classList.add('active');
                currentActiveView = viewId;
            }
            
            // Update Navigation Tabs
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('border-indigo-600', 'text-indigo-600', 'font-bold');
                item.classList.add('border-transparent', 'text-gray-600');
            });

            const activeTab = document.getElementById(`nav-${viewId}`);
            if (activeTab) {
                activeTab.classList.add('border-indigo-600', 'text-indigo-600', 'font-bold');
                activeTab.classList.remove('border-transparent', 'text-gray-600');
            }
            
            // Re-render icons and filter list if needed
            lucide.createIcons();

            // Trigger data load/filter only when switching to the Operation List view
            if (viewId === 'operation') {
                // Ensure filter select options reflect the current data
                populateDateFilters(); 
                filterRecords();
            }
        }

        // --- AUTH & INIT (Initialization is moved inside DOMContentLoaded) ---
        
        // --- MODAL & LOGOUT FUNCTIONS ---
        function openProfileModal() {
            document.getElementById('profileModal').classList.add('active');
            lucide.createIcons();
        }
        function closeProfileModal() { document.getElementById('profileModal').classList.remove('active'); }
        async function customLogout() {
            const confirmed = await customConfirm(
                "á…á¶á€á…áŸá‰á–á¸á‚áá“á¸",
                "áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á…á¶á€á…áŸá‰á–á¸á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™á˜áŸ‚á“á‘áŸ?",
                "á…á¶á€á…áŸá‰",
                "logout"
            );
            
            if (confirmed) {
                localStorage.removeItem("user");
                localStorage.clear();
                window.location.href = "index.html";
            }
        }
        function logout() { customLogout(); } 
        
        // --- TOAST, CONFIRM ---
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            let bgColor, icon, iconColor;
            switch (type) {
                case 'success': bgColor = 'bg-green-600'; icon = 'check-circle'; iconColor = 'text-green-200'; break;
                case 'error': bgColor = 'bg-red-600'; icon = 'x-circle'; iconColor = 'text-red-200'; break;
                case 'warning': bgColor = 'bg-yellow-500'; icon = 'alert-triangle'; iconColor = 'text-yellow-200'; break;
                case 'info': default: bgColor = 'bg-blue-600'; icon = 'info'; iconColor = 'text-blue-200'; break;
            }
            const toast = document.createElement('div');
            toast.className = `p-4 max-w-sm w-full rounded-lg shadow-xl text-white flex items-center space-x-3 transform transition-all ease-in-out duration-300 opacity-0 translate-x-full pointer-events-auto ${bgColor}`;
            toast.style.minWidth = '250px'; 
            toast.innerHTML = `
                <i data-lucide="${icon}" class="w-6 h-6 ${iconColor} flex-shrink-0"></i>
                <p class="font-medium text-sm flex-1">${message}</p>
                <button onclick="this.closest('div').remove()" class="p-1 -mr-1 rounded-full hover:bg-white/20 transition-all flex-shrink-0">
                    <i data-lucide="x" class="w-4 h-4 text-white"></i>
                </button>`;
            container.appendChild(toast);
            lucide.createIcons(); 
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-x-full');
                toast.classList.add('opacity-100', 'translate-x-0');
            }, 50); 
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-x-0');
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300); 
            }, duration);
        }

        function customConfirm(title, message, actionText, type = 'delete') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');
                const actionBtn = document.getElementById('confirm-action-btn');
                const iconBox = document.getElementById('confirm-icon-box');
                actionBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700', 'bg-red-800', 'hover:bg-red-900', 'bg-indigo-600', 'hover:bg-indigo-700', 'bg-blue-600', 'hover:bg-blue-700');
                iconBox.className = 'w-12 h-12 rounded-full mx-auto mb-4 flex items-center justify-center';
                let iconHtml = '';

                if (type === 'delete') { actionBtn.classList.add('bg-red-600', 'hover:bg-red-700'); iconBox.classList.add('bg-red-100'); iconHtml = '<i data-lucide="trash-2" class="w-6 h-6 text-red-600"></i>';
                } else if (type === 'permanent_delete') { actionBtn.classList.add('bg-red-800', 'hover:bg-red-900'); iconBox.classList.add('bg-red-200'); iconHtml = '<i data-lucide="skull" class="w-6 h-6 text-red-800"></i>';
                } else if (type === 'restore') { actionBtn.classList.add('bg-green-600', 'hover:bg-green-700'); iconBox.classList.add('bg-green-100'); iconHtml = '<i data-lucide="rotate-ccw" class="w-6 h-6 text-green-600"></i>';
                } else if (type === 'logout') { actionBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700'); iconBox.classList.add('bg-indigo-100'); iconHtml = '<i data-lucide="log-out" class="w-6 h-6 text-indigo-600"></i>';
                } else { actionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); iconBox.classList.add('bg-blue-100'); iconHtml = '<i data-lucide="help-circle" class="w-6 h-6 text-blue-600"></i>';
                }

                titleEl.textContent = title;
                messageEl.textContent = message;
                actionBtn.textContent = actionText;
                iconBox.innerHTML = iconHtml;
                lucide.createIcons();
                customConfirmResolver = resolve;
                modal.classList.add('active');
            });
        }
        
        function resolveCustomConfirm(result) {
            document.getElementById('customConfirmModal').classList.remove('active');
            if (customConfirmResolver) {
                customConfirmResolver(result);
                customConfirmResolver = null;
            }
        }
        
        // --- FORM/DATA FUNCTIONS ---
        
        function formatCurrency(amount) {
            const num = parseFloat(amount) || 0;
            return `${num.toLocaleString('km-KH')} áŸ›`;
        }

        function isSameDay(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return d1.getFullYear() === d2.getFullYear() &&
                    d1.getMonth() === d2.getMonth() &&
                    d1.getDate() === d2.getDate();
        }

        function setupForms() {
            const formTemplate = document.getElementById('form-template').innerHTML;
            const desktopForm = document.getElementById('expense-form');
            desktopForm.innerHTML = formTemplate;
            desktopForm.addEventListener('submit', (e) => handleFormSubmission(e, 'desktop'));
            desktopForm.querySelectorAll('.expense-input').forEach(input => {
                input.addEventListener('input', () => updateAmountSummary(desktopForm));
            });
            const mobileForm = document.getElementById('mobile-expense-form');
            mobileForm.innerHTML = formTemplate;
            mobileForm.addEventListener('submit', (e) => handleFormSubmission(e, 'mobile'));
            mobileForm.querySelectorAll('.expense-input').forEach(input => {
                input.addEventListener('input', () => updateAmountSummary(mobileForm));
            });
        }

        function updateAmountSummary(formElement) {
            const meat = parseFloat(formElement.querySelector("#meat").value) || 0;
            const vegetable = parseFloat(formElement.querySelector("#vegetable").value) || 0;
            const fruit = parseFloat(formElement.querySelector("#fruit").value) || 0;
            const total = meat + vegetable + fruit;
            formElement.querySelector("#amount-summary").value = formatCurrency(total);
            formElement.querySelector("#amount").value = total;
            const summaryInput = formElement.querySelector("#amount-summary");
            if (total === 0) {
                summaryInput.classList.remove('text-red-600');
                summaryInput.classList.add('text-gray-500');
            } else {
                summaryInput.classList.remove('text-gray-500');
                summaryInput.classList.add('text-red-600');
            }
        }

        function handleCardClick(record) {
            const isMobile = window.innerWidth < 1024;
            if (isMobile) {
                editExpense(record.ID, false); 
            } else {
                openDetailModal(record); 
            }
        }
        
        async function editExpense(id, scrollToForm=true) {
            const record = allExpenses.find(x => x.ID.toString() === id.toString());
            if (!record) { 
                showToast("âŒ á˜á·á“á¢á¶á…ášá€á€áŸ†áááŸ‹ááŸ’ášá¶á”á¶á“á‘áŸáŸ”", 'error'); 
                return; 
            }
            
            closeDetailModal(); 
            editingID = id;
            
            const isMobile = window.innerWidth < 1024;
            
            if (isMobile) {
                openFormModal(); 
                activeFormElement = document.getElementById('mobile-expense-form');
            } else {
                activeFormElement = document.getElementById('expense-form');
            }
            
            if(activeFormElement) {
                populateForm(activeFormElement, record);
            }
            
            if(scrollToForm && !isMobile) {
                document.getElementById("main-expense-form-container").scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function openFormModal() {
            resetForm();
            document.getElementById('mobile-form-title').textContent = "â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸";
            document.getElementById('mobileFormModal').classList.add('active');
            activeFormElement = document.getElementById('mobile-expense-form');
            if(activeFormElement) activeFormElement.reset();
            lucide.createIcons();
        }

        function closeFormModal() {
            resetForm();
            document.getElementById('mobileFormModal').classList.remove('active');
            activeFormElement = null;
        }

        function populateForm(formElement, record) {
            formElement.querySelector("#date").value = record.Date;
            formElement.querySelector("#meat").value = parseFloat(record.Meat) || 0;
            formElement.querySelector("#vegetable").value = parseFloat(record.Vegetable) || 0;
            formElement.querySelector("#fruit").value = parseFloat(record.Fruit) || 0;
            formElement.querySelector("#desc").value = record.Description;
            updateAmountSummary(formElement);

            const isEditing = record !== null;
            const submitBtn = formElement.querySelector('#submit-btn');
            const cancelBtn = formElement.querySelector('#cancel-btn');
            
            if (isEditing) {
                submitBtn.innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-1"></i> ášá€áŸ’áŸá¶á‘á»á€á€á¶ášá€áŸ‚á”áŸ’ášáŸ‚';
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                cancelBtn.classList.remove('hidden');
                
                document.getElementById('main-form-title').textContent = "ğŸ“ á€áŸ‚á”áŸ’ášáŸ‚á€áŸ†áááŸ‹ááŸ’ášá¶";
                const mobileTitle = document.getElementById('mobile-form-title');
                if(mobileTitle) mobileTitle.textContent = "ğŸ“ á€áŸ‚á”áŸ’ášáŸ‚á€áŸ†áááŸ‹ááŸ’ášá¶";
            } else {
                resetFormUI(formElement);
            }
            lucide.createIcons();
        }
        
        function resetFormUI(formElement) {
            const submitBtn = formElement.querySelector('#submit-btn');
            const cancelBtn = formElement.querySelector('#cancel-btn');
            
            submitBtn.innerHTML = '<i data-lucide="plus" class="w-5 h-5 mr-1"></i> á”á“áŸ’ááŸ‚á˜á€áŸ†áááŸ‹ááŸ’ášá¶';
            submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            cancelBtn.classList.add('hidden');
            
            document.getElementById('main-form-title').textContent = "â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸";
            const mobileTitle = document.getElementById('mobile-form-title');
            if(mobileTitle) mobileTitle.textContent = "â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸";
            
            updateAmountSummary(formElement);
        }

        function resetForm() {
            editingID = null;
            const desktopForm = document.getElementById('expense-form');
            const mobileForm = document.getElementById('mobile-expense-form');
            desktopForm.reset();
            mobileForm.reset();
            resetFormUI(desktopForm);
            resetFormUI(mobileForm);
            activeFormElement = null; 
            lucide.createIcons();
            updateAmountSummary(desktopForm);
            updateAmountSummary(mobileForm);
        }

        async function handleFormSubmission(e, source) {
            e.preventDefault();
            const formElement = source === 'mobile' ? document.getElementById('mobile-expense-form') : document.getElementById('expense-form');
            
            const date = formElement.querySelector("#date").value;
            const meat = parseFloat(formElement.querySelector("#meat").value) || 0;
            const vegetable = parseFloat(formElement.querySelector("#vegetable").value) || 0;
            const fruit = parseFloat(formElement.querySelector("#fruit").value) || 0;
            const desc = formElement.querySelector("#desc").value;
            const type = 'Expense'; 
            
            const submitBtn = formElement.querySelector("#submit-btn");

            if (!date || (meat + vegetable + fruit) <= 0) {
                showToast("âš ï¸ áŸá¼á˜á”áŸ†á–áŸá‰á€á¶á›á”ášá·á…áŸ’á†áŸá‘ á“á·á„ááŸ’ášá¼áœááŸ‚á˜á¶á“á…áŸ†á“á½á“á”áŸ’ášá¶á€áŸ‹á…áŸ†áá¶á™áŸášá»á”!", 'warning');
                return;
            }

            const originalText = submitBtn.textContent;
            submitBtn.innerHTML = editingID ? '<i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-1"></i> á€áŸ†á–á»á„á€áŸ‚á”áŸ’ášáŸ‚...' : '<i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-1"></i> á€áŸ†á–á»á„á”á“áŸ’ááŸ‚á˜...';
            lucide.createIcons();
            submitBtn.disabled = true;

            const recordData = {
                Date: date,
                Type: type,
                Meat: meat, 
                Vegetable: vegetable, 
                Fruit: fruit, 
                Description: desc,
                ModifiedDate: new Date().toISOString()
            };

            let res;
            if (editingID) {
                const url = `${SHEETDB_BASE_URL}/ID/${editingID}?sheet=${SHEET_EXPENSES}`;
                res = await fetch(url, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ data: [recordData] })
                });
                if (res.ok) showToast("âœ… á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“á€áŸ‚á”áŸ’ášáŸ‚áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!", 'success');
            } else {
                const payload = {
                    data: [{
                        ID: Date.now(),
                        Date: date,
                        Type: type,
                        Meat: meat,
                        Vegetable: vegetable,
                        Fruit: fruit,
                        Description: desc,
                        UserEmail: user.Email,
                        Status: "Active",
                        ModifiedDate: new Date().toISOString()
                    }]
                };
                res = await fetch(sheetUrl(SHEET_EXPENSES), {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                if (res.ok) showToast("âœ… á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“á”á“áŸ’ááŸ‚á˜áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!", 'success');
            }

            if (res.ok) {
                if(source === 'mobile') closeFormModal();
                resetForm();
                setTimeout(loadAllData, 1500); 
            } else {
                showToast("âŒ á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá”ášá¶á‡áŸá™áŸ”", 'error');
            }

            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            lucide.createIcons();
        }

        async function deleteExpense(id) {
            const confirmed = await customConfirm(
                "á”á‰áŸ’á‡á¶á€áŸ‹á€á¶ášá›á»á”á”ááŸ’áŠáŸ„áŸ‡á¢á¶áŸá“áŸ’á“",
                "á€áŸ†áááŸ‹ááŸ’ášá¶á“áŸáŸ‡á“á¹á„ááŸ’ášá¼áœá”á¶á“á•áŸ’á›á¶áŸáŸ‹á‘áŸ…á€á¶á“áŸ‹á’á»á„áŸáŸ†ášá¶á˜áŸ” áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠá‘áŸ?",
                "á•áŸ’á›á¶áŸáŸ‹á‘áŸ…á’á»á„áŸáŸ†ášá¶á˜",
                "delete"
            );
            if (confirmed) { await updateStatus(id, "Deleted", "á›á»á”á”ááŸ’áŠáŸ„áŸ‡á¢á¶áŸá“áŸ’á“"); }
        }
        
        async function restoreExpense(id) {
            const confirmed = await customConfirm(
                "á”á‰áŸ’á‡á¶á€áŸ‹á€á¶ášá‘á¶á‰á™á€á˜á€áœá·á‰",
                "áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á‘á¶á‰á™á€á€áŸ†áááŸ‹ááŸ’ášá¶á“áŸáŸ‡ááŸ’ášá¡á”áŸ‹á˜á€áœá·á‰á‘áŸ?",
                "á‘á¶á‰á™á€á˜á€áœá·á‰",
                "restore"
            );
            if (confirmed) { await updateStatus(id, "Active", "á‘á¶á‰á™á€á˜á€áœá·á‰"); }
        }
        
        async function permanentDeleteExpense(id) {
            const confirmed = await customConfirm(
                "âš ï¸ á›á»á”á‡á¶á¢á…á·á“áŸ’ááŸ’ášáŸƒá™áŸ",
                "á€áŸ†áááŸ‹ááŸ’ášá¶á“áŸáŸ‡á“á¹á„ááŸ’ášá¼áœá›á»á”á…áŸá‰á–á¸á”áŸ’ášá–áŸá“áŸ’á’á‘á¶áŸ†á„áŸáŸ’ášá»á„ á á¾á™á˜á·á“á¢á¶á…á™á€á˜á€áœá·á‰á”á¶á“á‘áŸáŸ” áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠá‘áŸ?",
                "á›á»á”á‡á¶á¢á…á·á“áŸ’ááŸ’ášáŸƒá™áŸ",
                "permanent_delete"
            );
            
            if (!confirmed) return;
            const url = `${SHEETDB_BASE_URL}/ID/${id}?sheet=${SHEET_EXPENSES}`;
            const res = await fetch(url, { method: "DELETE" });

            if (res.ok) {
                showToast("ğŸ—‘ï¸ á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“á›á»á”á‡á¶á¢á…á·á“áŸ’ááŸ’ášáŸƒá™áŸáŠáŸ„á™á‡áŸ„á‚á‡áŸá™áŸ”", 'success'); 
                loadAllData();
            } else {
                showToast("âŒ á€á¶ášá›á»á”á”ášá¶á‡áŸá™áŸ”", 'error'); 
            }
        }
        
        async function updateStatus(id, newStatus, actionName) {
            const url = `${SHEETDB_BASE_URL}/ID/${id}?sheet=${SHEET_EXPENSES}`;
            const res = await fetch(url, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data: [{ Status: newStatus, ModifiedDate: new Date().toISOString() }] })
            });

            if (res.ok) {
                showToast(`âœ… á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“${actionName}áŠáŸ„á™á‡áŸ„á‚á‡áŸá™áŸ”`, 'success'); 
                setTimeout(loadAllData, 1500);
            } else {
                showToast("âŒ á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá”ášá¶á‡áŸá™áŸ”", 'error'); 
            }
        }

        async function exportData(format) {
            const dataToExport = filteredDataForReport; 
            const filterMonth = document.getElementById('filter-month').value;
            const filterYear = document.getElementById('filter-year').value;
            const reportName = `ášá”á¶á™á€á¶ášááŸ_${MONTH_NAMES[filterMonth] || 'á‘á¶áŸ†á„á¢áŸáŸ‹'}_${filterYear || 'á‘á¶áŸ†á„á¢áŸáŸ‹'}`;

            if (dataToExport.length === 0) {
                showToast("âš ï¸ á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŸá˜áŸ’ášá¶á”áŸ‹á‘á¶á‰á™á€á‘áŸáŸ” áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸášá”á¶á™á€á¶ášááŸá•áŸ’áŸáŸá„á‘áŸ€ááŸ”", 'warning', 6000); 
                return;
            }
            
            // --- EXCEL EXPORT ---
            if (format === 'excel') {
                const structuredData = dataToExport.map(x => ({
                    'á€á¶á›á”ášá·á…áŸ’á†áŸá‘': x.Date,
                    'á”áŸ’ášá—áŸá‘': x.Type, 
                    'áŸášá»á”á”áŸ’ášá¶á€áŸ‹ (áŸ›)': parseFloat(x.Amount) || 0,
                    'áŸá¶á…áŸ‹ (áŸ›)': parseFloat(x.Meat) || 0,
                    'á”á“áŸ’á›áŸ‚ (áŸ›)': parseFloat(x.Vegetable) || 0,
                    'á•áŸ’á›áŸ‚áˆá¾ (áŸ›)': parseFloat(x.Fruit) || 0,
                    'á–á·á–ááŸŒá“á¶': x.Description || '',
                    'áŸáŸ’áá¶á“á—á¶á–': x.Status
                }));
                
                if (typeof XLSX === 'undefined') {
                    showToast("âŒ á€áŸ†á á»áŸ! SheetJS (XLSX) library á˜á·á“ááŸ’ášá¼áœá”á¶á“á•áŸ’á‘á»á€á‘áŸáŸ”", 'error');
                    return;
                }
                
                try {
                    const workbook = XLSX.utils.book_new();
                    const worksheet = XLSX.utils.json_to_sheet(structuredData);
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'ExpenseData');
                    XLSX.writeFile(workbook, `${reportName}_${new Date().toISOString().slice(0,10)}.xlsx`);
                    showToast(`âœ… á¯á€áŸá¶áš Excel (.xlsx) ááŸ’ášá¼áœá”á¶á“á‘á¶á‰á™á€áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!`, 'success');
                } catch (error) {
                    console.error("Excel Export Failed:", error);
                    showToast("âŒ á€á¶ášá‘á¶á‰á™á€á¯á€áŸá¶áš Excel á”ášá¶á‡áŸá™áŸ”", 'error');
                }

            } 
            // --- PDF EXPORT ---
            else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                // Target the list section when exporting
                const inputElement = document.getElementById('data-view-section'); 
                
                document.querySelectorAll('.item-actions').forEach(el => el.style.display = 'none');
                
                const pdfBtn = document.querySelector('button[onclick="exportData(\'pdf\')"]');
                const originalPdfBtnContent = pdfBtn.innerHTML;
                pdfBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 mr-1"></i> á€áŸ†á–á»á„ášáŸ€á”á…áŸ† PDF...';
                pdfBtn.disabled = true;

                try {
                    const canvas = await html2canvas(inputElement, {
                        scale: 2, 
                        useCORS: true, 
                        windowWidth: inputElement.scrollWidth,
                        windowHeight: inputElement.scrollHeight
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    const imgHeight = canvas.height * pdfWidth / canvas.width;
                    let position = 25; 
                    
                    // Add Title Header
                    pdf.setFontSize(18);
                    pdf.text(`ášá”á¶á™á€á¶ášááŸá…áŸ†áá¶á™: ${reportName}`, 10, 10);
                    pdf.setFontSize(10);
                    pdf.text(`á€á¶á›á”ášá·á…áŸ’á†áŸá‘á”á„áŸ’á€á¾á: ${new Date().toLocaleDateString('km-KH')}`, 10, 17);
                    
                    let heightLeft = imgHeight;
                    let imgX = 0; 

                    while (heightLeft > 0) {
                        pdf.addImage(imgData, 'JPEG', imgX, position, pdfWidth, imgHeight, undefined, 'FAST');
                        heightLeft -= pdfHeight - 20; 
                        position -= pdfHeight - 20;
                        
                        if (heightLeft > 0) { 
                            pdf.addPage();
                            position = 10; 
                        }
                    }

                    pdf.save(`${reportName}_Report_${new Date().toISOString().slice(0,10)}.pdf`);
                    showToast(`âœ… á¯á€áŸá¶áš PDF ááŸ’ášá¼áœá”á¶á“á‘á¶á‰á™á€áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!`, 'success');

                } catch(error) {
                    console.error("PDF Export failed:", error);
                    showToast("âŒ á€á¶ášá‘á¶á‰á™á€ PDF á”ášá¶á‡áŸá™áŸ”", 'error');
                } finally {
                    document.querySelectorAll('.item-actions').forEach(el => el.style.display = 'flex');
                    pdfBtn.innerHTML = originalPdfBtnContent; 
                    pdfBtn.disabled = false;
                    lucide.createIcons(); 
                }
            }
        }

        // --- Execute Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check for authentication immediately
            if (!user) return;

            // 1. Set up forms and load data
            setupForms();
            loadAllData();
            
            // 2. Initial view setup (Show dashboard by default)
            showView('dashboard');
        });
    </script>
</body>
</html>
