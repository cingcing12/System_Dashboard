<!DOCTYPE html>
<html lang="km">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ - á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™á‚áŸ’ášá¿á„á‘áŸáŸ</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <script src="https://unpkg.com/lucide@latest"></script>
Â  Â  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Khmer+OS+Battambang:wght@400;600;700&display=swap');
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Khmer OS Battambang', sans-serif;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Simple hide scrollbar */
Â  Â  Â  Â  .hide-scrollbar::-webkit-scrollbar { display: none; }
Â  Â  Â  Â  .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

Â  Â  Â  Â  /* General Modal Styling */
Â  Â  Â  Â  .modal {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  inset: 0;
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.65);
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  z-index: 999;
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(3px);
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal.active { display:flex; }

Â  Â  Â  Â  /* Custom status badges (Slightly improved colors) */
Â  Â  Â  Â  .badge-expense { background-color: #fee2e2; color: #b91c1c; }
Â  Â  Â  Â  .badge-income { background-color: #dcfce7; color: #15803d; }
Â  Â  Â  Â  .badge-deleted { background-color: #f3f4f6; color: #6b7280; }

Â  Â  Â  Â  /* Modern shadow for cards */
Â  Â  Â  Â  .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }

Â  Â  Â  Â  /* Dropdown */
Â  Â  Â  Â  .dropdown { position: relative; }
Â  Â  Â  Â  .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; min-width: 200px; background-color: white; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); z-index: 100; margin-top: 10px; }
Â  Â  Â  Â  .dropdown-menu.active { display: block; }

Â  Â  Â  Â  /* List Item Hover Effect */
Â  Â  Â  Â  .expense-item {
Â  Â  Â  Â  Â  Â  transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
Â  Â  Â  Â  Â  Â  border: 1px solid #e5e7eb; /* Added subtle border */
Â  Â  Â  Â  }
Â  Â  Â  Â  .expense-item:hover {
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transform: translateY(-3px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 12px 20px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* FAB forced visibility on mobile via CSS */
Â  Â  Â  Â  #fab-add-btn {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 20px;
Â  Â  Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  Â  Â  z-index: 50;
Â  Â  Â  Â  Â  Â  width: 60px;
Â  Â  Â  Â  Â  Â  height: 60px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
Â  Â  Â  Â  }
Â  Â  Â  Â  @media(max-width:1023px){ /* Smaller than lg */
Â  Â  Â  Â  Â  Â  #fab-add-btn{
Â  Â  Â  Â  Â  Â  Â  Â  display: inline-flex !important;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Mobile Modal Fix (Ensures the modal form is 100% on small screens) */
Â  Â  Â  Â  #mobileFormModal .modal-content-mobile {
Â  Â  Â  Â  Â  Â  width: 95%; /* Limit width slightly on small screens */
Â  Â  Â  Â  Â  Â  max-width: 480px; /* Max-width for mobile modal */
Â  Â  Â  Â  Â  Â  margin: 20px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Improved Form Visibility Logic: Hide/Show based on screen size */
Â  Â  Â  Â  #main-expense-form-container {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  @media (min-width: 1024px) {
Â  Â  Â  Â  Â  Â  #main-expense-form-container {
Â  Â  Â  Â  Â  Â  Â  Â  display: block !important;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Hide the mobile modal on desktop */
Â  Â  Â  Â  @media (min-width: 1024px) {
Â  Â  Â  Â  Â  Â  #mobileFormModal {
Â  Â  Â  Â  Â  Â  Â  Â  display: none !important;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  /* New PDF styles to prevent cutoff issues when generating the PDF */
Â  Â  Â  Â  @media print {
Â  Â  Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  Â  Â  -webkit-print-color-adjust: exact !important;
Â  Â  Â  Â  Â  Â  Â  Â  print-color-adjust: exact !important;
Â  Â  Â  Â  Â  Â  Â  Â  background-color: #ffffff !important;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .card-shadow { box-shadow: none !important; border: 1px solid #ccc; }
Â  Â  Â  Â  Â  Â  .hide-on-print { display: none !important; }
Â  Â  Â  Â  Â  Â  /* Force list items to not break across pages badly */
Â  Â  Â  Â  Â  Â  .expense-item { page-break-inside: avoid; }

Â  Â  Â  Â  Â  Â  /* Hide unnecessary elements for printing */
Â  Â  Â  Â  Â  Â  header, #fab-add-btn, .item-actions, #main-expense-form-container, #report-controls, #report-tabs { display: none !important; }

Â  Â  Â  Â  Â  Â  /* Force the report content to show up for printing */
Â  Â  Â  Â  Â  Â  #report-tab { display: block !important; }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Custom Confirmation Modal Styling */
Â  Â  Â  Â  .confirm-modal-content {
Â  Â  Â  Â  Â  Â  animation: fadeInScale 0.3s ease-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes fadeInScale {
Â  Â  Â  Â  Â  Â  from { opacity: 0; transform: scale(0.9) translateY(-20px); }
Â  Â  Â  Â  Â  Â  to { opacity: 1; transform: scale(1) translateY(0); }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="bg-gray-50">

Â  Â  <div id="toast-container" class="fixed top-4 right-4 z-[1000] space-y-3 pointer-events-none">
Â  Â  </div>

Â  Â  <div id="customConfirmModal" class="modal">
Â  Â  Â  Â  <div class="confirm-modal-content bg-white rounded-2xl p-8 w-full max-w-sm relative shadow-2xl">
Â  Â  Â  Â  Â  Â  <div id="confirm-icon-box" class="w-12 h-12 rounded-full mx-auto mb-4 flex items-center justify-center text-white bg-red-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <h3 id="confirm-title" class="text-xl font-bold text-gray-800 mb-2 text-center">áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠá‘áŸ?</h3>
Â  Â  Â  Â  Â  Â  <p id="confirm-message" class="text-gray-600 mb-6 text-center text-sm">á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá“áŸáŸ‡á˜á·á“á¢á¶á…ááŸ’ášá›á”áŸ‹á€áŸ’ášáŸ„á™á”á¶á“á‘áŸáŸ”</p>

Â  Â  Â  Â  Â  Â  <div class="flex justify-center space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="resolveCustomConfirm(false)" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”áŸ„áŸ‡á”á„áŸ‹</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="confirm-action-btn" onclick="resolveCustomConfirm(true)" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition">á™á›áŸ‹á–áŸ’ášá˜</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <header class="bg-white shadow-md p-4 sticky top-0 z-50 border-b border-gray-200">
Â  Â  Â  Â  <div class="max-w-7xl mx-auto flex justify-between items-center">
Â  Â  Â  Â  Â  Â  <h1 class="text-xl sm:text-3xl font-bold text-blue-700 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="wallet" class="w-6 h-6 sm:w-7 sm:h-7 mr-2 sm:mr-3 text-indigo-500"></i>
Â  Â  Â  Â  Â  Â  Â  Â  á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™
Â  Â  Â  Â  Â  Â  </h1>

Â  Â  Â  Â  Â  Â  <div class="dropdown">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="toggleDropdown(event)" class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-semibold hover:bg-indigo-600 transition duration-150 relative ring-2 ring-indigo-300 ring-offset-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="user" class="w-6 h-6"></i>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="profile-dropdown-menu" class="dropdown-menu">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 border-b text-center bg-gray-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-gray-800 truncate" id="dropdown-email">Loading...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-indigo-500" id="dropdown-role">Loading...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="user.html" id="user-management-link" class="hidden items-center p-3 hover:bg-indigo-50 transition text-purple-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="users" class="w-4 h-4 mr-2"></i> á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¢áŸ’á“á€á”áŸ’ášá¾
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" onclick="openProfileModal(); return false;" class="flex items-center p-3 hover:bg-gray-50 transition text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="user-cog" class="w-4 h-4 mr-2"></i> á–áŸááŸŒá˜á¶á“á‚áá“á¸
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" onclick="customLogout(); return false;" class="flex items-center p-3 hover:bg-red-50 transition text-red-600 border-t mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> á…á¶á€á…áŸá‰
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <main class="max-w-7xl mx-auto p-4 md:p-8">

        <div id="report-tabs" class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-4">
                <button id="tab-dashboard-btn" onclick="setActiveTab('dashboard')" class="py-2 px-4 text-lg font-semibold text-indigo-600 border-b-2 border-indigo-600 transition duration-150 flex items-center">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-2"></i> á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„
                </button>
                <button id="tab-report-btn" onclick="setActiveTab('report')" class="py-2 px-4 text-lg font-medium text-gray-500 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700 transition duration-150 flex items-center">
                    <i data-lucide="file-text" class="w-5 h-5 mr-2"></i> ášá”á¶á™á€á¶ášááŸ / á”á‰áŸ’á‡á¸
                </button>
            </nav>
        </div>

        <div id="dashboard-tab" class="tab-content" style="display: block;">
            <section class="mb-8">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-red-500 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="receipt" class="w-4 h-4 mr-2 text-red-500"></i> á…áŸ†áá¶á™áŸášá»á”ášá½á˜</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-600 truncate" id="total-expense-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-red-400 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="calendar-check" class="w-4 h-4 mr-2 text-red-400"></i> á…áŸ†áá¶á™ááŸ’á„áŸƒá“áŸáŸ‡</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-500 truncate" id="today-expense-summary">0 áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-red-300 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="calendar" class="w-4 h-4 mr-2 text-red-300"></i> á…áŸ†áá¶á™á”áŸ’ášá…á¶áŸ†ááŸ‚</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-red-400 truncate" id="monthly-expense-summary">0 áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-gray-400 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="hash" class="w-4 h-4 mr-2 text-gray-500"></i> á…áŸ†á“á½á“á€áŸ†áááŸ‹ááŸ’ášá¶</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-gray-700" id="total-count-summary">-- á€áŸ†áááŸ‹ááŸ’ášá¶</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mt-4">
                    <div class="lg:col-span-1 hidden lg:block"></div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-orange-500 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="utensils" class="w-4 h-4 mr-2 text-orange-500"></i> áŸá¶á…áŸ‹áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-orange-600 truncate" id="meat-total-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-green-500 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="leaf" class="w-4 h-4 mr-2 text-green-500"></i> á”á“áŸ’á›áŸ‚áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-green-600 truncate" id="vegetable-total-summary">-- áŸ›</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-xl card-shadow border-l-4 border-yellow-500 hover:shadow-lg transition">
                        <p class="text-sm text-gray-500 flex items-center mb-1"><i data-lucide="apple" class="w-4 h-4 mr-2 text-yellow-500"></i> á•áŸ’á›áŸ‚áˆá¾áŸášá»á”</p>
                        <p class="text-2xl sm:text-4xl font-extrabold text-yellow-600 truncate" id="fruit-total-summary">-- áŸ›</p>
                    </div>
                </div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <section id="main-expense-form-container" class="lg:col-span-1 bg-white p-6 rounded-2xl card-shadow h-fit lg:sticky lg:top-24 border border-gray-100">
                    <h2 class="text-2xl font-bold mb-6 text-indigo-600 border-b pb-3" id="main-form-title">â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸</h2>
                    <form id="expense-form" class="space-y-4">
                    </form>
                </section>
                
                <div class="lg:col-span-3">
                    <div class="p-8 bg-indigo-50 border-2 border-dashed border-indigo-200 rounded-xl flex items-center justify-center">
                        <p class="text-indigo-600 font-semibold text-lg flex items-center"><i data-lucide="lightbulb" class="w-6 h-6 mr-3"></i> á”áŸ’ášá¾á•áŸ’á“áŸ‚á€ "ášá”á¶á™á€á¶ášááŸ / á”á‰áŸ’á‡á¸" áŠá¾á˜áŸ’á”á¸á˜á¾á›á”á‰áŸ’á‡á¸á›á˜áŸ’á¢á·á á“á·á„á‘á¶á‰á™á€á‘á·á“áŸ’á“á“áŸá™áŸ”</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="report-tab" class="tab-content" style="display: none;">
            <section id="data-view-section" class="bg-white p-4 sm:p-6 rounded-2xl card-shadow border border-gray-100">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-2">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-700 mb-2 sm:mb-0">á”á‰áŸ’á‡á¸á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá…áŸ†áá¶á™</h2>
                    <button onclick="switchView('trash')" id="trash-btn" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg transition flex items-center font-semibold text-sm shadow-sm">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> á€áŸ†áááŸ‹ááŸ’ášá¶áŠáŸ‚á›á”á¶á“á›á»á”
                    </button>
                </div>

                <div id="report-controls" class="mb-6 p-4 border rounded-xl bg-gray-50">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                        <div class="sm:col-span-1">
                            <label for="report-type" class="block text-xs font-medium text-gray-500 mb-1">ášá”á¶á™á€á¶ášááŸáŸášá»á”áá¶á˜:</label>
                            <select id="report-type" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onchange="filterRecords()">
                                <option value="all">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
                                <option value="daily">á”áŸ’ášá…á¶áŸ†ááŸ’á„áŸƒ</option>
                                <option value="monthly">á”áŸ’ášá…á¶áŸ†ááŸ‚</option>
                                <option value="yearly">á”áŸ’ášá…á¶áŸ†á†áŸ’á“á¶áŸ†</option>
                            </select>
                        </div>
                        <div class="sm:col-span-2">
                            <label for="search-input" class="block text-xs font-medium text-gray-500 mb-1">áŸáŸ’áœáŸ‚á„ášá€ (áá¶á˜á–á·á–ááŸŒá“á¶):</label>
                            <input type="text" id="search-input" oninput="filterRecords()" placeholder="á§. á‘á·á‰á˜áŸ’á á¼á” áŸá˜áŸ’ášá¶á”áŸ‹á–á·á’á¸" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <div class="flex flex-wrap justify-end gap-3 border-t pt-3 mt-3">
                        <button onclick="exportData('pdf')" class="bg-red-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-red-700 transition text-sm font-semibold shadow-md">
                            <i data-lucide="file-text" class="w-4 h-4 mr-1"></i> á‘á¶á‰á™á€ PDF
                        </button>
                        <button onclick="exportData('excel')" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-green-700 transition text-sm font-semibold shadow-md">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-1"></i> á‘á¶á‰á™á€ Excel
                        </button>
                    </div>
                </div>

                <div id="expense-list" class="space-y-3 max-h-[65vh] overflow-y-auto pr-2 hide-scrollbar">
                    <p class="text-center text-gray-500 py-10">á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</p>
                </div>
            </section>
        </div>
Â  Â  </main>

Â  Â  <button id="fab-add-btn" onclick="openFormModal()" class="bg-indigo-600 text-white transition hover:bg-indigo-700 ring-4 ring-indigo-300 ring-offset-2">
Â  Â  Â  Â  <i data-lucide="plus" class="w-8 h-8"></i>
Â  Â  </button>

Â  Â  <div id="profileModal" class="modal">
Â  Â  Â  Â  <div class="bg-white rounded-2xl p-8 w-full max-w-md relative shadow-2xl">
Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2">á–áŸááŸŒá˜á¶á“á‚áá“á¸</h3>

Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 bg-gray-50 rounded-lg border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-gray-500">á¢áŸŠá¸á˜áŸ‰áŸ‚á›</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-gray-800" id="modal-profile-email">N/A</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 bg-gray-50 rounded-lg border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-gray-500">áá½á“á¶á‘á¸</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-indigo-700" id="modal-profile-role">N/A</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="closeProfileModal()" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”á·á‘</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="customLogout()" class="px-6 py-3 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition">á…á¶á€á…áŸá‰</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="x" class="w-6 h-6"></i>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="detailModal" class="modal">
Â  Â  Â  Â  <div class="bg-white rounded-2xl p-8 w-full max-w-lg relative shadow-2xl transform transition-all">
Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold text-blue-700 mb-6 border-b pb-2 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-gray-500"></i> á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·áá€áŸ†áááŸ‹ááŸ’ášá¶
Â  Â  Â  Â  Â  Â  </h3>

Â  Â  Â  Â  Â  Â  <div class="space-y-4 text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 bg-gray-50 rounded-lg border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-1"></i> á€á¶á›á”ášá·á…áŸ’á†áŸá‘</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-base" id="detail-date">N/A</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 bg-gray-50 rounded-lg border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="tag" class="w-4 h-4 mr-1"></i> á”áŸ’ášá—áŸá‘á”áŸ’ášáá·á”ááŸ’áá·á€á¶áš</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-base text-red-600" id="detail-type">á…áŸ†áá¶á™ ğŸ“‰</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-red-50 rounded-xl border border-red-200 shadow-inner">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-red-700">á…áŸ†á“á½á“á”áŸ’ášá¶á€áŸ‹áŸášá»á” (Amount)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-3xl font-extrabold mt-1 text-red-600" id="detail-amount">-- áŸ›</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-3 gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 bg-white rounded-lg border shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-gray-500">áŸá¶á…áŸ‹</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-base text-orange-600" id="detail-meat">0 áŸ›</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 bg-white rounded-lg border shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-gray-500">á”á“áŸ’á›áŸ‚</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-base text-green-600" id="detail-vegetable">0 áŸ›</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 bg-white rounded-lg border shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-xs font-medium text-gray-500">á•áŸ’á›áŸ‚áˆá¾</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-base text-yellow-600" id="detail-fruit">0 áŸ›</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 bg-gray-50 rounded-lg border">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-medium text-gray-500 flex items-center"><i data-lucide="align-left" class="w-4 h-4 mr-1"></i> á–á·á–ááŸŒá“á¶á›á˜áŸ’á¢á·á</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="detail-desc" class="whitespace-pre-wrap text-sm">N/A</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-500 pt-3 flex justify-between">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>á€áŸ‚á”áŸ’ášáŸ‚á…á»á„á€áŸ’ášáŸ„á™: <span id="detail-modified">N/A</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>áŸáŸ’áá¶á“á—á¶á–: <span id="detail-status" class="font-semibold">N/A</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="editExpense(activeDetailRecord.ID, true);" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition flex items-center shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="pencil" class="w-5 h-5 mr-2"></i> á€áŸ‚á”áŸ’ášáŸ‚
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="closeDetailModal()" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition">á”á·á‘</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <button onclick="closeDetailModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="x" class="w-6 h-6"></i>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="mobileFormModal" class="modal">
Â  Â  Â  Â  <div class="modal-content-mobile bg-white rounded-2xl p-6 w-full relative shadow-2xl">
Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold text-indigo-600 mb-6 border-b pb-2" id="mobile-form-title">â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸</h3>
Â  Â  Â  Â  Â  Â  <form id="mobile-expense-form" class="space-y-4">
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  <button onclick="closeFormModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="x" class="w-6 h-6"></i>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="form-template" style="display: none;">
Â  Â  Â  Â  <input type="hidden" id="record-id" value="">

Â  Â  Â  Â  <label for="date" class="block text-sm font-medium text-gray-700">á€á¶á›á”ášá·á…áŸ’á†áŸá‘</label>
Â  Â  Â  Â  <input id="date" type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-600 focus:border-indigo-600 transition" required>

Â  Â  Â  Â  <div class="grid grid-cols-3 gap-3 border p-3 rounded-lg bg-gray-50">
Â  Â  Â  Â  Â  Â  <div class="col-span-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-base font-semibold text-gray-800 mb-2">á…áŸ†á“á½á“á”áŸ’ášá¶á€áŸ‹áŸášá»á” (Amount)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="amount-summary" type="text" class="w-full p-3 text-2xl font-extrabold text-red-600 bg-white border border-red-300 rounded-lg" value="0 áŸ›" readonly>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="amount" value="0"> </div>

Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="meat" class="block text-sm font-medium text-gray-700">áŸá¶á…áŸ‹ ($)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="meat" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-orange-600 focus:border-orange-600 transition expense-input" placeholder="0">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="vegetable" class="block text-sm font-medium text-gray-700">á”á“áŸ’á›áŸ‚ ($)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="vegetable" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-600 focus:border-green-600 transition expense-input" placeholder="0">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="fruit" class="block text-sm font-medium text-gray-700">á•áŸ’á›áŸ‚áˆá¾ ($)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="fruit" type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-600 focus:border-yellow-600 transition expense-input" placeholder="0">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <input id="category" type="hidden" value="Grocery">
Â  Â  Â  Â  <input id="type" type="hidden" value="Expense">

Â  Â  Â  Â  <label for="desc" class="block text-sm font-medium text-gray-700">á–á·á–ááŸŒá“á¶á›á˜áŸ’á¢á·á (á”á“áŸ’ááŸ‚á˜)</label>
Â  Â  Â  Â  <textarea id="desc" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-600 focus:border-indigo-600 transition" placeholder="á…áŸ†áá¶á™á›á¾á¢áŸ’áœá¸ááŸ’á›áŸ‡..."></textarea>

Â  Â  Â  Â  <button type="submit" id="submit-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150 flex items-center justify-center shadow-lg mt-6">
Â  Â  Â  Â  Â  Â  <i data-lucide="plus" class="w-5 h-5 mr-1"></i> á”á“áŸ’ááŸ‚á˜á€áŸ†áááŸ‹ááŸ’ášá¶
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <button type="button" id="cancel-btn" onclick="resetForm()" class="w-full bg-gray-300 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-400 transition duration-150 hidden mt-2">
Â  Â  Â  Â  Â  Â  <i data-lucide="x" class="w-5 h-5 mr-1"></i> á”áŸ„áŸ‡á”á„áŸ‹á€á¶ášá€áŸ‚á”áŸ’ášáŸ‚
Â  Â  Â  Â  </button>
Â  Â  </div>


Â  Â  <script src="config.js"></script>
Â  Â  <script>
Â  Â  Â  Â  // --- GLOBAL STATE ---
Â  Â  Â  Â  const user = JSON.parse(localStorage.getItem("user"));
Â  Â  Â  Â  let allExpenses = [];
Â  Â  Â  Â  let currentView = 'active';
        let activeTab = 'dashboard'; // NEW: Track active tab
Â  Â  Â  Â  let editingID = null;
Â  Â  Â  Â  let activeDetailRecord = null;
Â  Â  Â  Â  let customConfirmResolver;
Â  Â  Â  Â  let activeFormElement = null;

Â  Â  Â  Â  // --- NEW: TAB SWITCHING FUNCTION ---
        function setActiveTab(tabName) {
            activeTab = tabName;

            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${tabName}-tab`).style.display = 'block';

            document.querySelectorAll('#report-tabs button').forEach(btn => {
                btn.classList.remove('text-indigo-600', 'border-indigo-600');
                btn.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
            });

            const activeBtn = document.getElementById(`tab-${tabName}-btn`);
            activeBtn.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');
            activeBtn.classList.add('text-indigo-600', 'border-indigo-600');

            // Hide FAB button in Report tab on mobile (since it's a list view)
            if (window.innerWidth < 1024) {
                document.getElementById('fab-add-btn').style.display = tabName === 'dashboard' ? 'inline-flex' : 'none';
            }
            
            lucide.createIcons();
            // In case of switching to report tab, ensure a fresh view is loaded
            if (tabName === 'report') {
                 filterRecords();
            }
        }


Â  Â  Â  Â  // --- NEW: TOAST NOTIFICATION FUNCTION (UNCHANGED) ---
Â  Â  Â  Â  function showToast(message, type = 'info', duration = 4000) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('toast-container');
Â  Â  Â  Â  Â  Â  if (!container) return;
Â  Â  Â  Â  Â  Â  let bgColor, icon, iconColor;
Â  Â  Â  Â  Â  Â  switch (type) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'success': bgColor = 'bg-green-600'; icon = 'check-circle'; iconColor = 'text-green-200'; break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'error': bgColor = 'bg-red-600'; icon = 'x-circle'; iconColor = 'text-red-200'; break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'warning': bgColor = 'bg-yellow-500'; icon = 'alert-triangle'; iconColor = 'text-yellow-200'; break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'info': default: bgColor = 'bg-blue-600'; icon = 'info'; iconColor = 'text-blue-200'; break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const toast = document.createElement('div');
Â  Â  Â  Â  Â  Â  toast.className = `p-4 max-w-sm w-full rounded-lg shadow-xl text-white flex items-center space-x-3 transform transition-all ease-in-out duration-300 opacity-0 translate-x-full pointer-events-auto ${bgColor}`;
Â  Â  Â  Â  Â  Â  toast.style.minWidth = '250px';
Â  Â  Â  Â  Â  Â  toast.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="${icon}" class="w-6 h-6 ${iconColor} flex-shrink-0"></i>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-medium text-sm flex-1">${message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="this.closest('div').remove()" class="p-1 -mr-1 rounded-full hover:bg-white/20 transition-all flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="x" class="w-4 h-4 text-white"></i>
Â  Â  Â  Â  Â  Â  Â  Â  </button>`;
Â  Â  Â  Â  Â  Â  container.appendChild(toast);
Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  toast.classList.remove('opacity-0', 'translate-x-full');
Â  Â  Â  Â  Â  Â  Â  Â  toast.classList.add('opacity-100', 'translate-x-0');
Â  Â  Â  Â  Â  Â  }, 50);
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  toast.classList.remove('opacity-100', 'translate-x-0');
Â  Â  Â  Â  Â  Â  Â  Â  toast.classList.add('opacity-0', 'translate-x-full');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => toast.remove(), 300);
Â  Â  Â  Â  Â  Â  }, duration);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- NEW: CUSTOM CONFIRMATION MODAL FUNCTION (UNCHANGED) ---
Â  Â  Â  Â  function customConfirm(title, message, actionText, type = 'delete') {
Â  Â  Â  Â  Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  Â  Â  Â  Â  const modal = document.getElementById('customConfirmModal');
Â  Â  Â  Â  Â  Â  Â  Â  const titleEl = document.getElementById('confirm-title');
Â  Â  Â  Â  Â  Â  Â  Â  const messageEl = document.getElementById('confirm-message');
Â  Â  Â  Â  Â  Â  Â  Â  const actionBtn = document.getElementById('confirm-action-btn');
Â  Â  Â  Â  Â  Â  Â  Â  const iconBox = document.getElementById('confirm-icon-box');
Â  Â  Â  Â  Â  Â  Â  Â  actionBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700', 'bg-red-800', 'hover:bg-red-900', 'bg-indigo-600', 'hover:bg-indigo-700', 'bg-blue-600', 'hover:bg-blue-700');
Â  Â  Â  Â  Â  Â  Â  Â  iconBox.className = 'w-12 h-12 rounded-full mx-auto mb-4 flex items-center justify-center';
Â  Â  Â  Â  Â  Â  Â  Â  let iconHtml = '';

Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'delete') { actionBtn.classList.add('bg-red-600', 'hover:bg-red-700'); iconBox.classList.add('bg-red-100'); iconHtml = '<i data-lucide="trash-2" class="w-6 h-6 text-red-600"></i>';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (type === 'permanent_delete') { actionBtn.classList.add('bg-red-800', 'hover:bg-red-900'); iconBox.classList.add('bg-red-200'); iconHtml = '<i data-lucide="skull" class="w-6 h-6 text-red-800"></i>';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (type === 'restore') { actionBtn.classList.add('bg-green-600', 'hover:bg-green-700'); iconBox.classList.add('bg-green-100'); iconHtml = '<i data-lucide="rotate-ccw" class="w-6 h-6 text-green-600"></i>';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (type === 'logout') { actionBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700'); iconBox.classList.add('bg-indigo-100'); iconHtml = '<i data-lucide="log-out" class="w-6 h-6 text-indigo-600"></i>';
Â  Â  Â  Â  Â  Â  Â  Â  } else { actionBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); iconBox.classList.add('bg-blue-100'); iconHtml = '<i data-lucide="help-circle" class="w-6 h-6 text-blue-600"></i>';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  titleEl.textContent = title;
Â  Â  Â  Â  Â  Â  Â  Â  messageEl.textContent = message;
Â  Â  Â  Â  Â  Â  Â  Â  actionBtn.textContent = actionText;
Â  Â  Â  Â  Â  Â  Â  Â  iconBox.innerHTML = iconHtml;
Â  Â  Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  customConfirmResolver = resolve;
Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.add('active');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function resolveCustomConfirm(result) {
Â  Â  Â  Â  Â  Â  document.getElementById('customConfirmModal').classList.remove('active');
Â  Â  Â  Â  Â  Â  if (customConfirmResolver) {
Â  Â  Â  Â  Â  Â  Â  Â  customConfirmResolver(result);
Â  Â  Â  Â  Â  Â  Â  Â  customConfirmResolver = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function customLogout() {
Â  Â  Â  Â  Â  Â  const confirmed = await customConfirm(
Â  Â  Â  Â  Â  Â  Â  Â  "á…á¶á€á…áŸá‰á–á¸á‚áá“á¸",
Â  Â  Â  Â  Â  Â  Â  Â  "áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á…á¶á€á…áŸá‰á–á¸á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á…áŸ†áá¶á™á˜áŸ‚á“á‘áŸ?",
Â  Â  Â  Â  Â  Â  Â  Â  "á…á¶á€á…áŸá‰",
Â  Â  Â  Â  Â  Â  Â  Â  "logout"
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  if (confirmed) {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem("user");
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.clear();
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = "index.html";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function logout() { customLogout(); }

Â  Â  Â  Â  // --- INIT & AUTH (UNCHANGED) ---
Â  Â  Â  Â  if (!user) {
Â  Â  Â  Â  Â  Â  showToast("âš ï¸ áŸá¼á˜á…á¼á›á”áŸ’ášá–áŸá“áŸ’á’á‡á¶á˜á»á“áŸá·á“áŸ”", 'warning');
Â  Â  Â  Â  Â  Â  window.location.href = "index.html";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.getElementById("dropdown-email").textContent = user.Email || 'N/A';
Â  Â  Â  Â  Â  Â  document.getElementById("dropdown-role").textContent = user.Role || 'User';
Â  Â  Â  Â  Â  Â  if (user.Role === 'Owner') {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('user-management-link').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('user-management-link').classList.add('flex');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- PROFILE/DROPDOWN/MODALS (UNCHANGED) ---
Â  Â  Â  Â  function toggleDropdown(event) {
Â  Â  Â  Â  Â  Â  const menu = document.getElementById('profile-dropdown-menu');
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.dropdown-menu.active').forEach(m => {
Â  Â  Â  Â  Â  Â  Â  Â  if (m !== menu) m.classList.remove('active');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  menu.classList.toggle('active');
Â  Â  Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  }

Â  Â  Â  Â  document.addEventListener('click', function(event) {
Â  Â  Â  Â  Â  Â  const dropdown = document.getElementById('profile-dropdown-menu');
Â  Â  Â  Â  Â  Â  if (dropdown.classList.contains('active') && !event.target.closest('.dropdown')) {
Â  Â  Â  Â  Â  Â  Â  Â  dropdown.classList.remove('active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  function closeDropdown() { document.getElementById('profile-dropdown-menu').classList.remove('active'); }
Â  Â  Â  Â  function openProfileModal() {
Â  Â  Â  Â  Â  Â  closeDropdown();
Â  Â  Â  Â  Â  Â  document.getElementById('modal-profile-email').textContent = user.Email;
Â  Â  Â  Â  Â  Â  document.getElementById('modal-profile-role').textContent = user.Role;
Â  Â  Â  Â  Â  Â  document.getElementById('profileModal').classList.add('active');
Â  Â  Â  Â  }
Â  Â  Â  Â  function closeProfileModal() { document.getElementById('profileModal').classList.remove('active'); }

Â  Â  Â  Â  // --- DETAIL MODAL (UNCHANGED logic) ---
Â  Â  Â  Â  function openDetailModal(record) {
Â  Â  Â  Â  Â  Â  activeDetailRecord = record;

Â  Â  Â  Â  Â  Â  document.getElementById('detail-date').textContent = record.Date;
Â  Â  Â  Â  Â  Â  document.getElementById('detail-amount').textContent = formatCurrency(parseFloat(record.Amount));
Â  Â  Â  Â  Â  Â  document.getElementById('detail-amount').className = 'text-3xl font-extrabold mt-1 text-red-600';

Â  Â  Â  Â  Â  Â  // NEW: Populate Breakdown
Â  Â  Â  Â  Â  Â  document.getElementById('detail-meat').textContent = formatCurrency(parseFloat(record.Meat));
Â  Â  Â  Â  Â  Â  document.getElementById('detail-vegetable').textContent = formatCurrency(parseFloat(record.Vegetable));
Â  Â  Â  Â  Â  Â  document.getElementById('detail-fruit').textContent = formatCurrency(parseFloat(record.Fruit));

Â  Â  Â  Â  Â  Â  // Use Description
Â  Â  Â  Â  Â  Â  document.getElementById('detail-desc').textContent = record.Description || 'á‚áŸ’á˜á¶á“á–á·á–ááŸŒá“á¶';

Â  Â  Â  Â  Â  Â  document.getElementById('detail-modified').textContent = record.ModifiedDate ? new Date(record.ModifiedDate).toLocaleString('km-KH') : 'N/A';
Â  Â  Â  Â  Â  Â  document.getElementById('detail-status').textContent = record.Status === 'Deleted' ? 'á›á»á”á”ááŸ’áŠáŸ„áŸ‡á¢á¶áŸá“áŸ’á“' : 'áŸá€á˜áŸ’á˜';

Â  Â  Â  Â  Â  Â  document.getElementById('detailModal').classList.add('active');
Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeDetailModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('detailModal').classList.remove('active');
Â  Â  Â  Â  Â  Â  activeDetailRecord = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FORM LOGIC (UNCHANGED logic) ---

Â  Â  Â  Â  function updateAmountSummary(formElement) {
Â  Â  Â  Â  Â  Â  const meat = parseFloat(formElement.querySelector("#meat").value) || 0;
Â  Â  Â  Â  Â  Â  const vegetable = parseFloat(formElement.querySelector("#vegetable").value) || 0;
Â  Â  Â  Â  Â  Â  const fruit = parseFloat(formElement.querySelector("#fruit").value) || 0;

Â  Â  Â  Â  Â  Â  const total = meat + vegetable + fruit;

Â  Â  Â  Â  Â  Â  // Update the display field
Â  Â  Â  Â  Â  Â  formElement.querySelector("#amount-summary").value = formatCurrency(total);

Â  Â  Â  Â  Â  Â  // Update the hidden field used for data submission (We use the hidden field with ID 'amount' for submission)
Â  Â  Â  Â  Â  Â  formElement.querySelector("#amount").value = total;

Â  Â  Â  Â  Â  Â  // Apply visual cue if total is zero
Â  Â  Â  Â  Â  Â  const summaryInput = formElement.querySelector("#amount-summary");
Â  Â  Â  Â  Â  Â  if (total === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  summaryInput.classList.remove('text-red-600');
Â  Â  Â  Â  Â  Â  Â  Â  summaryInput.classList.add('text-gray-500');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  summaryInput.classList.remove('text-gray-500');
Â  Â  Â  Â  Â  Â  Â  Â  summaryInput.classList.add('text-red-600');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function setupForms() {
Â  Â  Â  Â  Â  Â  const formTemplate = document.getElementById('form-template').innerHTML;

Â  Â  Â  Â  Â  Â  // Setup Desktop Form
Â  Â  Â  Â  Â  Â  const desktopForm = document.getElementById('expense-form');
Â  Â  Â  Â  Â  Â  desktopForm.innerHTML = formTemplate;
Â  Â  Â  Â  Â  Â  desktopForm.addEventListener('submit', (e) => handleFormSubmission(e, 'desktop'));
Â  Â  Â  Â  Â  Â  desktopForm.querySelectorAll('.expense-input').forEach(input => {
Â  Â  Â  Â  Â  Â  Â  Â  input.addEventListener('input', () => updateAmountSummary(desktopForm));
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Setup Mobile Form
Â  Â  Â  Â  Â  Â  const mobileForm = document.getElementById('mobile-expense-form');
Â  Â  Â  Â  Â  Â  mobileForm.innerHTML = formTemplate;
Â  Â  Â  Â  Â  Â  mobileForm.addEventListener('submit', (e) => handleFormSubmission(e, 'mobile'));
Â  Â  Â  Â  Â  Â  mobileForm.querySelectorAll('.expense-input').forEach(input => {
Â  Â  Â  Â  Â  Â  Â  Â  input.addEventListener('input', () => updateAmountSummary(mobileForm));
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function openFormModal() {
Â  Â  Â  Â  Â  Â  Â resetForm();
Â  Â  Â  Â  Â  Â  Â document.getElementById('mobile-form-title').textContent = "â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸";
Â  Â  Â  Â  Â  Â  Â document.getElementById('mobileFormModal').classList.add('active');
Â  Â  Â  Â  Â  Â  Â activeFormElement = document.getElementById('mobile-expense-form');
Â  Â  Â  Â  Â  Â  Â if(activeFormElement) activeFormElement.reset();
Â  Â  Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeFormModal() {
Â  Â  Â  Â  Â  Â  resetForm();
Â  Â  Â  Â  Â  Â  document.getElementById('mobileFormModal').classList.remove('active');
Â  Â  Â  Â  Â  Â  activeFormElement = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  function populateForm(formElement, record) {
Â  Â  Â  Â  Â  Â  formElement.querySelector("#date").value = record.Date;
Â  Â  Â  Â  Â  Â  // Use the specific columns for populating the input fields
Â  Â  Â  Â  Â  Â  formElement.querySelector("#meat").value = parseFloat(record.Meat) || 0;
Â  Â  Â  Â  Â  Â  formElement.querySelector("#vegetable").value = parseFloat(record.Vegetable) || 0;
Â  Â  Â  Â  Â  Â  formElement.querySelector("#fruit").value = parseFloat(record.Fruit) || 0;
Â  Â  Â  Â  Â  Â  formElement.querySelector("#desc").value = record.Description;

Â  Â  Â  Â  Â  Â  // Update Total Amount display after populating sub-fields
Â  Â  Â  Â  Â  Â  updateAmountSummary(formElement);

Â  Â  Â  Â  Â  Â  const isEditing = record !== null;
Â  Â  Â  Â  Â  Â  const submitBtn = formElement.querySelector('#submit-btn');
Â  Â  Â  Â  Â  Â  const cancelBtn = formElement.querySelector('#cancel-btn');

Â  Â  Â  Â  Â  Â  if (isEditing) {
Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-1"></i> ášá€áŸ’áŸá¶á‘á»á€á€á¶ášá€áŸ‚á”áŸ’ášáŸ‚';
Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
Â  Â  Â  Â  Â  Â  Â  Â  submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
Â  Â  Â  Â  Â  Â  Â  Â  cancelBtn.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('main-form-title').textContent = "ğŸ“ á€áŸ‚á”áŸ’ášáŸ‚á€áŸ†áááŸ‹ááŸ’ášá¶";
Â  Â  Â  Â  Â  Â  Â  Â  const mobileTitle = document.getElementById('mobile-form-title');
Â  Â  Â  Â  Â  Â  Â  Â  if(mobileTitle) mobileTitle.textContent = "ğŸ“ á€áŸ‚á”áŸ’ášáŸ‚á€áŸ†áááŸ‹ááŸ’ášá¶";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  resetFormUI(formElement);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  }

Â  Â  Â  Â  function resetFormUI(formElement) {
Â  Â  Â  Â  Â  Â  Â const submitBtn = formElement.querySelector('#submit-btn');
Â  Â  Â  Â  Â  Â  Â const cancelBtn = formElement.querySelector('#cancel-btn');

Â  Â  Â  Â  Â  Â  Â submitBtn.innerHTML = '<i data-lucide="plus" class="w-5 h-5 mr-1"></i> á”á“áŸ’ááŸ‚á˜á€áŸ†áááŸ‹ááŸ’ášá¶';
Â  Â  Â  Â  Â  Â  Â submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
Â  Â  Â  Â  Â  Â  Â submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
Â  Â  Â  Â  Â  Â  Â cancelBtn.classList.add('hidden');

Â  Â  Â  Â  Â  Â  Â document.getElementById('main-form-title').textContent = "â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸";
Â  Â  Â  Â  Â  Â  Â const mobileTitle = document.getElementById('mobile-form-title');
Â  Â  Â  Â  Â  Â  Â if(mobileTitle) mobileTitle.textContent = "â• á”á‰áŸ’á…á¼á›á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’á˜á¸";

Â  Â  Â  Â  Â  Â  Â // Also reset the amount summary
Â  Â  Â  Â  Â  Â  Â updateAmountSummary(formElement);
Â  Â  Â  Â  }

Â  Â  Â  Â  function resetForm() {
Â  Â  Â  Â  Â  Â  editingID = null;
Â  Â  Â  Â  Â  Â  const desktopForm = document.getElementById('expense-form');
Â  Â  Â  Â  Â  Â  const mobileForm = document.getElementById('mobile-expense-form');
Â  Â  Â  Â  Â  Â  desktopForm.reset();
Â  Â  Â  Â  Â  Â  mobileForm.reset();
Â  Â  Â  Â  Â  Â  resetFormUI(desktopForm);
Â  Â  Â  Â  Â  Â  resetFormUI(mobileForm);
Â  Â  Â  Â  Â  Â  activeFormElement = null;
Â  Â  Â  Â  Â  Â  lucide.createIcons();

Â  Â  Â  Â  Â  Â  // Ensure summary is zero after reset
Â  Â  Â  Â  Â  Â  updateAmountSummary(desktopForm);
Â  Â  Â  Â  Â  Â  updateAmountSummary(mobileForm);
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleCardClick(record) {
Â  Â  Â  Â  Â  Â  Â const isMobile = window.innerWidth < 1024;
Â  Â  Â  Â  Â  Â  Â if (isMobile || activeTab === 'report') { // Allow quick edit on report tab too, regardless of size
Â  Â  Â  Â  Â  Â  Â  Â  Â // In mobile, clicking the card means open for quick edit/detail
Â  Â  Â  Â  Â  Â  Â  Â  Â editExpense(record.ID, false);
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â // In desktop/dashboard, clicking the card means open detail modal
Â  Â  Â  Â  Â  Â  Â  Â  Â openDetailModal(record);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function editExpense(id, scrollToForm=true) {
Â  Â  Â  Â  Â  Â  const record = allExpenses.find(x => x.ID.toString() === id.toString());
Â  Â  Â  Â  Â  Â  if (!record) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast("âŒ á˜á·á“á¢á¶á…ášá€á€áŸ†áááŸ‹ááŸ’ášá¶á”á¶á“á‘áŸáŸ”", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  closeDetailModal();
Â  Â  Â  Â  Â  Â  editingID = id;

Â  Â  Â  Â  Â  Â  const isMobile = window.innerWidth < 1024;

Â  Â  Â  Â  Â  Â  if (isMobile || activeTab === 'report') { // Use mobile form modal logic for report view on desktop too for consistency
Â  Â  Â  Â  Â  Â  Â  Â  openFormModal();
Â  Â  Â  Â  Â  Â  Â  Â  activeFormElement = document.getElementById('mobile-expense-form');
Â  Â  Â  Â  Â  Â  } else {
                // When editing from the main dashboard (only active on desktop)
                activeFormElement = document.getElementById('expense-form');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if(activeFormElement) {
Â  Â  Â  Â  Â  Â  Â  Â  populateForm(activeFormElement, record);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if(scrollToForm && !isMobile && activeTab === 'dashboard') {
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById("main-expense-form-container").scrollIntoView({ behavior: 'smooth', block: 'start' });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- UTILS ---
Â  Â  Â  Â  function formatCurrency(amount) {
Â  Â  Â  Â  Â  Â  const num = parseFloat(amount) || 0;
Â  Â  Â  Â  Â  Â  return `${num.toLocaleString('km-KH')} áŸ›`;
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Checks if two date strings are the same day (ignoring time).
Â  Â  Â  Â  Â * @param {string} date1 - ISO date string.
Â  Â  Â  Â  Â * @param {string} date2 - ISO date string.
Â  Â  Â  Â  Â * @returns {boolean}
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function isSameDay(date1, date2) {
Â  Â  Â  Â  Â  Â  const d1 = new Date(date1);
Â  Â  Â  Â  Â  Â  const d2 = new Date(date2);
Â  Â  Â  Â  Â  Â  return d1.getFullYear() === d2.getFullYear() &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â d1.getMonth() === d2.getMonth() &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â d1.getDate() === d2.getDate();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- SUMMARY & FILTERING LOGIC (UPDATED for Today/Monthly/Yearly) ---
Â  Â  Â  Â  let filteredDataForReport = [];

Â  Â  Â  Â  function calculateSummary(data) {
Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  const currentYear = today.getFullYear();
Â  Â  Â  Â  Â  Â  const currentMonth = today.getMonth();

Â  Â  Â  Â  Â  Â  const activeExpenses = data.filter(x => x.Status === "Active");
Â  Â  Â  Â  Â  Â  let totalExpense = 0;
Â  Â  Â  Â  Â  Â  let todayExpense = 0;
Â  Â  Â  Â  Â  Â  let monthlyExpense = 0;
Â  Â  Â  Â  Â  Â  let totalMeat = 0;
Â  Â  Â  Â  Â  Â  let totalVegetable = 0;
Â  Â  Â  Â  Â  Â  let totalFruit = 0;
Â  Â  Â  Â  Â  Â  let totalCount = activeExpenses.length;

Â  Â  Â  Â  Â  Â  activeExpenses.forEach(x => {
Â  Â  Â  Â  Â  Â  Â  Â  const amount = parseFloat(x.Amount) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const recordDate = new Date(x.Date);

Â  Â  Â  Â  Â  Â  Â  Â  // --- Breakdown Sums ---
Â  Â  Â  Â  Â  Â  Â  Â  const meat = parseFloat(x.Meat) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const vegetable = parseFloat(x.Vegetable) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const fruit = parseFloat(x.Fruit) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  totalMeat += meat;
Â  Â  Â  Â  Â  Â  Â  Â  totalVegetable += vegetable;
Â  Â  Â  Â  Â  Â  Â  Â  totalFruit += fruit;

Â  Â  Â  Â  Â  Â  Â  Â  // --- Time-based Sums (Uses the Amount from the Sheet's formula) ---
Â  Â  Â  Â  Â  Â  Â  Â  totalExpense += amount;

Â  Â  Â  Â  Â  Â  Â  Â  if (isSameDay(x.Date, today)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  todayExpense += amount;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  monthlyExpense += amount;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // --- Rendering Summary Cards ---
Â  Â  Â  Â  Â  Â  document.getElementById('total-expense-summary').textContent = formatCurrency(totalExpense);
Â  Â  Â  Â  Â  Â  document.getElementById('today-expense-summary').textContent = formatCurrency(todayExpense);
Â  Â  Â  Â  Â  Â  document.getElementById('monthly-expense-summary').textContent = formatCurrency(monthlyExpense);

Â  Â  Â  Â  Â  Â  document.getElementById('meat-total-summary').textContent = formatCurrency(totalMeat);
Â  Â  Â  Â  Â  Â  document.getElementById('vegetable-total-summary').textContent = formatCurrency(totalVegetable);
Â  Â  Â  Â  Â  Â  document.getElementById('fruit-total-summary').textContent = formatCurrency(totalFruit);

Â  Â  Â  Â  Â  Â  document.getElementById('total-count-summary').textContent = `${totalCount} á€áŸ†áááŸ‹ááŸ’ášá¶`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function filterRecords() {
Â  Â  Â  Â  Â  Â  const reportType = document.getElementById('report-type').value;
Â  Â  Â  Â  Â  Â  const searchTerm = document.getElementById('search-input').value.toLowerCase();

Â  Â  Â  Â  Â  Â  const expenseOnlyData = allExpenses.filter(x => x.Type === "Expense" || x.Status === "Deleted");

Â  Â  Â  Â  Â  Â  const dataToFilter = currentView === 'active' ?
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â expenseOnlyData.filter(x => x.Status === "Active") :
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â expenseOnlyData.filter(x => x.Status === "Deleted");

Â  Â  Â  Â  Â  Â  let filtered = dataToFilter;

Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  const currentYear = today.getFullYear();
Â  Â  Â  Â  Â  Â  const currentMonth = today.getMonth();

Â  Â  Â  Â  Â  Â  filtered = filtered.filter(x => {
Â  Â  Â  Â  Â  Â  Â  Â  const recordDate = new Date(x.Date);
Â  Â  Â  Â  Â  Â  Â  Â  const description = (x.Description || '').toLowerCase();

Â  Â  Â  Â  Â  Â  Â  Â  let matchesReport = true;
Â  Â  Â  Â  Â  Â  Â  Â  let matchesSearch = true;

Â  Â  Â  Â  Â  Â  Â  Â  switch (reportType) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'daily':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  matchesReport = isSameDay(x.Date, today);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'monthly':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  matchesReport = recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'yearly':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  matchesReport = recordDate.getFullYear() === currentYear;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'all':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  matchesReport = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (searchTerm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  matchesSearch = description.includes(searchTerm);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  return matchesReport && matchesSearch;
Â  Â  Â  Â  Â  Â  }).sort((a, b) => new Date(b.Date) - new Date(a.Date));

Â  Â  Â  Â  Â  Â  filteredDataForReport = filtered;
Â  Â  Â  Â  Â  Â  renderExpenseList(filtered);
Â  Â  Â  Â  }

Â  Â  Â  Â  function switchView(view) {
Â  Â  Â  Â  Â  Â  currentView = view;
Â  Â  Â  Â  Â  Â  const trashBtn = document.getElementById('trash-btn');
Â  Â  Â  Â  Â  Â  trashBtn.innerHTML = view === 'active' ?
Â  Â  Â  Â  Â  Â  Â  Â  '<i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> á€áŸ†áááŸ‹ááŸ’ášá¶áŠáŸ‚á›á”á¶á“á›á»á”' :
Â  Â  Â  Â  Â  Â  Â  Â  '<i data-lucide="check-circle" class="w-4 h-4 mr-2"></i> á˜á¾á›á€áŸ†áááŸ‹ááŸ’ášá¶áŸá€á˜áŸ’á˜';
Â  Â  Â  Â  Â  Â  trashBtn.onclick = view === 'active' ? () => switchView('trash') : () => switchView('active');
Â  Â  Â  Â  Â  Â  trashBtn.classList.toggle('bg-gray-100', view === 'active');
Â  Â  Â  Â  Â  Â  trashBtn.classList.toggle('bg-indigo-500', view === 'trash');
Â  Â  Â  Â  Â  Â  trashBtn.classList.toggle('text-white', view === 'trash');
Â  Â  Â  Â  Â  Â  trashBtn.classList.toggle('text-gray-600', view === 'active');

Â  Â  Â  Â  Â  Â  document.getElementById('report-type').value = 'all';
Â  Â  Â  Â  Â  Â  document.getElementById('search-input').value = '';
Â  Â  Â  Â  Â  Â  filterRecords();
Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- RENDER LIST (UPDATED to use Amount and show breakdown) ---
Â  Â  Â  Â  function renderExpenseList(data) {
Â  Â  Â  Â  Â  Â  const list = document.getElementById("expense-list");
Â  Â  Â  Â  Â  Â  const isTrashView = currentView === 'trash';

Â  Â  Â  Â  Â  Â  if (data.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML = `<p class="text-center text-gray-500 py-10 text-xl border-dashed border-2 border-gray-300 rounded-lg m-4 bg-gray-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isTrashView ? 'ğŸ—‘ï¸ á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™á€áŸ’á“á»á„á’á»á„áŸáŸ†ášá¶á˜á‘áŸáŸ”' : 'âœ… á˜á·á“á˜á¶á“á€áŸ†áááŸ‹ááŸ’ášá¶á…áŸ†áá¶á™áŸá€á˜áŸ’á˜á‘áŸáŸ”'}
Â  Â  Â  Â  Â  Â  Â  Â  </p>`;
Â  Â  Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  list.innerHTML = data.map(x => {
Â  Â  Â  Â  Â  Â  Â  Â  const isDeleted = x.Status === 'Deleted';
Â  Â  Â  Â  Â  Â  Â  Â  const badgeClass = isDeleted ? 'badge-deleted' : 'badge-expense';
Â  Â  Â  Â  Â  Â  Â  Â  const amountTextClass = isDeleted ? 'text-gray-500 line-through' : 'text-red-600';
Â  Â  Â  Â  Â  Â  Â  Â  const icon = 'arrow-down-left';

Â  Â  Â  Â  Â  Â  Â  Â  const recordJson = JSON.stringify(x).split("'").join("\\'");

Â  Â  Â  Â  Â  Â  Â  Â  // Use the data from the sheet directly
Â  Â  Â  Â  Â  Â  Â  Â  const breakdown = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-500 mt-1 flex space-x-2">
                            <span>áŸá¶á…áŸ‹: <span class="text-orange-600">${formatCurrency(x.Meat)}</span></span>
                            <span>|</span>
                            <span>á”á“áŸ’á›áŸ‚: <span class="text-green-600">${formatCurrency(x.Vegetable)}</span></span>
                            <span>|</span>
                            <span>á•áŸ’á›áŸ‚áˆá¾: <span class="text-yellow-600">${formatCurrency(x.Fruit)}</span></span>
                        </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  Â  Â  const actionButtons = isDeleted ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="event.stopPropagation(); restoreExpense('${x.ID}')" class="text-green-600 hover:text-green-800 p-2 rounded-full hover:bg-green-50 transition" title="á‘á¶á‰á™á€á˜á€áœá·á‰">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="event.stopPropagation(); permanentDeleteExpense('${x.ID}')" class="text-gray-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 transition" title="á›á»á”á‡á¶á¢á…á·á“áŸ’ááŸ’ášáŸƒá™áŸ">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="x-circle" class="w-5 h-5"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  ` : `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="event.stopPropagation(); editExpense('${x.ID}')" class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50 transition" title="á€áŸ‚á”áŸ’ášáŸ‚">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="pencil" class="w-5 h-5"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="event.stopPropagation(); deleteExpense('${x.ID}')" class="text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 transition" title="á›á»á”">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="trash-2" class="w-5 h-5"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div onclick="handleCardClick(${recordJson})" class="expense-item bg-white p-4 rounded-xl shadow-md border-l-4 ${isDeleted ? 'border-gray-500' : 'border-red-500'} flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-1 min-w-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-2 mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs font-medium px-2 py-0.5 rounded-full ${badgeClass}">á…áŸ†áá¶á™</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-gray-500">${x.Date}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-base font-bold text-gray-800 truncate">á…áŸ†áá¶á™á‚áŸ’ášá¿á„á‘áŸáŸ</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-600 truncate">${x.Description || 'á˜á·á“á˜á¶á“á–á·á–ááŸŒá“á¶'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isDeleted ? '' : breakdown}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right ml-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl font-extrabold ${amountTextClass} flex items-center justify-end whitespace-nowrap">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${!isDeleted ? `<i data-lucide="${icon}" class="w-5 h-5 mr-1"></i>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${formatCurrency(parseFloat(x.Amount))}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-actions flex space-x-1 ml-4 flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButtons}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }).join("");

Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- CRUD/DATA OPERATIONS (CRITICAL UPDATE) ---

Â  Â  Â  Â  async function handleFormSubmission(e, source) {
Â  Â  Â  Â  Â  Â  Â e.preventDefault();
Â  Â  Â  Â  Â  Â  Â const formElement = source === 'mobile' ? document.getElementById('mobile-expense-form') : document.getElementById('expense-form');

Â  Â  Â  Â  Â  Â  Â const date = formElement.querySelector("#date").value;
Â  Â  Â  Â  Â  Â  Â // const amount = parseFloat(formElement.querySelector("#amount").value); // Calculated, but NOT sent to SheetDB!

Â  Â  Â  Â  Â  Â  Â const meat = parseFloat(formElement.querySelector("#meat").value) || 0;
Â  Â  Â  Â  Â  Â  Â const vegetable = parseFloat(formElement.querySelector("#vegetable").value) || 0;
Â  Â  Â  Â  Â  Â  Â const fruit = parseFloat(formElement.querySelector("#fruit").value) || 0;
Â  Â  Â  Â  Â  Â  Â const desc = formElement.querySelector("#desc").value;

Â  Â  Â  Â  Â  Â  Â const type = 'Expense';

Â  Â  Â  Â  Â  Â  Â const submitBtn = formElement.querySelector("#submit-btn");

Â  Â  Â  Â  Â  Â  Â if (!date || (meat + vegetable + fruit) <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showToast("âš ï¸ áŸá¼á˜á”áŸ†á–áŸá‰á€á¶á›á”ášá·á…áŸ’á†áŸá‘ á“á·á„ááŸ’ášá¼áœááŸ‚á˜á¶á“á…áŸ†á“á½á“á”áŸ’ášá¶á€áŸ‹á…áŸ†áá¶á™áŸášá»á”!", 'warning');
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â const originalText = submitBtn.textContent;
Â  Â  Â  Â  Â  Â  Â submitBtn.innerHTML = editingID ? '<i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-1"></i> á€áŸ†á–á»á„á€áŸ‚á”áŸ’ášáŸ‚...' : '<i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-1"></i> á€áŸ†á–á»á„á”á“áŸ’ááŸ‚á˜...';
Â  Â  Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â submitBtn.disabled = true;

Â  Â  Â  Â  Â  Â  Â const recordData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â Date: date,
Â  Â  Â  Â  Â  Â  Â  Â  Â // CRITICAL: ONLY send the individual expense values. Do NOT send 'Amount' (it's a formula).
Â  Â  Â  Â  Â  Â  Â  Â  Â Type: type,
Â  Â  Â  Â  Â  Â  Â  Â  Â Meat: meat,
Â  Â  Â  Â  Â  Â  Â  Â  Â Vegetable: vegetable,
Â  Â  Â  Â  Â  Â  Â  Â  Â Fruit: fruit,
Â  Â  Â  Â  Â  Â  Â  Â  Â Description: desc,
Â  Â  Â  Â  Â  Â  Â  Â  Â ModifiedDate: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â };

Â  Â  Â  Â  Â  Â  Â let res;
Â  Â  Â  Â  Â  Â  Â if (editingID) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const url = `${SHEETDB_BASE_URL}/ID/${editingID}?sheet=${SHEET_EXPENSES}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â res = await fetch(url, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â method: "PATCH",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â body: JSON.stringify({ data: [recordData] })
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â if (res.ok) showToast("âœ… á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“á€áŸ‚á”áŸ’ášáŸ‚áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!", 'success');
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ID: Date.now(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Date: date,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Note: We deliberately skip the 'Amount' column here
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Type: type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Meat: meat,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Vegetable: vegetable,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Fruit: fruit,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Description: desc,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â UserEmail: user.Email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Status: "Active",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ModifiedDate: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }]
Â  Â  Â  Â  Â  Â  Â  Â  Â };
Â  Â  Â  Â  Â  Â  Â  Â  Â res = await fetch(sheetUrl(SHEET_EXPENSES), {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â method: "POST",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â  Â  Â if (res.ok) showToast("âœ… á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“á”á“áŸ’ááŸ‚á˜áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!", 'success');
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â if (res.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â if(source === 'mobile') closeFormModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â resetForm();
Â  Â  Â  Â  Â  Â  Â  Â  Â // Delay loading data briefly to allow Google Sheet's formula to calculate 'Amount'
Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(loadAllData, 1500);
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â showToast("âŒ á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá”ášá¶á‡áŸá™áŸ”", 'error');
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â submitBtn.textContent = originalText;
Â  Â  Â  Â  Â  Â  Â submitBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Soft Delete/Restore/Permanent Delete functions (UNCHANGED logic) ---
Â  Â  Â  Â  async function deleteExpense(id) {
Â  Â  Â  Â  Â  Â  const confirmed = await customConfirm(
Â  Â  Â  Â  Â  Â  Â  Â  "á”á‰áŸ’á‡á¶á€áŸ‹á€á¶ášá›á»á”á”ááŸ’áŠáŸ„áŸ‡á¢á¶áŸá“áŸ’á“",
Â  Â  Â  Â  Â  Â  Â  Â  "á€áŸ†áááŸ‹ááŸ’ášá¶á“áŸáŸ‡á“á¹á„ááŸ’ášá¼áœá”á¶á“á•áŸ’á›á¶áŸáŸ‹á‘áŸ…á€á¶á“áŸ‹á’á»á„áŸáŸ†ášá¶á˜áŸ” áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠá‘áŸ?",
Â  Â  Â  Â  Â  Â  Â  Â  "á•áŸ’á›á¶áŸáŸ‹á‘áŸ…á’á»á„áŸáŸ†ášá¶á˜",
Â  Â  Â  Â  Â  Â  Â  Â  "delete"
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  if (confirmed) { await updateStatus(id, "Deleted", "á›á»á”á”ááŸ’áŠáŸ„áŸ‡á¢á¶áŸá“áŸ’á“"); }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function restoreExpense(id) {
Â  Â  Â  Â  Â  Â  const confirmed = await customConfirm(
Â  Â  Â  Â  Â  Â  Â  Â  "á”á‰áŸ’á‡á¶á€áŸ‹á€á¶ášá‘á¶á‰á™á€á˜á€áœá·á‰",
Â  Â  Â  Â  Â  Â  Â  Â  "áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á‘á¶á‰á™á€á€áŸ†áááŸ‹ááŸ’ášá¶á“áŸáŸ‡ááŸ’ášá¡á”áŸ‹á˜á€áœá·á‰á‘áŸ?",
Â  Â  Â  Â  Â  Â  Â  Â  "á‘á¶á‰á™á€á˜á€áœá·á‰",
Â  Â  Â  Â  Â  Â  Â  Â  "restore"
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  if (confirmed) { await updateStatus(id, "Active", "á‘á¶á‰á™á€á˜á€áœá·á‰"); }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function permanentDeleteExpense(id) {
Â  Â  Â  Â  Â  Â  const confirmed = await customConfirm(
Â  Â  Â  Â  Â  Â  Â  Â  "âš ï¸ á›á»á”á‡á¶á¢á…á·á“áŸ’ááŸ’ášáŸƒá™áŸ",
Â  Â  Â  Â  Â  Â  Â  Â  "á€áŸ†áááŸ‹ááŸ’ášá¶á“áŸáŸ‡á“á¹á„ááŸ’ášá¼áœá›á»á”á…áŸá‰á–á¸á”áŸ’ášá–áŸá“áŸ’á’á‘á¶áŸ†á„áŸáŸ’ášá»á„ á á¾á™á˜á·á“á¢á¶á…á™á€á˜á€áœá·á‰á”á¶á“á‘áŸáŸ” áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠá‘áŸ?",
Â  Â  Â  Â  Â  Â  Â  Â  "á›á»á”á‡á¶á¢á…á·á“áŸ’ááŸ’ášáŸƒá™áŸ",
Â  Â  Â  Â  Â  Â  Â  Â  "permanent_delete"
Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  if (!confirmed) return;
Â  Â  Â  Â  Â  Â  const url = `${SHEETDB_BASE_URL}/ID/${id}?sheet=${SHEET_EXPENSES}`;
Â  Â  Â  Â  Â  Â  const res = await fetch(url, { method: "DELETE" });

Â  Â  Â  Â  Â  Â  if (res.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast("ğŸ—‘ï¸ á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“á›á»á”á‡á¶á¢á…á·á“áŸ’ááŸ’ášáŸƒá™áŸáŠáŸ„á™á‡áŸ„á‚á‡áŸá™áŸ”", 'success');
Â  Â  Â  Â  Â  Â  Â  Â  loadAllData();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showToast("âŒ á€á¶ášá›á»á”á”ášá¶á‡áŸá™áŸ”", 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function updateStatus(id, newStatus, actionName) {
Â  Â  Â  Â  Â  Â  const url = `${SHEETDB_BASE_URL}/ID/${id}?sheet=${SHEET_EXPENSES}`;
Â  Â  Â  Â  Â  Â  const res = await fetch(url, {
Â  Â  Â  Â  Â  Â  Â  Â  method: "PATCH",
Â  Â  Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ data: [{ Status: newStatus, ModifiedDate: new Date().toISOString() }] })
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (res.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`âœ… á€áŸ†áááŸ‹ááŸ’ášá¶ááŸ’ášá¼áœá”á¶á“${actionName}áŠáŸ„á™á‡áŸ„á‚á‡áŸá™áŸ”`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  // Delay loading data briefly to allow Google Sheet's formula to update
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(loadAllData, 1500);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showToast("âŒ á”áŸ’ášáá·á”ááŸ’áá·á€á¶ášá”ášá¶á‡áŸá™áŸ”", 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- DATA EXPORT (UPDATED to use correct column names) ---
Â  Â  Â  Â  async function exportData(format) {
Â  Â  Â  Â  Â  Â  const dataToExport = filteredDataForReport;
Â  Â  Â  Â  Â  Â  const reportName = document.getElementById('report-type').options[document.getElementById('report-type').selectedIndex].text;

Â  Â  Â  Â  Â  Â  if (dataToExport.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showToast("âš ï¸ á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŸá˜áŸ’ášá¶á”áŸ‹á‘á¶á‰á™á€á‘áŸáŸ” áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸášá”á¶á™á€á¶ášááŸá•áŸ’áŸáŸá„á‘áŸ€ááŸ”", 'warning', 6000);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- EXCEL EXPORT ---
Â  Â  Â  Â  Â  Â  if (format === 'excel') {
Â  Â  Â  Â  Â  Â  Â  Â  const structuredData = dataToExport.map(x => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'á€á¶á›á”ášá·á…áŸ’á†áŸá‘': x.Date,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'á”áŸ’ášá—áŸá‘': x.Type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'áŸášá»á”á”áŸ’ášá¶á€áŸ‹ (áŸ›)': parseFloat(x.Amount) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'áŸá¶á…áŸ‹ (áŸ›)': parseFloat(x.Meat) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'á”á“áŸ’á›áŸ‚ (áŸ›)': parseFloat(x.Vegetable) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'á•áŸ’á›áŸ‚áˆá¾ (áŸ›)': parseFloat(x.Fruit) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'á–á·á–ááŸŒá“á¶': x.Description || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'áŸáŸ’áá¶á“á—á¶á–': x.Status
Â  Â  Â  Â  Â  Â  Â  Â  }));

Â  Â  Â  Â  Â  Â  Â  Â  if (typeof XLSX === 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("âŒ á€áŸ†á á»áŸ! SheetJS (XLSX) library á˜á·á“ááŸ’ášá¼áœá”á¶á“á•áŸ’á‘á»á€á‘áŸáŸ”", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const workbook = XLSX.utils.book_new();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const worksheet = XLSX.utils.json_to_sheet(structuredData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  XLSX.utils.book_append_sheet(workbook, worksheet, reportName);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  XLSX.writeFile(workbook, `${reportName}_ExpenseReport_${new Date().toISOString().slice(0,10)}.xlsx`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(`âœ… á¯á€áŸá¶áš Excel (.xlsx) ááŸ’ášá¼áœá”á¶á“á‘á¶á‰á™á€áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!`, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Excel Export Failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("âŒ á€á¶ášá‘á¶á‰á™á€á¯á€áŸá¶áš Excel á”ášá¶á‡áŸá™áŸ”", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // --- PDF EXPORT (UNCHANGED Logic) ---
Â  Â  Â  Â  Â  Â  else if (format === 'pdf') {
Â  Â  Â  Â  Â  Â  Â  Â  Â const { jsPDF } = window.jspdf;
Â  Â  Â  Â  Â  Â  Â  Â  Â const inputElement = document.getElementById('data-view-section');

Â  Â  Â  Â  Â  Â  Â  Â  Â document.querySelectorAll('.item-actions').forEach(el => el.style.display = 'none');

Â  Â  Â  Â  Â  Â  Â  Â  Â const pdfBtn = document.querySelector('button[onclick="exportData(\'pdf\')"]');
Â  Â  Â  Â  Â  Â  Â  Â  Â const originalPdfBtnContent = pdfBtn.innerHTML;
Â  Â  Â  Â  Â  Â  Â  Â  Â pdfBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 mr-1"></i> á€áŸ†á–á»á„ášáŸ€á”á…áŸ† PDF...';
Â  Â  Â  Â  Â  Â  Â  Â  Â pdfBtn.disabled = true;

Â  Â  Â  Â  Â  Â  Â  Â  Â try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const canvas = await html2canvas(inputElement, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â scale: 2,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â useCORS: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â windowWidth: inputElement.scrollWidth,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â windowHeight: inputElement.scrollHeight
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const imgData = canvas.toDataURL('image/jpeg', 1.0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const pdf = new jsPDF('p', 'mm', 'a4');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const pdfWidth = pdf.internal.pageSize.getWidth();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const pdfHeight = pdf.internal.pageSize.getHeight();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const imgHeight = canvas.height * pdfWidth / canvas.width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â let heightLeft = imgHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â let position = 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pdf.setFontSize(16);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pdf.text(`ášá”á¶á™á€á¶ášááŸá…áŸ†áá¶á™: ${reportName}`, 10, 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pdf.setFontSize(10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pdf.text(`á€á¶á›á”ášá·á…áŸ’á†áŸá‘: ${new Date().toLocaleDateString('km-KH')}`, 10, 17);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â position = 25;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â while (heightLeft >= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (position > 25) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pdf.addPage();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pdf.addImage(imgData, 'JPEG', 0, position - imgHeight, pdfWidth, imgHeight);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â heightLeft -= pdfHeight - 15;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â position -= pdfHeight - 15;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pdf.save(`${reportName}_Report_${new Date().toISOString().slice(0,10)}.pdf`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showToast(`âœ… á¯á€áŸá¶áš PDF ááŸ’ášá¼áœá”á¶á“á‘á¶á‰á™á€áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!`, 'success');

Â  Â  Â  Â  Â  Â  Â  Â  Â } catch(error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("PDF Export failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showToast("âŒ á€á¶ášá‘á¶á‰á™á€ PDF á”ášá¶á‡áŸá™áŸ”", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.querySelectorAll('.item-actions').forEach(el => el.style.display = 'flex');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pdfBtn.innerHTML = originalPdfBtnContent;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pdfBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Initialization ---
Â  Â  Â  Â  async function loadAllData() {
Â  Â  Â  Â  Â  Â  // Only show loading text if we're on the report tab
            if (activeTab === 'report') {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("expense-list").innerHTML = '<p class="text-center text-gray-500 py-10 flex items-center justify-center"><i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-3"></i> á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</p>';
            }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â const res = await fetch(sheetUrl(SHEET_EXPENSES));
Â  Â  Â  Â  Â  Â  Â  Â  Â const data = await res.json();

Â  Â  Â  Â  Â  Â  Â  Â  Â // CRITICAL: Filter records and ensure the necessary fields exist
Â  Â  Â  Â  Â  Â  Â  Â  Â // Note: We check for 'Amount' existence which should be output by the formula in the sheet.
Â  Â  Â  Â  Â  Â  Â  Â  Â allExpenses = data.filter(x => x.ID && (x.Type === 'Expense' || x.Status === 'Deleted') && x.Amount !== undefined);

Â  Â  Â  Â  Â  Â  Â  Â  Â calculateSummary(allExpenses);
Â  Â  Â  Â  Â  Â  Â  Â  Â filterRecords();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â // Only update error state for the list if we're viewing the list
                if (activeTab === 'report') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("expense-list").innerHTML = '<p class="text-center text-red-500 py-10 text-lg">âŒ á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá‘á¶á‰á‘á·á“áŸ’á“á“áŸá™áŸ” áŸá¼á˜á–á·á“á·ááŸ’á™á˜á¾á› Column headers á€áŸ’á“á»á„ SheetDB</p>';
                }
Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Error loading expenses:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â showToast("âŒ á€áŸ†á á»áŸá€áŸ’á“á»á„á€á¶ášá•áŸ’á‘á»á€á‘á·á“áŸ’á“á“áŸá™á…áŸ†áá¶á™! (á–á·á“á·ááŸ’á™ Column names á€áŸ’á“á»á„ SheetDB)", 'error', 6000);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Execute setup and data loading
Â  Â  Â  Â  setupForms();
Â  Â  Â  Â  loadAllData();
        setActiveTab('dashboard'); // NEW: Set initial view to Dashboard
Â  Â  </script>
</body>
</html>
