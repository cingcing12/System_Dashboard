<!DOCTYPE html>
<html lang="km">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>គ្រប់គ្រងអ្នកប្រើប្រាស់ - Admin</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Khmer+OS+Battambang:wght@400;600;700&display=swap');
:root{
  --accent: #6b46c1;
  --muted: #94a3b8;
  --surface: #ffffff;
  --glass: rgba(255,255,255,0.85);
}
body{ font-family:'Khmer OS Battambang', sans-serif; background:linear-gradient(180deg,#fbfbfd 0%, #f5f7fb 100%); min-height:100vh; color:#0f172a; }

/* Minimal modal overlay */
.modal { display:none; position:fixed; inset:0; background:rgba(15,23,42,0.35); z-index:50; align-items:center; justify-content:center; padding:1rem; }
.modal.active{ display:flex; }

/* Minimal card */
.card-min { background:var(--surface); border-radius:14px; border:1px solid #e6eefb; box-shadow: none; }

/* Thin subtle shadow only on capture button */
.capture-btn {
  width:70px; height:70px; border-radius:9999px;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(180deg,#fff 0%, #f3f4f6 100%);
  border:1px solid rgba(15,23,42,0.06);
  box-shadow: 0 8px 18px rgba(11,16,28,0.06);
  transition: transform .12s ease, box-shadow .12s ease;
}
.capture-btn:active{ transform: scale(.98); box-shadow: 0 6px 12px rgba(11,16,28,0.08); }

/* Minimal video wrapper */
.video-wrapper { background:#000; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; position:relative; }

/* Small muted text */
.small-muted { color:var(--muted); font-size:0.87rem; }

/* subtle control buttons */
.icon-btn { background:transparent; border:1px solid #eef2ff; padding:6px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; }
.icon-btn:focus{ outline:2px solid rgba(107,70,193,0.12); }

/* preview image style */
.capture-preview { width:100%; height:auto; border-radius:8px; display:block; object-fit:contain; background:#0b1220; }

/* responsive limits */
.camera-card { width:100%; max-width:720px; }
@media (max-width:640px){ .capture-btn { width:60px; height:60px; } }
</style>
</head>
<body>

<header class="bg-white p-4 sticky top-0 z-20 border-b border-gray-100">
  <div class="max-w-7xl mx-auto flex justify-between items-center">
    <h1 class="text-2xl font-semibold text-gray-900 flex items-center gap-3">
      <i data-lucide="shield-check" class="w-6 h-6 text-violet-600"></i>
      គ្រប់គ្រងអ្នកប្រើប្រាស់
    </h1>
    <button onclick="window.location.href='dashboard.html'" class="text-white bg-violet-600 px-4 py-2 rounded-lg text-sm hover:bg-violet-700">ផ្ទាំងគ្រប់គ្រង</button>
  </div>
</header>

<main class="max-w-7xl mx-auto p-4 md:p-8">
  <section class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm mb-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
      <h2 class="text-xl font-bold">បញ្ជីគណនី</h2>
      <button onclick="openModal()" class="bg-violet-600 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
        <i data-lucide="user-plus" class="w-4 h-4"></i> បង្កើតគណនីថ្មី
      </button>
    </div>
    <div id="user-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <p class="col-span-full text-center text-gray-500 py-10">កំពុងទាញទិន្នន័យ...</p>
    </div>
  </section>
</main>

<div id="userModal" class="modal" role="dialog" aria-modal="true">
  <div class="card-min camera-card p-5">
    <div class="flex justify-between items-center mb-4">
      <h3 id="modalTitle" class="text-lg font-semibold">បង្កើតគណនីថ្មី</h3>
      <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 p-2 rounded-md"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>

    <form id="modalForm" class="space-y-4" enctype="multipart/form-data" autocomplete="off">
      <div>
        <label class="block text-gray-700 text-sm mb-1">អ៊ីម៉ែល</label>
        <input id="modalEmail" name="email" type="email" required class="w-full p-3 border rounded-md text-sm" placeholder="example@gmail.com" />
      </div>

      <div>
        <label class="block text-gray-700 text-sm mb-1">ពាក្យសម្ងាត់</label>
        <input id="modalPassword" name="password" type="password" class="w-full p-3 border rounded-md text-sm" placeholder="ពាក្យសម្ងាត់សម្រាប់គណនី" />
        <p class="text-xs small-muted mt-1">នៅលើការកែប្រែ: ទុកទំនេរ ប្រសិនបើមិនចង់ផ្លាស់ប្តូរ</p>
      </div>

      <div>
        <label class="block text-gray-700 text-sm mb-1">តួនាទី</label>
        <select id="modalRole" name="role" class="w-full p-3 border rounded-md text-sm">
          <option value="Admin">Admin (អ្នកគ្រប់គ្រង)</option>
          <option value="Owner">Owner (ម្ចាស់)</option>
          <option value="Staff" selected>Staff (បុគ្គលិក)</option>
        </select>
      </div>

      <div>
        <label class="block text-gray-700 text-sm mb-1">រូបថតមុខ (Face image)</label>
        <div class="flex items-center gap-3">
          <div>
            <img id="imgPreview" class="w-20 h-20 rounded-full object-cover border border-gray-100" src="" alt="Preview" style="display:none;" />
          </div>
          <div class="flex-1">
            <div class="flex gap-2">
              <label id="uploadBtn" class="flex items-center gap-2 px-3 py-2 border rounded-md cursor-pointer text-sm small-muted">
                <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                <span>ជ្រើសរើសរូបភាព</span>
                <input id="modalImage" name="faceImage" type="file" accept="image/*" class="sr-only" />
              </label>

              <button type="button" id="openCameraBtn" class="flex items-center gap-2 px-3 py-2 border rounded-md text-sm small-muted">
                <i data-lucide="camera" class="w-4 h-4"></i>
                <span>ថតដោយកាមេរ៉ា</span>
              </button>
            </div>
            <p id="faceSourceNote" class="mt-2 small-muted">ជ្រើសរើសឯកសារ ឬ ថតរូបសម្រាប់គណនី</p>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-md border text-sm">បោះបង់</button>
        <button type="submit" id="modalSaveBtn" class="px-4 py-2 rounded-md bg-violet-600 text-white text-sm">រក្សាទុក</button>
      </div>
    </form>
  </div>
</div>

<div id="cameraModal" class="modal" aria-modal="true" role="dialog">
  <div class="card-min p-4 camera-card">
    <div class="flex justify-between items-center mb-3">
      <div>
        <h4 class="text-sm font-medium">ថតរូបមុខ</h4>
        <p class="small-muted text-xs">សូមផ្ទុកមុខក្នុងកណ្ដាល និងមានពន្លឺល្អ</p>
      </div>
      <div class="flex items-center gap-2">
        <select id="cameraSelect" class="text-sm p-2 border rounded-md small-muted hidden"></select>
        <button id="switchCamBtn" class="icon-btn" title="បម្លែងកាមេរ៉ា"><i data-lucide="repeat" class="w-4 h-4"></i></button>
        <button id="openBackCamBtn" class="icon-btn" title="បើកកាមេរ៉ាក្រោយ"><i data-lucide="camera-off" class="w-4 h-4"></i></button>
        <button id="closeCamera" class="icon-btn" title="បិទ"><i data-lucide="x" class="w-4 h-4"></i></button>
      </div>
    </div>

    <div class="video-wrapper mb-3" style="height:360px;">
      <video id="cameraVideo" autoplay playsinline class="w-full h-full object-cover"></video>
      <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;">
        <div style="width:52%; height:52%; border-radius:9999px; border:1px dashed rgba(255,255,255,0.12);"></div>
      </div>
    </div>

    <div class="flex flex-col items-center gap-3">
      <div class="flex items-center gap-6">
        <button id="retakeBtn" class="text-sm small-muted hidden">Retake</button>
        <div id="captureBtn" class="capture-btn" role="button" title="Capture">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden>
            <path d="M12 7a5 5 0 100 10 5 5 0 000-10z" stroke="#0f172a" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M20 7h-3.2l-1.4-1.7A2 2 0 0013.8 4H10.2a2 2 0 00-1.6.3L7.2 6H4" stroke="#0f172a" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </div>
        <button id="acceptBtn" class="text-sm small-muted hidden">Accept</button>
      </div>

      <p id="cameraInstructions" class="small-muted text-xs">ចុចប៊ូតុងមធ្យមដើម្បីថត។</p>

      <div id="cameraPreviewContainer" class="w-full" style="display:none;">
        <img id="cameraPreview" class="capture-preview" src="" alt="preview" />
      </div>
    </div>
  </div>
</div>

<canvas id="captureCanvas" style="display:none;"></canvas>

<script>
/* Initialize icons */
lucide.createIcons();

/* Configuration */
const NODE_API_BASE = "https://system-dashboard-ljf1.onrender.com";
const SHEETDB_BASE_URL = "https://sheetdb.io/api/v1/2qesrzmr4nggw";
const SHEET_USERS = "Users";

/* Elements */
const userList = document.getElementById('user-list');
const modal = document.getElementById('userModal');
const cameraModal = document.getElementById('cameraModal');
const modalForm = document.getElementById('modalForm');
const modalTitle = document.getElementById('modalTitle');
const modalEmail = document.getElementById('modalEmail');
const modalPassword = document.getElementById('modalPassword');
const modalRole = document.getElementById('modalRole');
const modalImage = document.getElementById('modalImage');
const imgPreview = document.getElementById('imgPreview');
const modalSaveBtn = document.getElementById('modalSaveBtn');
const openCameraBtn = document.getElementById('openCameraBtn');
const cameraVideo = document.getElementById('cameraVideo');
const cameraSelect = document.getElementById('cameraSelect');
const switchCamBtn = document.getElementById('switchCamBtn');
const captureBtn = document.getElementById('captureBtn');
const retakeBtn = document.getElementById('retakeBtn');
const acceptBtn = document.getElementById('acceptBtn');
const cameraPreviewContainer = document.getElementById('cameraPreviewContainer');
const cameraPreview = document.getElementById('cameraPreview');
const closeCamera = document.getElementById('closeCamera');
const faceSourceNote = document.getElementById('faceSourceNote');
const captureCanvas = document.getElementById('captureCanvas');
const openBackCamBtn = document.getElementById('openBackCamBtn');

let editingUserEmail = null;
let currentUserEmail = '';
try {
  const user = JSON.parse(localStorage.getItem("user"));
  if (user && user.Email) currentUserEmail = user.Email;
} catch (e){ console.error(e); }

/* Camera state */
let stream = null;
let devices = [];
let currentDeviceId = null;
let isFront = true;
let capturedBlob = null;
let capturedDataUrl = null;

/* Modal open/close */
function openModal(user = null){
  modal.classList.add('active');
  modalForm.reset();
  imgPreview.style.display='none'; imgPreview.src='';
  capturedBlob = null; capturedDataUrl = null; faceSourceNote.textContent='';
  currentDeviceId = null;
  isFront = true;

  if(user){
    editingUserEmail = (user.Email||user['អ៊ីម៉េល']||user['អ៊ីម៉ែល'])||'';
    modalTitle.textContent = 'កែប្រែគណនី';
    modalEmail.value = editingUserEmail;
    modalEmail.disabled = true;
    modalRole.value = user.Role||user['តួនាទី']||'Staff';
    modalPassword.value = '';
    modalPassword.removeAttribute('required');
    const faceFile = user.FaceImageFile || user.FaceImage;
    if(faceFile){
      imgPreview.src = `faces/${editingUserEmail.replace(/[@.]/g,'_')}.jpg`;
      imgPreview.style.display='block';
      faceSourceNote.textContent = 'ប្រើរូបថត​នៅក្នុង​ប្រព័ន្ធ';
    } else {
      faceSourceNote.textContent = 'មិនមានរូបថត​នៅក្នុង​ប្រព័ន្ធ';
    }
  } else {
    editingUserEmail = null;
    modalTitle.textContent = 'បង្កើតគណនីថ្មី';
    modalEmail.disabled = false;
    modalPassword.setAttribute('required','required');
    faceSourceNote.textContent = 'ជ្រើសរើសឯកសារ ឬ ថតរូបសម្រាប់គណនី';
  }
}

function closeModal(){
  modal.classList.remove('active');
  modalForm.reset();
  imgPreview.style.display='none'; imgPreview.src='';
  editingUserEmail = null;
  capturedBlob = null; capturedDataUrl = null;
  faceSourceNote.textContent = '';
}

/* File input behavior */
document.getElementById('uploadBtn').addEventListener('click', ()=> modalImage.click());
modalImage.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f){ imgPreview.style.display='none'; imgPreview.src=''; faceSourceNote.textContent=''; return; }
  if(!f.type.startsWith('image/')){ Swal.fire({icon:'error', title:'ទម្ងន់ឯកសារ​មិនត្រឹមត្រូវ', text:'សូមជ្រើសរើសរូបភាព។'}); modalImage.value=''; return; }
  capturedBlob = null; capturedDataUrl = null;
  imgPreview.src = URL.createObjectURL(f);
  imgPreview.style.display = 'block';
  faceSourceNote.textContent = 'ប្រើរូបភាពដែលបានជ្រើសពីឧបករណ៍';
});

/* Camera handlers */
openCameraBtn.addEventListener('click', openCameraModal);
closeCamera.addEventListener('click', closeCameraModal);
switchCamBtn.addEventListener('click', switchCamera);
cameraSelect.addEventListener('change', async (e)=>{
  currentDeviceId = e.target.value || null;
  await startStream();
});

// Handler for Force Back Camera Button
openBackCamBtn.addEventListener('click', async () => {
  try {
    currentDeviceId = null; // Clear any specific device selection
    if (cameraSelect) cameraSelect.value = ""; // Clear dropdown selection
    isFront = false; // Set state to back camera
    await startStream(); // Restart stream
  } catch(err){
    console.error('Back camera failed', err);
    Swal.fire({icon:'error', title:'មិនអាចបើកកាមេរ៉ា​ក្រោយ', text:'សូមពិនិត្យឧបករណ៍'});  
  }
});

async function openCameraModal(){
  cameraModal.classList.add('active');
  cameraPreviewContainer.style.display='none';
  capturedBlob = null; capturedDataUrl = null;
  
  // Reset to front camera by default when opening
  currentDeviceId = null;
  isFront = true; 

  await enumerateCameras();
  await startStream();
}

function closeCameraModal(){
  cameraModal.classList.remove('active');
  stopStream();
}

async function enumerateCameras(){
  try{
    const list = await navigator.mediaDevices.enumerateDevices();
    devices = list.filter(d=>d.kind === 'videoinput');
    cameraSelect.innerHTML = '';
    if(devices.length > 1){
      const hasLabels = devices.some(d => d.label && d.label.trim().length > 0);
      if(hasLabels){
        cameraSelect.classList.remove('hidden');
        devices.forEach((d, i)=>{
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `Camera ${i+1}`;
          cameraSelect.appendChild(opt);
        });
        // Default to first device found
        currentDeviceId = devices[0].deviceId;
        cameraSelect.value = currentDeviceId;
      } else {
        cameraSelect.classList.add('hidden');
        currentDeviceId = null;
      }
    } else {
      cameraSelect.classList.add('hidden');
      currentDeviceId = null;
    }
  } catch (err){
    console.warn('enumerateDevices failed', err);
    cameraSelect.classList.add('hidden');
    currentDeviceId = null;
  }
}

async function startStream(){
  try{
    stopStream();

    const videoConstraints = {
      width: { ideal: 1280 },
      height: { ideal: 720 }
    };

    // Logic to handle device selection or forcing back camera
    if(currentDeviceId){
      videoConstraints.deviceId = { exact: currentDeviceId };
      // Try to detect if this ID is front or back for mirroring logic
      const match = devices.find(d => d.deviceId === currentDeviceId);
      if (match) {
         isFront = /front|selfie|user/i.test(match.label || '');
      }
    } else {
      // Fallback logic: if no ID, rely on facingMode
      if (!isFront) {
        // If user clicked "Back Camera", try to force environment
        videoConstraints.facingMode = { exact: "environment" };
      } else {
        videoConstraints.facingMode = "user";
      }
    }

    try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: false, video: videoConstraints });
    } catch (err) {
        // If "exact: environment" fails (common on laptops), retry with ideal "environment"
        if (!isFront && err.name === 'OverconstrainedError') {
            console.warn('Exact environment failed, retrying with ideal...');
            videoConstraints.facingMode = "environment";
            stream = await navigator.mediaDevices.getUserMedia({ audio: false, video: videoConstraints });
        } else {
            throw err;
        }
    }

    cameraVideo.srcObject = stream;
    // Mirror only if it's the front camera
    cameraVideo.style.transform = isFront ? "scaleX(-1)" : "scaleX(1)";
    await cameraVideo.play();
  } catch (err){
    console.error('startStream error', err);
    Swal.fire({ icon:'error', title:'មិនអាចចូលកាមេរ៉ា', text:'សូមអនុញ្ញាតឲ្យគេហទំព័រនេះប្រើកាមេរ៉ា ឬពិនិត្យឧបករណ៍' });
  }
}

function stopStream(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
  cameraVideo.pause();
  cameraVideo.srcObject = null;
}

async function switchCamera(){
  try {
    // If devices are listed and selectable
    if(devices.length > 1 && cameraSelect.classList.contains('hidden') === false){
      const idx = devices.findIndex(d => d.deviceId === currentDeviceId);
      const next = devices[(idx + 1) % devices.length];
      currentDeviceId = next.deviceId;
      cameraSelect.value = currentDeviceId;
      await startStream();
      return;
    }
    // If devices exist but no labels (select hidden)
    if(devices.length > 1 && cameraSelect.classList.contains('hidden')){
       // Simple toggle logic for device ID
       let idx = devices.findIndex(d => d.deviceId === currentDeviceId);
       if(idx === -1) idx = 0;
       const next = devices[(idx + 1) % devices.length];
       currentDeviceId = next.deviceId;
       await startStream();
       return;
    }
    
    // Fallback if no devices enumerated or just single camera logic
    isFront = !isFront;
    currentDeviceId = null;
    await startStream();
  } catch (err) {
    // Basic toggle if all else fails
    isFront = !isFront;
    currentDeviceId = null;
    await startStream();
  }
}

captureBtn.addEventListener('click', capturePhoto);
retakeBtn.addEventListener('click', retakeCapture);
acceptBtn.addEventListener('click', acceptCapture);

function capturePhoto(){
  if(!stream){ Swal.fire({icon:'error', title:'កាមេរ៉ាមិនប្រើប្រាស់', text:'សូមអនុញ្ញាត និងពិនិត្យកាមេរ៉ា'}); return; }
  const video = cameraVideo;
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;
  captureCanvas.width = w;
  captureCanvas.height = h;
  const ctx = captureCanvas.getContext('2d');
  
  // Flip horizontal only if front camera
  if(isFront){ ctx.translate(w, 0); ctx.scale(-1, 1); }
  
  ctx.drawImage(video, 0, 0, w, h);
  captureCanvas.toBlob((blob)=>{
    if(!blob){ Swal.fire({icon:'error', title:'ថតបរាជ័យ', text:'សូមព្យាយាមម្តងទៀត'}); return; }
    capturedBlob = blob;
    if(capturedDataUrl) URL.revokeObjectURL(capturedDataUrl);
    capturedDataUrl = URL.createObjectURL(blob);
    cameraPreview.src = capturedDataUrl;
    cameraPreviewContainer.style.display = 'block';
    retakeBtn.classList.remove('hidden');
    acceptBtn.classList.remove('hidden');
    captureBtn.classList.add('hidden');
    stopStream();
  }, 'image/jpeg', 0.92);
}

function retakeCapture(){
  capturedBlob = null;
  if(capturedDataUrl){ URL.revokeObjectURL(capturedDataUrl); capturedDataUrl = null; }
  cameraPreview.src = '';
  cameraPreviewContainer.style.display = 'none';
  retakeBtn.classList.add('hidden');
  acceptBtn.classList.add('hidden');
  captureBtn.classList.remove('hidden');
  startStream();
}

function acceptCapture(){
  if(!capturedBlob){ Swal.fire({icon:'error', title:'គ្មានរូបភាព', text:'សូមថតរូបម្តងទៀត'}); return; }
  imgPreview.src = capturedDataUrl;
  imgPreview.style.display = 'block';
  faceSourceNote.textContent = 'ប្រើរូបថតដែលបានថតពីកាមេរ៉ា';
  modalImage.value = '';
  closeCameraModal();
}

async function loadUsers(){
  userList.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">កំពុងទាញទិន្នន័យ...</p>';
  lucide.createIcons();
  try{
    const res = await fetch(`${SHEETDB_BASE_URL}?sheet=${SHEET_USERS}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    let data = await res.json();
    if(Array.isArray(data) && data.length>0) data = data.slice(1);
    const users = Array.isArray(data)? data : [];
    if(currentUserEmail){
      const filtered = users.filter(u => ((u.Email||u['អ៊ីម៉ែល']||'').toLowerCase() !== currentUserEmail.toLowerCase()));
      users.length = 0; users.push(...filtered);
    }
    if(!users.length){
      userList.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">⚠️ មិនមានគណនីអ្នកប្រើប្រាស់ផ្សេងទៀតទេ</p>'; return;
    }
    userList.innerHTML = users.map(u=>{
      const email = u.Email || u['អ៊ីម៉ែល'] || '';
      const role = u.Role || u['តួនាទី'] || 'Staff';
      const face = u.FaceImageFile || u.FaceImage || '';
      const blocked = (String(u.IsBlocked||'FALSE').toUpperCase() === 'TRUE');
      const faceSrc = face ? `faces/${email.replace(/[@.]/g,'_')}.jpg` : 'https://via.placeholder.com/40';
      return `
        <div class="bg-white p-4 rounded-lg border border-gray-100 flex flex-col gap-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <img src="${faceSrc}" class="w-10 h-10 rounded-full object-cover border" />
              <div>
                <div class="text-sm font-medium">${email}</div>
                <div class="text-xs small-muted">${role}</div>
              </div>
            </div>
            <div>
              <span class="text-xs px-2 py-1 rounded-full text-white bg-violet-600">${role}</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button onclick='openModal(${JSON.stringify(u)})' class="text-sm px-3 py-1 border rounded-md small-muted flex items-center gap-2"><i data-lucide="square-pen" class="w-4 h-4"></i> កែប្រែ</button>
            <button onclick='toggleBlockSwal("${email}","${blocked}")' class="text-sm px-3 py-1 border rounded-md small-muted flex items-center gap-2" title="${blocked ? 'Unblock' : 'Block'}">
              ${blocked ? '<i data-lucide="check-circle" class="w-4 h-4 text-emerald-600"></i>' : '<i data-lucide="ban" class="w-4 h-4 text-orange-600"></i>'}
            </button>
            <button onclick='deleteUserSwal("${email}")' class="text-sm px-3 py-1 border rounded-md text-red-600 flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> លុប</button>
          </div>
        </div>
      `;
    }).join('');
    lucide.createIcons();
  }catch(err){
    console.error(err);
    userList.innerHTML = '<p class="col-span-full text-center text-red-500 py-10">❌ មានបញ្ហាក្នុងការទាញទិន្នន័យ។ សូមពិនិត្យ Console។</p>';
  }
}

modalForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  modalSaveBtn.disabled = true;
  modalSaveBtn.textContent = 'កំពុងរក្សាទុក...';
  const email = modalEmail.value.trim();
  const password = modalPassword.value.trim();
  const role = modalRole.value;
  const file = modalImage.files[0];
  try{
    if(!editingUserEmail){
      if(!email || !password){ Swal.fire({icon:'warning',title:'ទិន្នន័យមិនពេញលេញ', text:'សូមបញ្ចូលអ៊ីម៉ែល និងពាក្យសម្ងាត់'}); modalSaveBtn.disabled=false; modalSaveBtn.textContent='រក្សាទុក'; return; }
      if(!file && !capturedBlob){ Swal.fire({icon:'warning',title:'ទិន្នន័យមិនពេញលេញ', text:'សូមជ្រើសរើសរូបភាព ឬ ថតរូប'}); modalSaveBtn.disabled=false; modalSaveBtn.textContent='រក្សាទុក'; return; }
      const fd = new FormData();
      fd.append('email', email);
      fd.append('password', password);
      fd.append('role', role);
      if(capturedBlob){ fd.append('faceImage', capturedBlob, `captured_${email.replace(/[@.]/g,'_')}.jpg`); } else if(file){ fd.append('faceImage', file); }
      const res = await fetch(`${NODE_API_BASE}/api/register`, { method:'POST', body:fd });
      if(!res.ok){ const txt = await res.text().catch(()=>null); throw new Error(txt || 'Server error'); }
      Swal.fire({icon:'success', title:'បានបង្កើត', text:`គណនី ${email} ត្រូវបានបង្កើត`});
    } else {
      if(capturedBlob){
        const fd = new FormData();
        fd.append('email', editingUserEmail);
        fd.append('faceImage', capturedBlob, `captured_${editingUserEmail.replace(/[@.]/g,'_')}.jpg`);
        const r = await fetch(`${NODE_API_BASE}/api/update-face`, { method:'POST', body:fd });
        if(!r.ok) throw new Error('Failed to update face image');
      } else if(file) {
        const fd = new FormData();
        fd.append('email', editingUserEmail);
        fd.append('faceImage', file);
        const r = await fetch(`${NODE_API_BASE}/api/update-face`, { method:'POST', body:fd });
        if(!r.ok) throw new Error('Failed to update face image');
      }
      const patchData = { Role: role };
      if(password) patchData.Password = password;
      await fetch(`${SHEETDB_BASE_URL}/Email/${encodeURIComponent(editingUserEmail)}`, {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ data:[patchData] })
      });
      Swal.fire({icon:'success', title:'បានកែប្រែ', text:`គណនី ${editingUserEmail} ត្រូវបានកែប្រែ`});
    }
    closeModal();
    await loadUsers();
  }catch(err){
    console.error(err);
    Swal.fire({icon:'error', title:'មានបញ្ហា', text: err.message || String(err)});
  } finally {
    modalSaveBtn.disabled = false;
    modalSaveBtn.textContent = 'រក្សាទុក';
  }
});

async function toggleBlockSwal(email,currentStatus){
  const isBlocked = String(currentStatus).toUpperCase() === 'TRUE';
  const action = isBlocked ? 'ដោះ Block' : 'ដាក់ Block';
  const result = await Swal.fire({ title:`តើអ្នកចង់ ${action}?`, icon:'question', showCancelButton:true, confirmButtonText:'យល់ព្រម', cancelButtonText:'បោះបង់' });
  if(!result.isConfirmed) return;
  try{
    await fetch(`${SHEETDB_BASE_URL}/Email/${encodeURIComponent(email)}`,{
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ data:[{ IsBlocked: !isBlocked ? 'TRUE' : 'FALSE' }] })
    });
    Swal.fire({icon:'success', title:'បានបញ្ចប់'});
    await loadUsers();
  } catch (err){ console.error(err); Swal.fire({icon:'error', title:'មានបញ្ហា', text: err.message || String(err)}); }
}

async function deleteUserSwal(email){
  const result = await Swal.fire({ title:`តើអ្នកចង់លុប ${email}?`, icon:'warning', showCancelButton:true, confirmButtonText:'លុប', cancelButtonText:'បោះបង់' });
  if(!result.isConfirmed) return;
  try{
    await fetch(`${SHEETDB_BASE_URL}/Email/${encodeURIComponent(email)}`,{ method:'DELETE' });
    await fetch(`${NODE_API_BASE}/api/delete-face`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ email })
    });
    Swal.fire({icon:'success', title:'បានលុប'});
    await loadUsers();
  } catch(err){ console.error(err); Swal.fire({icon:'error', title:'មានបញ្ហា', text: err.message || String(err)}); }
}

loadUsers();
window.addEventListener('beforeunload', ()=> { if(stream) stream.getTracks().forEach(t=>t.stop()); });
</script>

</body>
</html>
