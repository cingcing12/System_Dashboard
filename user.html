<!DOCTYPE html>
<html lang="km">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹ - Admin</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Khmer+OS+Battambang:wght@400;600;700&display=swap');
body { font-family: 'Khmer OS Battambang', sans-serif; min-height:100vh; background:linear-gradient(180deg,#fbfbfe 0%, #f3f4f6 100%); }
.hide-scrollbar::-webkit-scrollbar { display:none; } 
.hide-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
.modal { display:none; position:fixed; inset:0; background:rgba(20,20,30,0.6); justify-content:center; align-items:center; z-index:50; backdrop-filter: blur(4px); padding:1rem; }
.modal.active { display:flex; }
.card-shadow { box-shadow: 0 12px 30px rgba(9,10,20,0.06); }
input:focus, select:focus, textarea:focus { outline: 3px solid rgba(107,70,193,0.12); border-color:#6b46c1; box-shadow:0 2px 8px rgba(107,70,193,0.08); }
.img-preview { width:84px; height:84px; object-fit:cover; border-radius:50%; border:1px solid #e5e7eb; }
.user-face { width:40px; height:40px; object-fit:cover; border-radius:50%; border:1px solid #e5e7eb; }

/* camera modal specifics */
.camera-view { background:linear-gradient(180deg,#0f172a,#0b1220); border-radius:12px; padding:12px; max-width:820px; width:100%; color:#fff; }
.video-box { background:#000; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; position:relative; }
.video-box video { display:block; width:100%; height:100%; object-fit:cover; max-height:60vh; }
.camera-controls button:focus { outline: 2px solid rgba(255,255,255,0.12); }
.small-muted { font-size:0.8rem; color:#cbd5e1; }

/* nicer grid for cards */
.user-card { transition: transform .18s ease, box-shadow .18s ease; }
.user-card:hover { transform: translateY(-4px); box-shadow: 0 14px 30px rgba(9,10,20,0.08); }

/* capture preview */
.capture-preview { width:100%; max-height:360px; object-fit:contain; border-radius:8px; background:#111; display:block; }
</style>
</head>
<body>

<header class="bg-white shadow-lg p-4 sticky top-0 z-10 border-b-2 border-purple-100">
  <div class="max-w-7xl mx-auto flex justify-between items-center">
    <h1 class="text-3xl font-extrabold text-purple-700 flex items-center">
      <i data-lucide="shield-check" class="w-7 h-7 mr-3 text-purple-600"></i> á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹
    </h1>
    <button onclick="window.location.href='dashboard.html'" class="bg-blue-600 text-white p-3 px-6 rounded-xl font-semibold hover:bg-blue-700 transition duration-200 flex items-center shadow-md">
      <span class="hidden sm:inline mr-2">á•áŸ’á‘á¶áŸ†á„á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„</span><i data-lucide="layout-dashboard" class="w-5 h-5"></i>
    </button>
  </div>
</header>

<main class="max-w-7xl mx-auto p-4 md:p-8">
  <section class="bg-white p-6 rounded-2xl card-shadow mb-8 border-t-8 border-purple-600">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4 sm:mb-0">á”á‰áŸ’á‡á¸á‚áá“á¸</h2>
      <button onclick="openModal()" class="bg-purple-600 text-white px-5 py-3 rounded-xl flex items-center font-semibold hover:bg-purple-700 transition duration-200 shadow-lg">
        <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> á”á„áŸ’á€á¾áá‚áá“á¸ááŸ’á˜á¸
      </button>
    </div>
    <div id="user-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[70vh] overflow-y-auto hide-scrollbar">
      <p class="col-span-full text-center text-gray-500 py-10 text-lg">á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</p>
    </div>
  </section>
</main>

<!-- Main user modal -->
<div id="userModal" class="modal" role="dialog" aria-modal="true">
  <div class="bg-white rounded-2xl p-6 w-full max-w-lg relative shadow-2xl transform transition-all">
    <h3 id="modalTitle" class="text-2xl font-bold text-purple-700 mb-4 border-b pb-2">á”á„áŸ’á€á¾áá‚áá“á¸ááŸ’á˜á¸</h3>
    <form id="modalForm" class="space-y-4" enctype="multipart/form-data" autocomplete="off">
      <div>
        <label class="block text-gray-700 mb-1">á¢áŸŠá¸á˜áŸ‰áŸ‚á›</label>
        <input id="modalEmail" name="email" type="email" required class="w-full p-3 border rounded-lg" placeholder="example@gmail.com" />
      </div>
      <div>
        <label class="block text-gray-700 mb-1">á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹</label>
        <input id="modalPassword" name="password" type="password" class="w-full p-3 border rounded-lg" placeholder="á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹áŸá˜áŸ’ášá¶á”áŸ‹á‚áá“á¸" />
        <p id="passwordHint" class="text-xs text-gray-500 mt-1">á“áŸ…á›á¾á€á¶ášá€áŸ‚á”áŸ’ášáŸ‚: á›áŸááŸá˜áŸ’á„á¶ááŸ‹á²áŸ’á™á‘á»á€á‘áŸ†á“áŸáš á”áŸ’ášáŸá·á“á”á¾á˜á·á“á…á„áŸ‹á•áŸ’á›á¶áŸáŸ‹á”áŸ’áá¼áš</p>
      </div>
      <div>
        <label class="block text-gray-700 mb-1">áá½á“á¶á‘á¸</label>
        <select id="modalRole" name="role" class="w-full p-3 border rounded-lg">
          <option value="Admin">Admin (á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„)</option>
          <option value="Owner">Owner (á˜áŸ’á…á¶áŸáŸ‹)</option>
          <option value="Staff" selected>Staff (á”á»á‚áŸ’á‚á›á·á€)</option>
        </select>
      </div>

      <!-- Face image area: upload OR take photo (Option B) -->
      <div>
        <label class="block text-gray-700 mb-1">ášá¼á”ááá˜á»á (Face image)</label>
        <div class="flex items-start space-x-4">
          <img id="imgPreview" class="img-preview bg-gray-100" src="" alt="Preview" style="display:none"/>
          <div class="flex-1">
            <div class="flex gap-2 items-center">
              <label class="w-full">
                <input id="modalImage" name="faceImage" type="file" accept="image/*" class="sr-only" />
                <div id="uploadBtn" class="cursor-pointer w-full text-sm p-2 border rounded-lg bg-white text-gray-700 hover:shadow-sm"> <i data-lucide="upload-cloud" class="inline w-4 h-4 mr-2"></i> á‡áŸ’ášá¾áŸášá¾áŸášá¼á”á—á¶á–á–á¸á§á”á€ášááŸ</div>
              </label>

              <!-- Camera button opens separate camera modal (Option B) -->
              <button type="button" id="openCameraBtn" class="flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                <i data-lucide="camera" class="w-4 h-4"></i> ááášá¼á”áá¶á˜á€á¶á˜áŸášáŸ‰á¶
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">JPEG/PNG â€” áŸá¼á˜á•áŸ’á‘á»á€ášá¼á”ááá˜á»áá“áŸ…á›á¾á€áŸ’á”á¶á› (front view). á¢áŸ’á“á€á¢á¶á…á‡áŸ’ášá¾áŸášá¾áŸá¯á€áŸá¶áš á¬ ááášá¼á”áŸ”</p>
            <p id="faceSourceNote" class="text-xs mt-1 small-muted"></p>
          </div>
        </div>
      </div>

      <div class="flex justify-end space-x-2 pt-4 border-t">
        <button type="button" onclick="closeModal()" class="px-5 py-2 bg-gray-200 rounded-xl">á”áŸ„áŸ‡á”á„áŸ‹</button>
        <button type="submit" id="modalSaveBtn" class="px-5 py-2 bg-purple-600 text-white rounded-xl">ášá€áŸ’áŸá¶á‘á»á€á‘á·á“áŸ’á“á“áŸá™</button>
      </div>
    </form>
    <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full">
      <i data-lucide="x" class="w-6 h-6"></i>
    </button>
  </div>
</div>

<!-- Separate Camera Modal (Option B) -->
<div id="cameraModal" class="modal" aria-modal="true" role="dialog">
  <div class="camera-view p-4 w-full max-w-3xl">
    <div class="flex justify-between items-center mb-3">
      <h4 class="text-lg font-semibold">ááášá¼á”á˜á»á - á€á¶á˜áŸášáŸ‰á¶</h4>
      <div class="flex items-center gap-3">
        <select id="cameraSelect" class="p-2 rounded-md bg-slate-900 small-muted" aria-label="Select camera"></select>
        <button id="switchCamBtn" class="px-3 py-2 rounded-md border small-muted">á”á˜áŸ’á›áŸ‚á„á€á¶á˜áŸášáŸ‰á¶</button>
        <button id="closeCamera" class="text-white px-3 py-2 rounded-md bg-red-600 hover:bg-red-700">á”á·á‘</button>
      </div>
    </div>

    <div class="video-box rounded-lg overflow-hidden mb-3">
      <video id="cameraVideo" autoplay playsinline></video>
      <!-- canvas for capture appears when captured -->
    </div>

    <div id="captureArea" class="flex items-center justify-between gap-3">
      <div class="flex-1">
        <p id="cameraInstructions" class="small-muted">á…á»á… <strong>áá</strong> áŠá¾á˜áŸ’á”á¸ááášá¼á”áŸ” á”áŸ’ášáŸá·á“á”á¾á…á„áŸ‹áŠá€áá áŸá¼á˜á…á»á… <strong>Retake</strong>.</p>
      </div>

      <div class="flex items-center gap-2 camera-controls">
        <button id="captureBtn" class="px-4 py-2 rounded-lg bg-green-500 text-white shadow">ğŸ“¸ áá</button>
        <button id="retakeBtn" class="px-4 py-2 rounded-lg bg-yellow-500 text-white hidden">ğŸ” Retake</button>
        <button id="acceptBtn" class="px-4 py-2 rounded-lg bg-purple-600 text-white hidden">âœ… Accept</button>
      </div>
    </div>

    <div id="cameraPreviewContainer" class="mt-3" style="display:none;">
      <p class="text-sm small-muted mb-2">á˜á¾á›ášá¼á”áááŠáŸ‚á›á”á¶á“áá</p>
      <img id="cameraPreview" class="capture-preview" src="" alt="ááášá¼á” Preview" />
    </div>
  </div>
</div>

<script>
lucide.createIcons();

/* Config */
const NODE_API_BASE = "https://system-dashboard-ljf1.onrender.com";
const SHEETDB_BASE_URL = "https://sheetdb.io/api/v1/oz77mi92j3l73";
const SHEET_USERS = "Users";

/* Elements */
const userList = document.getElementById('user-list');
const modal = document.getElementById('userModal');
const cameraModal = document.getElementById('cameraModal');
const modalForm = document.getElementById('modalForm');
const modalTitle = document.getElementById('modalTitle');
const modalEmail = document.getElementById('modalEmail');
const modalPassword = document.getElementById('modalPassword');
const modalRole = document.getElementById('modalRole');
const modalImage = document.getElementById('modalImage');
const imgPreview = document.getElementById('imgPreview');
const modalSaveBtn = document.getElementById('modalSaveBtn');
const openCameraBtn = document.getElementById('openCameraBtn');
const cameraVideo = document.getElementById('cameraVideo');
const cameraSelect = document.getElementById('cameraSelect');
const switchCamBtn = document.getElementById('switchCamBtn');
const captureBtn = document.getElementById('captureBtn');
const retakeBtn = document.getElementById('retakeBtn');
const acceptBtn = document.getElementById('acceptBtn');
const cameraPreviewContainer = document.getElementById('cameraPreviewContainer');
const cameraPreview = document.getElementById('cameraPreview');
const closeCamera = document.getElementById('closeCamera');
const faceSourceNote = document.getElementById('faceSourceNote');

let editingUserEmail = null;
let currentUserEmail = '';
try {
    const user = JSON.parse(localStorage.getItem("user"));
    if (user && user.Email) currentUserEmail = user.Email;
} catch (e) { console.error(e); }

/* Camera state */
let stream = null;
let currentDeviceId = null;
let devices = [];
let capturedBlob = null; // holds the captured image blob (if user used camera)
let capturedDataUrl = null; // data URL for preview

// Initialize lucide icons again for dynamic content
lucide.createIcons();

/* Helpers */
function showSwal(icon, title, text) {
  Swal.fire({ icon, title, text, confirmButtonText: 'á™á›áŸ‹á–áŸ’ášá˜', confirmButtonColor: '#6b46c1' });
}
function getField(u, names) {
  for (const k of names) if (u[k] !== undefined) return u[k];
  return "";
}

/* --- Modal open/close --- */
function openModal(user = null) {
  modal.classList.add('active');
  modalForm.reset();
  imgPreview.style.display='none'; imgPreview.src='';
  capturedBlob = null;
  capturedDataUrl = null;
  faceSourceNote.textContent = '';

  if(user){
    editingUserEmail = getField(user,['Email','á¢áŸŠá¸á˜áŸ‰áŸ‚á›']);
    modalTitle.textContent="á€áŸ‚á”áŸ’ášáŸ‚á‚áá“á¸";
    modalEmail.value = editingUserEmail; modalEmail.disabled=true;
    modalRole.value = getField(user,['Role','áá½á“á¶á‘á¸'])||'Staff';
    modalPassword.value="";
    modalPassword.removeAttribute('required');
    const faceFile = getField(user,['FaceImageFile','FaceImage']);
    if(faceFile){
      imgPreview.src = `faces/${editingUserEmail.replace(/[@.]/g,'_')}.jpg`;
      imgPreview.style.display='block';
      faceSourceNote.textContent = 'á”áŸ’ášá¾ášá¼á”áááŠáŸ‚á›á˜á¶á“á€áŸ’á“á»á„á”áŸ’ášá–áŸá“áŸ’á’áŸ”';
    } else {
      faceSourceNote.textContent = 'á˜á·á“á˜á¶á“ášá¼á”ááá“áŸ…á€áŸ’á“á»á„á”áŸ’ášá–áŸá“áŸ’á’áŸ” á¢áŸ’á“á€á¢á¶á…á‡áŸ’ášá¾áŸášá¾áŸá¯á€áŸá¶áš á¬ ááášá¼á”áŸ”';
    }
  } else {
    editingUserEmail = null;
    modalTitle.textContent="á”á„áŸ’á€á¾áá‚áá“á¸ááŸ’á˜á¸";
    modalEmail.disabled=false;
    modalPassword.setAttribute('required','required');
    modalRole.value='Staff';
    faceSourceNote.textContent = 'áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸá¯á€áŸá¶áš á¬ ááášá¼á”áŸá˜áŸ’ášá¶á”áŸ‹á‚áá“á¸ááŸ’á˜á¸áŸ”';
  }
}

function closeModal() { modal.classList.remove('active'); modalForm.reset(); imgPreview.style.display='none'; imgPreview.src=''; editingUserEmail=null; capturedBlob=null; capturedDataUrl=null; faceSourceNote.textContent=''; }

/* --- File input handling --- */
document.getElementById('uploadBtn').addEventListener('click', ()=> modalImage.click());
modalImage.addEventListener('change',(e)=>{
  const f = e.target.files[0];
  if(!f){ imgPreview.style.display='none'; imgPreview.src=''; faceSourceNote.textContent=''; return; }
  if(!f.type.startsWith('image/')) { showSwal('error','á‘á˜áŸ’á„á“áŸ‹á¯á€áŸá¶ášâ€‹á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœ','áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸášá¼á”á—á¶á–áŸ”'); modalImage.value=''; return; }
  // clear any previously captured camera blob
  capturedBlob = null;
  capturedDataUrl = null;
  imgPreview.src = URL.createObjectURL(f);
  imgPreview.style.display='block';
  faceSourceNote.textContent = 'á”áŸ’ášá¾ášá¼á”á—á¶á–áŠáŸ‚á›á¢áŸ’á“á€á”á¶á“á”á‰áŸ’á…á¼á›á–á¸á§á”á€ášááŸáŸ”';
});

/* --- Camera modal logic (Option B) --- */
openCameraBtn.addEventListener('click', openCameraModal);
closeCamera.addEventListener('click', closeCameraModal);

async function openCameraModal(){
  cameraModal.classList.add('active');
  cameraPreviewContainer.style.display='none';
  capturedBlob = null; capturedDataUrl = null;
  await refreshCameras();
  await startStream(); // start with default or selected device
}

async function closeCameraModal(){
  cameraModal.classList.remove('active');
  stopStream();
}

async function refreshCameras(){
  try{
    const list = await navigator.mediaDevices.enumerateDevices();
    devices = list.filter(d=>d.kind==='videoinput');
    cameraSelect.innerHTML = '';
    devices.forEach((d, i)=>{
      const label = d.label || `Camera ${i+1}`;
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = label;
      cameraSelect.appendChild(opt);
    });
    if(devices.length>0){
      currentDeviceId = devices[0].deviceId;
      cameraSelect.value = currentDeviceId;
    }
  }catch(err){
    console.error('Device enumeration failed', err);
    // leave select empty; user might still be able to use default facingMode
  }
}

cameraSelect.addEventListener('change', async (e)=>{
  currentDeviceId = e.target.value;
  await startStream();
});

switchCamBtn.addEventListener('click', async ()=>{
  // attempt to cycle through the discovered cameras
  if(!devices || devices.length<=1){
    // toggle facingMode as fallback
    // get current constraint facingMode (try 'environment' vs 'user')
    // We'll restart stream with the other facingMode
    if (currentDeviceId === 'environment') currentDeviceId='user';
    else if (currentDeviceId === 'user') currentDeviceId='environment';
    else currentDeviceId = 'environment';
    await startStream();
    return;
  }
  const idx = devices.findIndex(d=>d.deviceId===currentDeviceId);
  const next = devices[(idx+1) % devices.length];
  currentDeviceId = next.deviceId;
  cameraSelect.value = currentDeviceId;
  await startStream();
});

async function startStream(){
  try{
    stopStream();
    let constraints = {
      audio: false,
      video: {}
    };
    // If we have a device id use it (best), else fallback to facingMode
    if(currentDeviceId && currentDeviceId !== 'environment' && currentDeviceId !== 'user'){
      constraints.video.deviceId = { exact: currentDeviceId };
    } else {
      // fallback options: prefer environment for back camera, user for front
      constraints.video.facingMode = currentDeviceId === 'environment' ? { exact: 'environment' } : 'user';
    }
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    cameraVideo.srcObject = stream;
    await cameraVideo.play();
  }catch(err){
    console.error('startStream error', err);
    showSwal('error','á˜á·á“á¢á¶á…á…á¼á›á€á¶á˜áŸášáŸ‰á¶','áŸá¼á˜á¢á“á»á‰áŸ’á‰á¶ááŠá›áŸ‹á‚áŸá á‘áŸ†á–áŸášá“áŸáŸ‡á”áŸ’ášá¾á€á¶á˜áŸášáŸ‰á¶ á¬á–á·á“á·ááŸ’á™á€á¶ášáá—áŸ’á‡á¶á”áŸ‹áŸ”');
  }
}

function stopStream(){
  try{
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    cameraVideo.pause();
    cameraVideo.srcObject = null;
  }catch(e){ console.error(e); }
}

/* Capture */
captureBtn.addEventListener('click', ()=>{
  if(!stream){
    showSwal('error','á˜á·á“á”á¶á“á—áŸ’á‡á¶á”áŸ‹á€á¶á˜áŸášáŸ‰á¶','áŸá¼á˜á”á¾á€á€á¶á˜áŸášáŸ‰á¶ á˜á»á“á–áŸá›áááŸ”');
    return;
  }
  const video = cameraVideo;
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;
  // Use a canvas to capture current frame
  const canvas = document.createElement('canvas');
  // For face photos, square/1:1 is common; keep aspect ratio but limit size
  const maxDim = 1024;
  let cw = w, ch = h;
  if (Math.max(w,h) > maxDim) {
    const scale = maxDim / Math.max(w,h);
    cw = Math.round(w * scale);
    ch = Math.round(h * scale);
  }
  canvas.width = cw;
  canvas.height = ch;
  const ctx = canvas.getContext('2d');
  // draw video frame
  ctx.drawImage(video, 0, 0, cw, ch);
  // convert to blob
  canvas.toBlob((blob)=>{
    if(!blob){ showSwal('error','á˜á·á“á”á¶á“ááá”á¶á“','á–áŸ’á™á¶á™á¶á˜á˜áŸ’áá„á‘áŸ€ááŸ”'); return; }
    capturedBlob = blob;
    const url = URL.createObjectURL(blob);
    capturedDataUrl = url;
    cameraPreview.src = url;
    cameraPreviewContainer.style.display='block';
    cameraPreviewContainer.scrollIntoView({behavior:'smooth'});
    // show preview controls
    captureBtn.classList.add('hidden');
    retakeBtn.classList.remove('hidden');
    acceptBtn.classList.remove('hidden');
    // also update main modal preview (but don't close camera modal until accept)
  }, 'image/jpeg', 0.9);
});

/* Retake */
retakeBtn.addEventListener('click', ()=>{
  // clear captured blob and show live video again
  capturedBlob = null;
  capturedDataUrl = null;
  cameraPreview.src = '';
  cameraPreviewContainer.style.display='none';
  captureBtn.classList.remove('hidden');
  retakeBtn.classList.add('hidden');
  acceptBtn.classList.add('hidden');
});

/* Accept captured photo -> attach to main modal preview and close camera modal */
acceptBtn.addEventListener('click', ()=>{
  if(!capturedBlob){ showSwal('error','á˜á·á“á˜á¶á“ášá¼á”á—á¶á–áŠáŸ‚á›á”á¶á“áá','áŸá¼á˜ááá˜áŸ’áá„á‘áŸ€ááŸ”'); return; }
  // set preview in main modal
  imgPreview.src = capturedDataUrl;
  imgPreview.style.display = 'block';
  faceSourceNote.textContent = 'á”áŸ’ášá¾ášá¼á”áááŠáŸ‚á›á”á¶á“ááá–á¸á€á¶á˜áŸášáŸ‰á¶áŸ”';
  // clear file input (so we know we should use capturedBlob)
  modalImage.value = '';
  // close camera modal (keep blob in memory until submit)
  closeCameraModal();
});

/* --- Load users (existing logic) --- */
async function loadUsers(){
  userList.innerHTML='<p class="col-span-full text-center text-gray-500 py-10 text-lg flex items-center justify-center"><i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-3"></i> á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</p>';
  lucide.createIcons();
  try{
    const res = await fetch(`${SHEETDB_BASE_URL}?sheet=${SHEET_USERS}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    let data = await res.json();
    data = data.slice(1); // Remove header row
    let users = Array.isArray(data)?data:[];

    // Filter out current logged-in user
    if (currentUserEmail) {
        users = users.filter(u => (getField(u, ['Email', 'á¢áŸŠá¸á˜áŸ‰áŸ‚á›']) || '').toLowerCase() !== currentUserEmail.toLowerCase());
    }

    if(!users.length){ userList.innerHTML='<p class="col-span-full text-center text-gray-500 py-10 text-xl border-dashed border-2 border-gray-300 rounded-lg m-4">âš ï¸ á˜á·á“á˜á¶á“á‚áá“á¸á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹á•áŸ’áŸáŸá„á‘áŸ€áá‘áŸ</p>'; return; }

    userList.innerHTML=users.map(u=>{
      const email = getField(u,['Email','á¢áŸŠá¸á˜áŸ‰áŸ‚á™'])|| getField(u,['Email','á¢áŸŠá¸á˜áŸ‰áŸ‚á›']) || '';
      const role = getField(u,['Role','áá½á“á¶á‘á¸'])||'Staff';
      const lastLogin = getField(u,['LastLogin','á…á¼á›á…á»á„á€áŸ’ášáŸ„á™'])||'á˜á·á“á’áŸ’á›á¶á”áŸ‹';
      const face = getField(u,['FaceImageFile','FaceImage'])||'';
      const isBlocked = (String(u['IsBlocked']||'FALSE').toUpperCase()==='TRUE');
      const blockBtnText = isBlocked?'áŠáŸ„áŸ‡ Block':'áŠá¶á€áŸ‹ Block';
      const blockBtnIcon = isBlocked?'unlock':'lock';
      const blockBtnColor = isBlocked?'bg-green-500 hover:bg-green-600':'bg-yellow-500 hover:bg-yellow-600';
      const statusText = isBlocked?'á‘á”áŸ‹áŸáŸ’á€á¶ááŸ‹':'áŸá€á˜áŸ’á˜';
      const statusColor = isBlocked?'text-red-600 bg-red-100':'text-green-600 bg-green-100';
      const roleColor = role==='Owner'?'bg-pink-600':(role==='Admin'?'bg-indigo-600':'bg-purple-600');

      const faceSrc = face ? `faces/${email.replace(/[@.]/g,'_')}.jpg` : 'https://via.placeholder.com/40';
      return `
        <div class="user-card bg-white p-4 rounded-xl shadow-lg border-l-4 ${isBlocked?'border-red-500':'border-purple-500'} transition hover:shadow-xl">
          <div class="flex justify-between items-center mb-3">
            <div class="flex items-center space-x-3">
              <img src="${faceSrc}" class="user-face" />
              <div>
                <p class="text-md font-bold text-gray-800 break-words">${email}</p>
                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusColor}">${statusText}</span>
              </div>
            </div>
            <span class="text-xs font-bold text-white px-3 py-1 rounded-full ${roleColor}">${role}</span>
          </div>
          <div class="flex justify-between mt-2 space-x-2">
            <button onclick='openModal(${JSON.stringify(u)})' class="flex-1 bg-blue-500 text-white px-2 py-1 rounded-lg text-xs flex items-center justify-center hover:bg-blue-600 transition"><i data-lucide="square-pen" class="w-4 h-4 mr-1"></i> á€áŸ‚á”áŸ’ášáŸ‚</button>
            <button onclick='toggleBlockSwal("${email}","${isBlocked}")' class="flex-1 text-white px-2 py-1 rounded-lg text-xs flex items-center justify-center ${blockBtnColor}"><i data-lucide="${blockBtnIcon}" class="w-4 h-4 mr-1"></i> ${blockBtnText}</button>
            <button onclick='deleteUserSwal("${email}")' class="flex-1 bg-red-500 text-white px-2 py-1 rounded-lg text-xs flex items-center justify-center hover:bg-red-600 transition"><i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> á›á»á”</button>
          </div>
        </div>
      `;
    }).join('');
    lucide.createIcons();
  }catch(err){
    userList.innerHTML='<p class="col-span-full text-center text-red-500 py-10 text-lg">âŒ á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá‘á¶á‰á‘á·á“áŸ’á“á“áŸá™áŸ” áŸá¼á˜á–á·á“á·ááŸ’á™á˜á¾á› ConsoleáŸ”</p>';
    console.error(err);
  }
}

/* Submit form */
modalForm.addEventListener('submit', async e=>{
  e.preventDefault();
  modalSaveBtn.disabled = true;
  modalSaveBtn.textContent = 'á€áŸ†á–á»á„ášá€áŸ’áŸá¶á‘á»á€...';

  const email = modalEmail.value.trim();
  const password = modalPassword.value.trim();
  const role = modalRole.value;
  const faceFile = modalImage.files[0];

  try{
    if(!editingUserEmail){
      if(!email || !password){ showSwal('warning','á‘á·á“áŸ’á“á“áŸá™á˜á·á“á–áŸá‰á›áŸá‰','áŸá¼á˜á”á‰áŸ’á…á¼á›á¢áŸŠá¸á˜áŸ‰áŸ‚á› á“á·á„á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹'); modalSaveBtn.disabled=false; modalSaveBtn.textContent='ášá€áŸ’áŸá¶á‘á»á€á‘á·á“áŸ’á“á“áŸá™'; return; }
      if(!faceFile && !capturedBlob){ showSwal('warning','á‘á·á“áŸ’á“á“áŸá™á˜á·á“á–áŸá‰á›áŸá‰','áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸášá¼á”á—á¶á–á˜á»á áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸá¯á€áŸá¶áš á¬ ááášá¼á”áŸ”'); modalSaveBtn.disabled=false; modalSaveBtn.textContent='ášá€áŸ’áŸá¶á‘á»á€á‘á·á“áŸ’á“á“áŸá™'; return; }

      const fd = new FormData();
      fd.append('email', email);
      fd.append('password', password);
      fd.append('role', role);
      // If camera captured blob exists, prefer it. Otherwise use uploaded file.
      if(capturedBlob){
        // name the file predictably so backend can store it as faces/<sanitized_email>.jpg if it wants
        const filename = `captured_${email.replace(/[@.]/g,'_')}.jpg`;
        fd.append('faceImage', capturedBlob, filename);
      } else if(faceFile){
        fd.append('faceImage', faceFile);
      }

      const res = await fetch(`${NODE_API_BASE}/api/register`, { method:'POST', body:fd });
      if(!res.ok) {
        const txt = await res.text().catch(()=>null);
        throw new Error(txt || 'Server error');
      }
      showSwal('success','á”á„áŸ’á€á¾áá”á¶á“á‡áŸ„á‚á‡áŸá™',`á‚áá“á¸ ${email} ááŸ’ášá¼áœá”á¶á“á”á„áŸ’á€á¾ááŸ”`);
    }else{
      // editing an existing user
      if(capturedBlob){
        const fd = new FormData();
        fd.append('email', editingUserEmail);
        fd.append('faceImage', capturedBlob, `captured_${editingUserEmail.replace(/[@.]/g,'_')}.jpg`);
        const faceRes = await fetch(`${NODE_API_BASE}/api/update-face`, { method:'POST', body:fd });
        if(!faceRes.ok) throw new Error('Failed to update face image');
      } else if(faceFile){
        const fd = new FormData();
        fd.append('email', editingUserEmail);
        fd.append('faceImage', faceFile);
        const faceRes = await fetch(`${NODE_API_BASE}/api/update-face`, { method:'POST', body:fd });
        if(!faceRes.ok) throw new Error('Failed to update face image');
      }

      // update role (and optionally password if provided)
      const patchData = { Role: role };
      if(password) patchData.Password = password; // only include password if provided (backend should hash)
      await fetch(`${SHEETDB_BASE_URL}/Email/${encodeURIComponent(editingUserEmail)}`, {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ data:[patchData] })
      });
      showSwal('success','á€áŸ‚á”áŸ’ášáŸ‚á”á¶á“á‡áŸ„á‚á‡áŸá™',`á‚áá“á¸ ${editingUserEmail} ááŸ’ášá¼áœá”á¶á“á€áŸ‚á”áŸ’ášáŸ‚áŸ”`);
    }
    closeModal();
    await loadUsers();
  }catch(err){ console.error(err); showSwal('error','á˜á¶á“á”á‰áŸ’á á¶',err.message||String(err)); }
  finally{ modalSaveBtn.disabled=false; modalSaveBtn.textContent='ášá€áŸ’áŸá¶á‘á»á€á‘á·á“áŸ’á“á“áŸá™'; }
});

/* Block/Unblock */
async function toggleBlockSwal(email,currentStatus){
  const isBlocked = String(currentStatus).toUpperCase() === 'TRUE';
  const action = isBlocked ? 'áŠáŸ„áŸ‡ Block' : 'áŠá¶á€áŸ‹ Block';
  const result = await Swal.fire({ title:`áá¾á¢áŸ’á“á€á…á„áŸ‹ ${action}?`, icon:'question', showCancelButton:true, confirmButtonText:'á™á›áŸ‹á–áŸ’ášá˜', cancelButtonText:'á”áŸ„áŸ‡á”á„áŸ‹', confirmButtonColor:'#6b46c1' });
  if(!result.isConfirmed) return;
  try{
    await fetch(`${SHEETDB_BASE_URL}/Email/${encodeURIComponent(email)}`,{
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ data:[{IsBlocked:!isBlocked?'TRUE':'FALSE'}] })
    });
    showSwal('success','á”á¶á“á”á‰áŸ’á…á”áŸ‹',`á‚áá“á¸ ${email} ááŸ’ášá¼áœá”á¶á“ ${!isBlocked?'á‘á”áŸ‹áŸáŸ’á€á¶ááŸ‹':'áŸá€á˜áŸ’á˜'}áŸ”`);
    await loadUsers();
  }catch(err){ console.error(err); showSwal('error','á˜á¶á“á”á‰áŸ’á á¶',err.message||String(err)); }
}

/* Delete */
async function deleteUserSwal(email){
  const result = await Swal.fire({ title:`áá¾á¢áŸ’á“á€á…á„áŸ‹á›á»á”á‚áá“á¸ ${email}?`, text:'á‘á·á“áŸ’á“á“áŸá™ á“á·á„ášá¼á”á—á¶á–á˜á»áá“á¹á„ááŸ’ášá¼áœá›á»á”.', icon:'warning', showCancelButton:true, confirmButtonText:'á›á»á”', cancelButtonText:'á”áŸ„áŸ‡á”á„áŸ‹', confirmButtonColor:'#d53f3f' });
  if(!result.isConfirmed) return;
  try{
    await fetch(`${SHEETDB_BASE_URL}/Email/${encodeURIComponent(email)}`,{ method:'DELETE' });
    // Delete face image via backend api
    await fetch(`${NODE_API_BASE}/api/delete-face`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ email })
    });
    showSwal('success','á”á¶á“á›á»á”',`á‚áá“á¸ ${email} ááŸ’ášá¼áœá”á¶á“á›á»á”áŸ”`);
    await loadUsers();
  }catch(err){ console.error(err); showSwal('error','á˜á¶á“á”á‰áŸ’á á¶',err.message||String(err)); }
}

/* Init */
loadUsers();

/* Clean up when leaving page */
window.addEventListener('beforeunload', ()=>{ stopStream(); });

</script>

</body>
</html>
